---
output:
  html_document: default

title: "Atlas of distant water fishing - Analysis"
author: "Matthew Warham, Kat Millage"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

# Introduction

This script pulls information on fishing effort from Global Fishing Watch for distant water fishing vessels. The top countries with distant water fishing fleets and the top EEZs with the most distant water fishing activity are then identified.  

```{r setup, include=FALSE}
# Chunk options
knitr::opts_chunk$set(echo = TRUE)

# Packages
#library(maps)
library(sf) # spatial manipulation
library(lwgeom) # needed for curved lines
library(here) # path names
library(knitr) # knit document
library(bigrquery) # access GFW data
library(DBI) # access GFW data
library(countrycode) # country names 
library(tidyverse) # data manipulation
library(ggalt) # transform to robinson projection
library(RColorBrewer) # custom color palettes
library(scales) # scales for plotting
library(ggpubr) # plot arranging
library(gridExtra)
library(grid)

# Set results directory
results_dir <- here::here("results/")
if (dir.exists(results_dir) == F) {
  dir.create(results_dir, recursive = T)
}
table_dir <- here::here("results", "summary_tables/")
if (dir.exists(table_dir) == F) {
  dir.create(table_dir, recursive = T)
}
country_dir <- here::here("results", "flag_state_results/")
if (dir.exists(country_dir) == F) {
  dir.create(country_dir, recursive = T)
}
eez_dir <- here::here("results", "EEZ_results/")
if (dir.exists(eez_dir) == F) {
  dir.create(eez_dir, recursive = T)
}

# Connection to BigQuery
ucsb_project <-  "ucsb-gfw"
#gfw_project <- "world-fishing-827"

# Do you want to pull fresh data from GFW?
rerun_gfw <- F

# Set benchmarks 
number_of_top_countries_flag <- 20
number_of_top_countries_eez <- 10

# Choose analysis year (2012 - 2018)
analysis_year <- 2018
```

# Data pull from Global Fishing Watch

This section describes the process of linking to the most recent version of the GFW data, and pulling information on all distant water fishing vessels represented in that dataset. This process was last performed on 5/23/2019.  

We first extract total fishing hours (and fishing days) by year and EEZ for each vessel in the dataset. EEZs are defined by a numeric code, each cooresponding to a region in the World EEZ data set from Marineregions.org. The responsible territory for each region has been identified, as well as the sovereign country (or countries for disputed regions). We then match the best vessel characteristics identified by GFW to each vessel, and remove entries for all vessels that GFW does not consider to be fishing vessels. 

In order to separate entries cooresponding to distant water fishing effort, we remove all entries for vessels fishing on the high seas, and all vessel/EEZ pairings where the the flag state of the vessel is the same as the EEZ state or sovereign. We also remove all entries for vessels fishing less than one hour in a given EEZ in a year. 

```{r}
if(rerun_gfw == T){

# Query to pull fishing effort by vessel, by EEZ
sql <- "
WITH
  eez_lookup AS (
    SELECT
      CAST(eez_id AS string) eez_code,
      eez_type,
      reporting_name eez_name,
      territory1 eez_territory,
      territory1_iso3 eez_territory_iso3,
      sovereign1 eez_sovereign,
      sovereign1_iso3 eez_sovereign_iso3,
      sovereign2 eez_sovereign2,
      sovereign2_iso3 eez_sovereign2_iso3,
      sovereign3 eez_sovereign3,
      sovereign3_iso3 eez_sovereign3_iso3
    FROM
      `world-fishing-827.gfw_research.eez_info`),
      
 fishing_info_by_eez AS (
    SELECT
      EXTRACT(year FROM _partitiontime) year,
      ssvid,
      if(ARRAY_LENGTH(regions.eez)=0, '0000', regions.eez[ordinal(1)]) eez_code,
      CASE WHEN COUNT(DISTINCT _partitiontime) IS NULL THEN 0 ELSE COUNT(DISTINCT _partitiontime) END fishing_days_year_eez,
      CASE WHEN SUM(hours) IS NULL THEN 0 ELSE SUM(hours) END fishing_hours_year_eez
    FROM
      `world-fishing-827.gfw_research.pipe_production_b_fishing`
    WHERE
      nnet_score2 > .5
      AND seg_id IN (
        SELECT
          seg_id
            FROM
              `world-fishing-827.gfw_research.pipe_production_b_segs`
            WHERE
              good_seg)
    GROUP BY
      year,
      ssvid,
      eez_code)
 
SELECT
  year,
  ssvid,
  best.best_flag flag,
  best.best_vessel_class vessel_class,
  best.best_length_m length_m,
  best.best_tonnage_gt tonnage_gt,
  best.best_engine_power_kw engine_power_kw,
  ais_identity.shipname_mostcommon.value broadcast_shipname,
  ais_identity.n_callsign_mostcommon.value broadcast_callsign,
  eez_code,
  eez_type,
  eez_name,
  if(eez_territory IS NULL, 'High Seas', eez_territory) eez_territory,
  if(eez_territory_iso3 IS NULL, 'High Seas', eez_territory_iso3) eez_territory_iso3,
  eez_sovereign, 
  eez_sovereign_iso3,
  eez_sovereign2,
  eez_sovereign2_iso3,
  eez_sovereign3,
  eez_sovereign3_iso3,
  fishing_hours_year_eez,
  fishing_days_year_eez
FROM
  fishing_info_by_eez
RIGHT JOIN
  `world-fishing-827.gfw_research.vi_ssvid_byyear_v20190430`
USING
  (year,
   ssvid)
LEFT JOIN
    eez_lookup
USING
    (eez_code)
WHERE 
  on_fishing_list_best
  AND activity.offsetting IS FALSE
ORDER BY
  year,
  eez_territory_iso3,
  eez_code,
  fishing_hours_year_eez DESC,
  ssvid"

# Store in bigquery - all_fishing_effort_by_eez (~700,000 rows - over 100MB)
bq_table(project = ucsb_project, table = "all_fishing_effort_by_eez", dataset = "subsidy_atlas") %>% 
  bq_table_delete()
bq_project_query(ucsb_project, sql, destination_table = bq_table(project = ucsb_project, table = "all_fishing_effort_by_eez",dataset = "subsidy_atlas"), use_legacy_sql = FALSE, allowLargeResults = TRUE)

# Let's exclude all entries where a vessel had less than 1 fishing hour in any eez in a given year, entries from the high seas, and entries where the flag of the vessel is the same as the eez, and 
sql2 <- "
SELECT
  *
FROM
  `ucsb-gfw.subsidy_atlas.all_fishing_effort_by_eez`
WHERE 
fishing_hours_year_eez > 1 
and eez_territory_iso3 != 'High Seas'
and flag != eez_territory_iso3
and flag != eez_sovereign_iso3"

# Store in bigquery - all_dw_fishing_effort_by_eez (~100,000 rows - ~25MB)
bq_table(project = ucsb_project, table = "all_dw_fishing_effort_by_eez", dataset = "subsidy_atlas") %>% 
  bq_table_delete()

# Download results
all_dw_fishing_effort_by_eez <- bq_project_query(ucsb_project, sql2, destination_table = bq_table(project = ucsb_project, table = "all_dw_fishing_effort_by_eez", dataset = "subsidy_atlas"), use_legacy_sql = FALSE, allowLargeResults = TRUE) %>%
  bq_table_download(max_results = Inf)

# Make fishing_KWh and fishing_KW_day variables
dw_effort <- all_dw_fishing_effort_by_eez %>%
  mutate(fishing_KWh = fishing_hours_year_eez*engine_power_kw,
         fishing_KW_days = fishing_days_year_eez*engine_power_kw)
dw_effort[dw_effort == "NA"] <- NA
dw_effort$flag[is.na(dw_effort$flag)] <- "UNK"

# Save file
write_csv(dw_effort, path = paste0(results_dir, "RAW_dw_effort_by_eez.csv"))

} else{
  
# Pull local stored copy of the data 
dw_effort <- read_csv(paste0(results_dir, "RAW_dw_effort_by_eez.csv"), col_types = "icccnnncccccccccccccninn")
  
}
```

# Naming of political entities

Based on comments recieved by the SFG team on other aspects of the subsidies project, our naming of flag states and EEZ states needs to be extremely deliberate. We therefore take the following approach to naming political entities. We use the `codelist` data frame from the `countrycode` package as a starting point to extract the ISO-3 character codes of each entity, as well as names in English from four sources: 1) the `countrycode` package, 2) the FAO, 3) the United Nations, and 4) the World Bank. 

For the purposes of our maps and figures, the display name of each politial entity is determined with the following heiarchy. If available, names from the World Bank are used. If no official name exists for an entitry from the World Bank, we instead use names from the FAO. If no official name exists for an entity from either the World Bank or the FAO, we instead use names from the broader United Nations.

```{r}
country_list <- codelist %>%
  dplyr::select(iso3c, country.name.en, fao.name, un.name.en, wb.name) %>%
  mutate(official_name = case_when(!is.na(wb.name) ~ wb.name,
                             !is.na(fao.name) ~ fao.name,
                             !is.na(un.name.en) ~ un.name.en,
                             TRUE ~ country.name.en)) %>%
  dplyr::filter(!is.na(iso3c))
```

We then assign these names to the flag states of vessels, as well as to the EEZ states and sovereigns in the GFW database by matching ISO-3 character codes of each entity. 

```{r}
# Sovereignty pairings from EEZs
sovereign_pairings <- dw_effort %>%
  distinct(eez_sovereign_iso3, eez_territory_iso3) %>%
  rename(flag_sovereign = eez_sovereign_iso3, flag = eez_territory_iso3) %>%
  dplyr::filter(flag_sovereign != "NA", flag != "NA") %>%
  na.omit() %>%
  arrange(flag)

# Custom sovereignty pairings that are missing
c_sovereign_pairings <- tibble(flag = c("BLZ", "ARM", "ROM", "AUT", "SRB", "CHE", "LIE", "UNK", "SVK", "MNG", "IRQ", "JOR", "HKG", "NER", "GCA", "BOL", "LSO", "HUN", "KHM", "AFG")) %>%
  left_join(country_list %>% dplyr::select(iso3c, official_name), by = c("flag" = "iso3c"))
c_sovereign_pairings$official_name[c_sovereign_pairings$flag == "ROM"] <- country_list$official_name[country_list$iso3c == "ROU"]
c_sovereign_pairings$official_name[c_sovereign_pairings$flag == "UNK"] <- "Unknown"
c_sovereign_pairings$official_name[c_sovereign_pairings$flag == "GCA"] <- country_list$official_name[country_list$iso3c == "GTM"]

c_sovereign_pairings <- c_sovereign_pairings %>%
  mutate(flag_sovereign = flag) 
c_sovereign_pairings$flag_sovereign[c_sovereign_pairings$flag_sovereign == "HKG"] <- "CHN"

# Put them all back together
sovereign_pairings_all <- sovereign_pairings %>%
  bind_rows(c_sovereign_pairings %>% dplyr::select(flag_sovereign, flag))

# Add sovereign state to each vessel
dw_effort <- dw_effort %>%
  left_join(sovereign_pairings_all, by = c("flag" = "flag"))

# Rename flag states
dw_effort_renamed <- dw_effort %>%
  left_join(country_list %>% dplyr::select(iso3c, official_name), by = c("flag" = "iso3c")) %>%
  rename(flag_name = official_name)

# Rename EEZ names 
dw_effort_renamed <- dw_effort_renamed %>%
  left_join(country_list %>% dplyr::select(iso3c, official_name), by = c("eez_territory_iso3" = "iso3c")) %>%
  rename(eez_territory_name = official_name) %>%
  dplyr::select(-eez_territory)

dw_effort_renamed$eez_territory_name[dw_effort_renamed$eez_territory_iso3 == "ASC"] <- country_list$official_name[country_list$iso3c == "SHN"]
dw_effort_renamed$eez_territory_name[dw_effort_renamed$eez_territory_iso3 == "TAA"] <- country_list$official_name[country_list$iso3c == "SHN"]

# Rename EEZ sovereign names
dw_effort_renamed <- dw_effort_renamed %>%
  left_join(country_list %>% dplyr::select(iso3c, official_name), by = c("eez_sovereign_iso3" = "iso3c")) %>%
  rename(eez_sovereign_name = official_name) %>%
  dplyr::select(-eez_sovereign)
dw_effort_renamed$eez_sovereign_iso3[dw_effort_renamed$eez_sovereign_iso3 == "TWN"] <- "CHN" # Check on this - what's the most politically sensitive way of doing this... 

# Rename EEZ sovereign2 names
dw_effort_renamed <- dw_effort_renamed %>%
  left_join(country_list %>% dplyr::select(iso3c, official_name), by = c("eez_sovereign2_iso3" = "iso3c")) %>%
  rename(eez_sovereign2_name = official_name) %>%
  dplyr::select(-eez_sovereign2)

dw_effort_renamed$eez_sovereign2_iso3[dw_effort_renamed$eez_sovereign2_name == "Comores"] <- "COM"

# Rename EEZ sovereign3 names
dw_effort_renamed <- dw_effort_renamed %>%
  left_join(country_list %>% dplyr::select(iso3c, official_name), by = c("eez_sovereign3_iso3" = "iso3c")) %>%
  rename(eez_sovereign3_name = official_name) %>%
  dplyr::select(-eez_sovereign3)

# Rematch flag states with eez states/sovereigns 
dw_effort_cleaned <- dw_effort_renamed %>%
  dplyr::filter(flag != eez_territory_iso3) %>%
  dplyr::filter(flag != eez_sovereign_iso3 | flag != eez_sovereign2_iso3 | flag != eez_sovereign3_iso3)

#write_csv(dw_effort_cleaned, path = paste0(results_dir, "clean_dw_fishing_effort_by_eez.csv"))

```

# European Union vessels

Vessels flagged to EU member states have the right to fish in the EEZs of other EU member states, therefore we do not include these instances as "distant water fishing". In order to remove these from our dataset, we first need create a list of EU member states (including remote regions), as well as non-member states with with the EU has fishing agreements (i.e. Norway and Iceland). 

We define "intra-EU fishing" as fishing activity that meets one of the following criteria: 
1. The flag state of the vessel is a member state of the EU (or Norway, Svalbard and Jan Mayen, and Iceland) and the EEZ in which it is fishing belongs to a member state of the EU (or Norway, Svalbard and Jan Mayen, and Iceland);
2. The sovereign flag state of the vessel is a member state of the EU (or Norway, Svalbard and Jan Mayen, and Iceland) and the EEZ in which it is fishing belongs to a member state of the EU (or Norway, Svalbard and Jan Mayen, and Iceland)

We do not consider the following to be "intra-EU fishing" (see below for "sovereign fishing"): 
1. The flag state of the vessel is a member state of the EU (or Norway, Svalbard and Jan Mayen, and Iceland) and the EEZ in which it is fishing belongs to a territory or distant region of the EU. 

```{r}
# EU member states
# Austria, Belgium, Bulgaria, Croatia, Cyprus, Czechia, Denmark, Estonia, Finland, France, Germany, Greece, Hungary, Ireland, Italy, Latvia, Lithuania, Luxembourg, Malta, Netherlands, Poland, Portugal, Romania, Slovakia, Slovenia, Spain, Sweden, United Kingdom
eu_states <- c("AUT", "BEL", "BGR", "HRV", "CYP", "CZE", "DNK", "EST", "FIN", "FRA", "DEU", "GRC", "HUN", "IRL", "ITA", "LVA", "LTU", "LUX", "MLT", "NLD", "POL", "PRT", "ROU", "SVK", "SVN", "ESP", "SWE", "GBR")

# EU remote regions
# Wallis and Futuna, French Guiana, Sint Maarten (Dutch part), Saint Pierre and Miquelon, Saint Martin (French part), Mayotte, Saint Barthelemy, Reunion, Curaçao, Aruba, British Indian Ocean Territory, Bonaire, Saint Eustatius and Saba, Guadeloupe, Martinique, Saint Helena, Ascension and Tristan da Cunha, Ascension Island, South Georgia and the South Sandwich Islands, French Southern Territories, Tristan da Cunha, Falkland Islands (Malvinas), Bermuda, Turks and Caicos Islands, Cayman Islands, Virgin Islands, British, Anguilla, Montserrat, Pitcairn, French Polynesia
# eu_distant_states <- c('WLF', 'GUF', 'SXM', 'SPM', 'MAF', 'MYT', 'BLM', 'REU', 'CUW', 'ABW', 'IOT', 'BES', 'GLP', 'MTQ', 'SHN', 'ASC', 'SGS', 'ATF', 'TAA', 'FLK', 'BMU', 'TCA','CYM', 'VGB','AIA', 'MSR', 'PCN', 'PYF')

# States with which the EU has free fishing agreements 
# Norway, Svalbard and Jan Mayen, Iceland
eu_northern_agreement <- c("NOR", "SJM", "ISL")

# Identify flag/eez pairings which we're excluding from "distant water" because of the EU relationship between nations
dw_effort_findEU <- dw_effort_cleaned %>%
  mutate(is_EU = ifelse(flag %in% c(eu_states, eu_northern_agreement) & eez_territory_iso3 %in% c(eu_states, eu_northern_agreement)|
                      flag_sovereign %in% c(eu_states, eu_northern_agreement) & eez_territory_iso3 %in% c(eu_states, eu_northern_agreement), TRUE, FALSE))

```
 
# Sovereignty issues

If the sovereign flag state of a vessel is the same as the sovereign state of the EEZ in which it's fishing, this connection may still be considered to be distant water fishing (e.g. US vessel fishing in Palmyra Atoll), though this is generally not considered to be foreign distant water fishing. Let's add a field identifying effort in which this is the case. 

We descibe "sovereign fishing" as fishing activity that meets one of the following criteria: 
1. The sovereign flag state of the vessel is the same as the sovereign state of the EEZ in which it is fishing;
2. The flag state of the vessel is the same as the sovereign state of the EEZ in which it is fishing.

```{r}
dw_effort_findsovereign <- dw_effort_findEU %>%
  mutate(is_sovereign = case_when(flag_sovereign != eez_sovereign_iso3 &  
                                  flag != eez_sovereign_iso3 ~ FALSE,
                                  TRUE ~ TRUE))
```

<!-- There are some cases in which there may be connections that are not foreign and that because of their particular situation should not be considered distant water. An example of this are disputed and joint regime EEZ.  These are listed and removed here: -->

```{r}
# sovereign_connections <- dw_effort_findsovereign %>% 
#   filter(is_sovereign) %>% 
#   distinct(flag, flag_sovereign, eez_code, eez_type, eez_territory_name , eez_territory_iso3, eez_sovereign_name, eez_sovereign_iso3, eez_sovereign2_name, eez_sovereign2_iso3, eez_sovereign3_name, eez_sovereign3_iso3) %>% 
#   arrange(desc(flag_sovereign))
# 
# # sovereign_not_distant_water_connections <- sovereign_connections %>% 
# #   filter(!(flag_sovereign == "United States" & eez_type == "200NM")) %>% 
# #   filter(!(flag_sovereign == "United Kingdom" & eez_territory_name == "Falkland Islands")) %>% 
# #   filter(!(flag_sovereign == "United Kingdom" & eez_territory_name == "South Georgia and the South Sandwich Islands")) %>% 
# #   filter(!(flag_sovereign == "United Kingdom" & eez_territory_name == "Tristan da Cunha")) %>% 
# #   filter(!(flag_sovereign == "New Zealand")) %>% 
# #   filter(!(flag_sovereign == "France")) %>% 
# #   filter(!(flag_sovereign == "Australia"))
```

# Distant water fishing

For the purposes of this analysis, we define distant water fishing in the following way. We exclude all "intra-EU fishing", but include "sovereign fishing". All DW fishing that is not "sovereign fishing" is foreign DW fishing. 

```{r}
# And finally get all DW effort
dw_effort_final <- dw_effort_findsovereign %>%
  dplyr::filter(!is_EU)

write_csv(dw_effort_final, paste0(results_dir, "FINAL_dw_effort_by_eez.csv"))
```

```{r}
# Now we need to get subsidy rates per fishing KWh for our DW vessels
# Since Rashid has not provided a DW and/or large-scale breakdown of his subsidy estimates, we need to figure out how to do this.
subsidy_dat <- read_csv(here::here("data", "subsidies", "Subsidies_update_Pew_final_May_10.csv")) %>%
  setNames(tolower(names(.))) %>%
  rename(value = `constant 2018 usd`,
         estimate_type = `data type`) %>%
  mutate(iso3 = countrycode(country, "country.name", 'iso3c'))
subsidy_dat$iso3[subsidy_dat$country == "Dominican Rp"] <- "DOM"
subsidy_dat$iso3[subsidy_dat$country == "Micronesia"] <- "FSM"
subsidy_dat$iso3[subsidy_dat$country == "Untd Arab Em"] <- "ARE"

# Order factors for custom color scale
subsidy_dat_factors <- subsidy_dat %>%
  distinct(category, type)

category_factor_order <- c(unique(subsidy_dat_factors$category))
type_factor_order <- c(subsidy_dat_factors$type)

subsidy_dat_ordered <- subsidy_dat %>%
  mutate(type = factor(type, levels = type_factor_order, ordered = T),
         category = factor(category, levels = category_factor_order, ordered = T))

  # Get sums of subsidy data by category for each country
subsidy_dat_summarized <- subsidy_dat_ordered %>%
  group_by(iso3, category) %>%
  summarize(value = sum(value, na.rm = T))

# Calculate effort totals by flag and then subsidy rates
dw_subsidy_rates_flag <- dw_effort_final %>%
  dplyr::filter(year == analysis_year) %>%
  group_by(flag) %>%
  summarize(fishing_hours = sum(fishing_hours_year_eez, na.rm = T),
            fishing_days = sum(fishing_days_year_eez, na.rm = T),
            fishing_KWh = sum(fishing_KWh, na.rm = T),
            fishing_KW_days = sum(fishing_KW_days, na.rm = T)) %>%
  left_join(subsidy_dat_summarized %>% dplyr::filter(category == "Capacity-enhancing"), by = c("flag" = "iso3")) %>%
  mutate(subs_per_fishing_hour = value/fishing_hours,
         subs_per_fishing_day = value/fishing_days,
         subs_per_fishing_KWh = value/fishing_KWh,
         subs_per_fishing_KW_day = value/fishing_KW_days)
dw_subsidy_rates_flag$category[is.na(dw_subsidy_rates_flag$category)] <- "Capacity-enhancing"
dw_subsidy_rates_flag$value[is.na(dw_subsidy_rates_flag$value)] <- 0
dw_subsidy_rates_flag$subs_per_fishing_hour[is.na(dw_subsidy_rates_flag$subs_per_fishing_hour)] <- 0
dw_subsidy_rates_flag$subs_per_fishing_KWh[is.na(dw_subsidy_rates_flag$subs_per_fishing_KWh)] <- 0
dw_subsidy_rates_flag$subs_per_fishing_day[is.na(dw_subsidy_rates_flag$subs_per_fishing_day)] <- 0
dw_subsidy_rates_flag$subs_per_fishing_KW_day[is.na(dw_subsidy_rates_flag$subs_per_fishing_KW_day)] <- 0

# # Upload to BQ
# if(rerun_gfw == TRUE){
#   
# subsidy_table <- bq_table(project = ucsb_project, table = "subsidy_rates_flag", dataset = "subsidy_atlas")
# 
#   if(bq_table_exists(subsidy_table) == FALSE){
#     
#     bq_table(project = ucsb_project, table = "subsidy_rates_flag", dataset = "subsidy_atlas") %>%
#       bq_table_create() %>%
#       bq_table_upload(dw_subsidy_rates_flag)
#     
#   }else{
#     
#     bq_table(project = ucsb_project, table = "subsidy_rates_flag", dataset = "subsidy_atlas") %>%
#       bq_table_delete() %>%
#       bq_table_upload(dw_subsidy_rates_flag)
#     
#   }
# 
# }

```


# Identify top DW fishing fleets by flag state

We identify the top `r number_of_top_countries_flag` flag states with DW fishing fleets. We consider the following metrics:
- Number of fishing vessels partaking in DW fishing
- Total capacity of fishing vessels partaking of DW fishing
- Total number of DW fishing hours
- Total number of DW fishing KWh 

```{r cars}
# Mutate totals by flag state
flag_state_ranking <- dw_effort_final %>% 
  dplyr::filter(year == analysis_year) %>%
  group_by(flag, ssvid) %>%
  summarize(engine_power_kw = unique(engine_power_kw),
            fishing_hours = sum(fishing_hours_year_eez, na.rm = T),
            fishing_KWh = sum(fishing_KWh, na.rm = T)) %>%
  ungroup() %>%
  group_by(flag) %>%
  summarize(total_vessels = n_distinct(ssvid),
            total_capacity = sum(engine_power_kw, na.rm = T),
            total_fishing_hours = sum(fishing_hours, na.rm = T),
            total_fishing_KWh = sum(fishing_KWh, na.rm = T)) %>% 
  arrange(desc(total_vessels)) %>%
  ungroup() %>%
  mutate(vessel_rank = dense_rank(desc(total_vessels)),
         capacity_rank = dense_rank(desc(total_capacity)),
         fishing_hours_rank = dense_rank(desc(total_fishing_hours)),
         fishing_KWh_rank = dense_rank(desc(total_fishing_KWh))) %>%
  mutate(avg_rank = rowMeans(select(., c(vessel_rank, capacity_rank, fishing_hours_rank, fishing_KWh_rank))))

# Identify top flag states based on average ranking
flag_state_ranking_top <- flag_state_ranking %>%
 top_n(-number_of_top_countries_flag, wt = avg_rank)

write_csv(flag_state_ranking_top, paste0(table_dir, "top_", number_of_top_countries_flag, "_flag_states_avg_", analysis_year, ".csv"))

# Just in case - let's make top lists for each category as well
# Vessels
write_csv(flag_state_ranking %>%
            top_n(-number_of_top_countries_flag, wt = vessel_rank), 
          paste0(table_dir, "top_", number_of_top_countries_flag, "_flag_states_vessels_", analysis_year, ".csv"))

# Total capacity
write_csv(flag_state_ranking %>%
            top_n(-number_of_top_countries_flag, wt = capacity_rank), 
          paste0(table_dir, "top_", number_of_top_countries_flag, "_flag_states_capacity_", analysis_year, ".csv"))

# Fishing hours
write_csv(flag_state_ranking %>%
            top_n(-number_of_top_countries_flag, wt = fishing_hours_rank), 
          paste0(table_dir, "top_", number_of_top_countries_flag, "_flag_states_fishing_hours_", analysis_year, ".csv"))

# Fishing KWh
write_csv(flag_state_ranking %>%
            top_n(-number_of_top_countries_flag, wt = fishing_KWh_rank), 
          paste0(table_dir, "top_", number_of_top_countries_flag, "_flag_states_fishing_KWh_", analysis_year, ".csv"))

```

For each of our top flag states, we identify all EEZs in which DW vessels flagged to that state fish. 

```{r}
top_flag_states <- flag_state_ranking_top$flag
top_flag_states_names <- (flag_state_ranking_top %>%
  left_join(country_list %>% dplyr::select(iso3c, official_name), by = c("flag" = "iso3c")) %>%
  dplyr::select(official_name) %>%
  distinct())$official_name

flag_state_combinations <- dw_effort_final %>%
  dplyr::filter(flag %in% top_flag_states) %>%
  distinct(flag, eez_code = as.numeric(eez_code)) %>%
  arrange(flag)
```

In order to make our connection plots, we find the centroids of each EEZ and flag state. 

```{r}
# Get centroids of each eez
EEZ_map <- read_sf(dsn = here::here("data", "shapefiles", "eez_v10_fao_combined_simple"), layer = "eez_v10_fao_combined_simple") %>% 
  st_transform(crs = 4326) #%>% 
  #st_transform(flag_state_mapping, crs = '+proj=robin +lon_0=180 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs')

EEZ_map_centroids <- EEZ_map %>%
  dplyr::filter(is.na(zone)) %>%
  st_centroid() %>%
  dplyr::select(eez_code = mrgid, eez_name = geoname, geometry)

centroid_coordinates_EEZ <- tibble(eez_code = EEZ_map_centroids$eez_code,
                                   eez_name = EEZ_map_centroids$eez_name) %>% 
  bind_cols(do.call(rbind, st_geometry(EEZ_map_centroids)) %>% 
    as_tibble() %>% setNames(c("eez_lon","eez_lat"))) %>%
  arrange(eez_code)

# Get centroids of each flag state
country_map <- read_sf(dsn = here::here("data", "shapefiles", "world_happy_180"), layer = "world_happy_180") %>%  
  st_transform(crs = 4326) #%>% 
  #st_transform(flag_state_mapping, crs = '+proj=robin +lon_0=180 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs')

country_map_centroids <- country_map %>%
  st_centroid() %>%
  dplyr::select(iso3, geometry)

centroid_coordinates_flag <- tibble(flag = country_map$iso3) %>% 
  bind_cols(do.call(rbind, st_geometry(country_map_centroids)) %>% 
    as_tibble() %>% setNames(c("flag_lon","flag_lat"))) %>%
  arrange(flag)

# Matt - add in a manual .csv with centroid corrections for both flags and eezs
# name the new lat/lon "flag_lon_edit", "flag_lat_edit"
# centroid_coordinates_flag_edited <- centroid_coordinates_flag %>%
#   left_join(manual_coordinates, by = c("flag")) %>%
#   mutate(flag_lon = ifelse(!is.na(flag_lon_edit), flag_long_edit, flag_lon))

# Do the same for EEZs

```

We then match these centroids to each of our top flag states, as well as all EEZs in which DW vessels from these states fish. 

```{r}
flag_state_mapping <- flag_state_combinations %>%
  left_join(centroid_coordinates_flag, by = c("flag" = "flag")) %>%
  left_join(centroid_coordinates_EEZ, by = c("eez_code" = "eez_code"))
  
flag_state_mapping_wlines <- flag_state_mapping %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>% 
  bind_cols(flag_state_mapping) %>%
  select(everything(), geometry) %>% 
  st_segmentize(units::set_units(100,km)) %>% 
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326) #%>% 
  #st_transform(flag_state_mapping, crs = '+proj=robin +lon_0=180 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs')

```

```{r flagmaps}
# Custom theme for map
maptheme <- theme_minimal()+
  theme(panel.background = element_rect(fill = "grey27", colour = NA),
        panel.grid.major = element_line(colour = "grey27"),
        panel.border = element_blank(),
        plot.margin = unit(c(0,0,0,0),"mm"),
        plot.background = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks.length = unit(0, "pt"))

# Custom color palette for Sumaila subsidy types
goodColors <- rev(brewer.pal(3,"Blues"))
names(goodColors) <- levels(subsidy_dat_ordered$type)[1:3]

badColors <- rev(brewer.pal(7, "Reds"))
names(badColors) <- levels(subsidy_dat_ordered$type)[4:10]

ambigColors <- c("purple", "mediumorchid", "violet")
names(ambigColors) <- levels(subsidy_dat_ordered$type)[11:13]

myColors <- c(goodColors, badColors, ambigColors)

## For loop to run top X countries
 for(i in 1:length(top_flag_states)){

### Step 1: Flag state connectivity data
# Pull connectivity data for only our flag state of interest
flag_dat <- flag_state_mapping_wlines %>%
  dplyr::filter(flag == top_flag_states[i]) 

# Write flag state connectivity data
write_csv(flag_dat, path = paste0(country_dir, top_flag_states[i], "_flag_state_dat.csv"))

### Step 2: Make connectivity map
# Map
map_plot <- ggplot()+
  geom_sf(data = EEZ_map %>% dplyr::filter(is.na(zone)), fill = NA, color = "grey60", size = 0.1)+ # world EEZs (transparent, light grey border lines)
  geom_sf(data = country_map, fill = "grey2", color = "grey40", size = 0.1)+ # world countries (dark grey, white border lines)
  geom_sf(data = country_map %>% dplyr::filter(iso3 == top_flag_states[i]), fill = "darkmagenta", color = NA, size = 0.1) + # highlighted flag state (magenta, white border lines)
  geom_sf(data = EEZ_map %>% dplyr::filter(iso_tr1 == top_flag_states[i]), fill = NA, alpha = 0.5, color = NA, size = 0.1) +
  geom_sf(data = EEZ_map %>% dplyr::filter(mrgid %in% flag_dat$eez_code), fill = "slateblue", alpha = 0.5, color = NA, size = 0.1) + # highlighted EEZs (slate blue)
  geom_sf(data = flag_dat, col = "darkgoldenrod", size = 0.25) + 
  maptheme+
  coord_sf(xlim = c(-180,180), ylim = c(-90,90))+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))

# Save map
ggsave(map_plot, filename = paste0(country_dir, top_flag_states[i], "_flag_state_map.png"), width = 10, units = "in")

# Combine map into a one page pdf
general_title <- textGrob(paste0("Global network of distant-water fishing"), gp = gpar(fontsize=16, fontface="bold", lineheight=1, col = "white", fontfamily = "Helvetica"), hjust = 0.5, vjust = 0.9)

flag_title <- textGrob(paste0("Flag State: ", top_flag_states_names[i]), gp = gpar(fontsize=16, lineheight=1, col = "white", fontfamily = "Helvetica"), hjust = 0.5, vjust = 0.1)

map_text <- textGrob(paste0("This map shows the global range of distant-water fishing effort for vessels flagged to ", top_flag_states_names[i], ". Lines connect the flag state (pink) \nwith all foreign EEZs (blue) in which vessels flagged to that state fished in 2018. Data were taken from Global Fishing Watch (2018)."), gp = gpar(fontsize = 10, col = "white", fontfamily = "Helvetica"), vjust = 0, hjust = 0.5)

lay1 <- rbind(c(1),
              c(2),
              c(3),
              c(3),
              c(4))

# Put together connectivity map
map_page <- grid.arrange(general_title, map_title, map_plot, map_text, 
                         layout_matrix = lay1,
                         heights=unit(c(0.5,0.5,1.5,5,1), c("in")), 
                         widths=unit(11, "in"))
out1 <- cowplot::ggdraw(map_page) + 
  theme(plot.background = element_rect(fill="grey27", color = NA))

# Save connectivity map
ggsave(out1, filename = paste0(country_dir, top_flag_states[i], "_map_page.pdf"), width = 11, height = 8.5, units = "in")

### Step 3: Make fisheries subsidies summary plot(s) 
# Subsidies by subtype plot
flag_subsidy_dat <- subsidy_dat_ordered %>%
  dplyr::filter(iso3 == top_flag_states[i]) %>%
  na.omit()

if(nrow(flag_subsidy_dat) > 0){
  
  # Filter color scale to only use those for subsidy types represented by that country
  filtered_colors <- myColors[names(myColors) %in% unique(flag_subsidy_dat$type)]
  
  # Make plot
  subsidy_plot <- ggplot(flag_subsidy_dat, aes(x = category, y = value/1e6, fill = type))+
    geom_bar(stat = "identity")+
    scale_fill_manual(name = "Subsidy Type", values = filtered_colors, labels = unique(flag_subsidy_dat$type))+
    theme_bw()+
    coord_flip()+
    scale_y_continuous(expand = c(0,0), labels = scales::comma)+
    labs(x = "", y = "Est. fisheries subsidies (2018 $USD, millions)")
  
  # Save plot
  ggsave(subsidy_plot, filename = paste0(country_dir, top_flag_states[i], "_subsidy_plot.png"), width = 10, height = 6, units = "in")
  
  
  # Make one page pdf of subsidy/other statistics
  general_title2 <- textGrob(paste0("Global network of distant-water fishing"), gp = gpar(fontsize=16, fontface="bold", lineheight=1, col = "black", fontfamily = "Helvetica"), hjust = 0.5, vjust = 0.9)
  
  flag_title2 <- textGrob(paste0("Flag State: ", top_flag_states_names[i]), gp = gpar(fontsize=16, lineheight=1, col = "black", fontfamily = "Helvetica"), hjust = 0.5, vjust = 0.1)
  
  dw_summary <- textGrob(
    paste0("Number of distant-water vessels: ", format(flag_state_ranking_top$total_vessels[i], big.mark = ","), 
           "  |  Rank: ", flag_state_ranking_top$vessel_rank[i],
           "\nNumber of EEZs fished: ", length(unique(flag_dat$eez_code)), 
           "  |  Rank: ", flag_state_ranking_top$vessel_rank[i],
           "\nTotal distant-water capacity (KW): ", format(round(flag_state_ranking_top$total_capacity[i]), big.mark = ","),
           "  |  Rank: ", flag_state_ranking_top$capacity_rank[i],
           "\nTotal distant-water fishing effort (hours): ", format(round(flag_state_ranking_top$total_fishing_hours[i]), big.mark = ","),
           "  |  Rank: ", flag_state_ranking_top$fishing_hours_rank[i],
           "\nTotal distant-water fishing effort (KWh): ", format(round(flag_state_ranking_top$total_fishing_KWh), big.mark = ","),
           "  |  Rank: ", flag_state_ranking_top$fishing_KWh_rank[i]), just = "left", x = unit(0.14, "npc")
  )

  subsidy_text <- textGrob(paste0("This figure shows fisheries subsides provided by ", top_flag_states_names[i], " in 2018 $USD. Subsidies are grouped into three types: neutral (purples), capacity-enhancing (reds), and beneficial (blues) \nbased on their generalized effects. Data are updated estimates from those in Sumaila et al. (2016)."), gp = gpar(fontsize = 10, col = "black", fontfamily = "Helvetica"), vjust = 0, hjust = 0.5)

  # Layout matrix
  lay <- rbind(c(1),
               c(2),
               c(3),
               c(4),
               c(5))
  
  # Create info/summary page
info_page <- grid.arrange(general_title2, flag_title2, dw_summary, subsidy_plot, subsidy_text, 
                          layout_matrix = lay, 
                          heights = unit(c(0.5,0.5,1.5,5,1), "in"), 
                          widths = unit(c(11), "in"))

out2 <- cowplot::ggdraw(info_page) +
  theme(plot.background = element_rect(fill="white", color = NA))

# Save summary page
ggsave(out2, filename = paste0(country_dir, top_flag_states[i], "_info_page.pdf"), width = 11, height = 8.5, units = "in")
  

# Save both plots into one pdf
  out3 <- marrangeGrob(grobs = list(test, test2), nrow = 1, ncol = 1, top = NULL)
  ggsave(out3, filename = paste0(country_dir, top_flag_states[i], "_combined.pdf"), width = 11, height = 8.5, units = "in")
}

}

```

# Identify top DW fishing fleets by EEZ

We identify the top `r number_of_top_countries_eez` EEZs in which DW fleets fish. We consider the following metrics:
- Number of fishing vessels partaking in DW fishing
- Total number of DW fishing hours
- Total number of DW fishing KWh

```{r}
# Mutate totals by EEZ
EEZ_ranking <- dw_effort_final %>% 
  dplyr::filter(year == analysis_year) %>%
  group_by(eez_code, eez_name, eez_territory_iso3, eez_sovereign_iso3, ssvid) %>%
  summarize(engine_power_kw = unique(engine_power_kw),
            fishing_hours = sum(fishing_hours_year_eez, na.rm = T),
            fishing_KWh = sum(fishing_KWh, na.rm = T)) %>%
  ungroup() %>%
  group_by(eez_code, eez_name, eez_territory_iso3, eez_sovereign_iso3) %>%
  summarize(total_vessels = n_distinct(ssvid),
            total_capacity = sum(engine_power_kw, na.rm = T),
            total_fishing_hours = sum(fishing_hours, na.rm = T),
            total_fishing_KWh = sum(fishing_KWh, na.rm = T)) %>% 
  arrange(desc(total_vessels)) %>%
  ungroup() %>%
  mutate(vessel_rank = dense_rank(desc(total_vessels)),
         capacity_rank = dense_rank(desc(total_capacity)),
         fishing_hours_rank = dense_rank(desc(total_fishing_hours)),
         fishing_KWh_rank = dense_rank(desc(total_fishing_KWh))) %>%
  mutate(avg_rank = rowMeans(select(., c(vessel_rank, capacity_rank, fishing_hours_rank, fishing_KWh_rank))))

# Identify top flag states based on average ranking
EEZ_ranking_top <- EEZ_ranking %>%
 top_n(-number_of_top_countries_eez, wt = avg_rank)

write_csv(EEZ_ranking_top, paste0(table_dir, "top_", number_of_top_countries_eez, "_EEZs_avg_", analysis_year, ".csv"))

# Just in case - let's make top lists for each category as well
# Vessels
write_csv(EEZ_ranking %>%
            top_n(-number_of_top_countries_eez, wt = vessel_rank), 
          paste0(table_dir, "top_", number_of_top_countries_eez, "_EEZs_vessels_", analysis_year, ".csv"))

# Total capacity
write_csv(EEZ_ranking %>%
            top_n(-number_of_top_countries_eez, wt = capacity_rank), 
          paste0(table_dir, "top_", number_of_top_countries_eez, "_EEZs_capacity_", analysis_year, ".csv"))

# Fishing hours
write_csv(EEZ_ranking %>%
            top_n(-number_of_top_countries_eez, wt = fishing_hours_rank), 
          paste0(table_dir, "top_", number_of_top_countries_eez, "_EEZs_fishing_hours_", analysis_year, ".csv"))

# Fishing KWh
write_csv(EEZ_ranking %>%
            top_n(-number_of_top_countries_eez, wt = fishing_KWh_rank), 
          paste0(table_dir, "top_", number_of_top_countries_eez, "_EEZs_fishing_KWh_", analysis_year, ".csv"))

```


```{r}
top_eezs <- EEZ_ranking_top$eez_code
top_eez_names <- EEZ_ranking_top$eez_territory_iso3
top_eez_names_long <- EEZ_ranking_top$eez_name

eez_combinations <- dw_effort_final %>%
  dplyr::filter(eez_code %in% top_eezs) %>%
  distinct(eez_code = as.numeric(eez_code), eez_territory_iso3, flag) %>%
  arrange(eez_code)
```

In order to make our connection plots, we again need the centroids of each EEZ and flag state, which we match to each of our top EEZs, as well as to all flag states from which vessels are fishing in each EEZ.

```{r}
eez_mapping <- eez_combinations %>%
  left_join(centroid_coordinates_EEZ, by = c("eez_code" = "eez_code")) %>%
  left_join(centroid_coordinates_flag, by = c("flag" = "flag")) 

# There are some flag states for which we need to manually assign centroids (mostly small island states not included in the world map because they don't show up)
# Tuvalu (TUV)
eez_mapping$flag_lon[eez_mapping$flag == "TUV"] <- centroid_coordinates_EEZ$eez_lon[centroid_coordinates_EEZ$eez_code == 8326]
eez_mapping$flag_lat[eez_mapping$flag == "TUV"] <- centroid_coordinates_EEZ$eez_lat[centroid_coordinates_EEZ$eez_code == 8326]

# Réunion (REU)
eez_mapping$flag_lon[eez_mapping$flag == "REU"] <- centroid_coordinates_EEZ$eez_lon[centroid_coordinates_EEZ$eez_code == 8338]
eez_mapping$flag_lat[eez_mapping$flag == "REU"] <- centroid_coordinates_EEZ$eez_lat[centroid_coordinates_EEZ$eez_code == 8338]

# Bonaire, Sint Eustatius and Saba (BES)
eez_mapping$flag_lon[eez_mapping$flag == "BES"] <- centroid_coordinates_EEZ$eez_lon[centroid_coordinates_EEZ$eez_code == 26520]
eez_mapping$flag_lat[eez_mapping$flag == "BES"] <- centroid_coordinates_EEZ$eez_lat[centroid_coordinates_EEZ$eez_code == 26520]

# Guatemala - old code (GCA)
eez_mapping$flag_lon[eez_mapping$flag == "GCA"] <- centroid_coordinates_flag$flag_lon[centroid_coordinates_flag$flag == "GTM"]
eez_mapping$flag_lat[eez_mapping$flag == "GCA"] <- centroid_coordinates_flag$flag_lat[centroid_coordinates_flag$flag == "GTM"]

```


```{r}
# We then make our lines from each EEZ going to all of the countries fishing there. 
eez_mapping_wlines <- eez_mapping %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>% 
  bind_cols(eez_mapping) %>%
  select(everything(), geometry) %>% 
  st_segmentize(units::set_units(100,km)) %>% 
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326) #%>% 
  #st_transform(flag_state_mapping, crs = '+proj=robin +lon_0=180 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs')

```

```{r}

## For loop to run top EEZs
for(i in 1:length(top_eezs)){

# comment this out when loop runs - Solomon islands
#i <- 6

eez_dat <- eez_mapping_wlines %>%
  dplyr::filter(eez_code == top_eezs[i]) 

# Write EEZ data
write_csv(eez_dat, path = paste0(eez_dir, top_eezs[i], "_", top_eez_names[i] , "_EEZ_dat.csv"))

# Make EEZ connection plot
eez_map <- ggplot()+
  geom_sf(data = EEZ_map %>% dplyr::filter(is.na(zone)), fill = NA, color = "grey60", size = 0.1)+ # world EEZs (transparent, light grey border lines)
  geom_sf(data = country_map, fill = "grey2", color = "grey40", size = 0.1)+ # world countries (dark grey, white border lines)
  geom_sf(data = country_map %>% dplyr::filter(iso3 %in% eez_dat$flag), fill = "darkmagenta", color = NA) + # highlighted flag state (magenta, white border lines)
  # geom_sf(data = EEZ_map %>% dplyr::filter(iso_tr1 %in% eez_dat$flag), fill = "darkmagenta", alpha = 0.5, color = NA) +
  geom_sf(data = EEZ_map %>% dplyr::filter(mrgid == top_eezs[i]), fill = "slateblue", alpha = 0.5, color = NA, size = 0.1) + # highlighted EEZs (slate blue)
  geom_sf(data = eez_dat, col = "darkgoldenrod", size = 0.25) + 
  maptheme

#plot_map <- plot_map + coord_sf("+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs")

#plot_map
ggsave(eez_map, filename = paste0(eez_dir, top_eezs[i], "_", top_eez_names[i], "_EEZ_connectivity_map.png"), width = 10, units = "in")

}
```

Now we need to pull raw, aggregated GFW data for each EEZ on our list and combine this with our subsidy data in order to map subsidy intensity in each EEZ

```{r}
# Custom theme for the eez heat maps
eezmaptheme <- theme_minimal()+
  theme(plot.background = element_rect(fill = "grey27", color = NA),
        panel.background = element_rect(fill = "grey27", color = NA),
        panel.grid.major = element_line(colour = "grey27"),
        text = element_text(color = "white"),
        plot.title = element_text(hjust = 0.5),
        panel.border = element_rect(color = "white", fill = NA),
        plot.margin = margin(t = 0, r = 0.1, b = 0, l = 0, unit = "cm"),
        legend.margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm"),
        legend.position = "bottom",
        legend.box = "horizontal",
        axis.text = element_text(color = "white"))

# Run loop to make heat maps
for(i in 1:length(top_eezs)){

  if(rerun_gfw == T){
    # What bin size do we want to use (degrees)?  
    bin_size <- 0.1

sql3 <- paste0(
  "WITH
  selected_vi AS (
    SELECT
       year,
       ssvid,
       best.best_engine_power_kw AS engine_power_kw,
       best.best_flag AS flag
    FROM
       `world-fishing-827.gfw_research.vi_ssvid_byyear_v20190430`
    WHERE
       on_fishing_list_best
       AND activity.offsetting IS FALSE),
   
  eez_info AS (
     SELECT
       EXTRACT(year FROM _partitiontime) year,
       if(ARRAY_LENGTH(regions.eez)=0, '0000', regions.eez[ordinal(1)]) eez_code,
       ssvid,
       FLOOR(lat/", bin_size,") * ", bin_size, " + ", bin_size/2, " AS lat_cen,
       FLOOR(lon/", bin_size, ") * ", bin_size, " + ", bin_size/2, " AS lon_cen,
       SUM(hours) AS fishing_hours
     FROM
       `world-fishing-827.gfw_research.pipe_production_b_fishing`
     WHERE
       nnet_score2 > .5
       AND seg_id IN (
          SELECT
            seg_id
          FROM
            `world-fishing-827.gfw_research.pipe_production_b_segs`
          WHERE
            good_seg)
    GROUP BY
      year,
      eez_code,
      ssvid,
      lat_cen,
      lon_cen
    HAVING
      year = ", analysis_year, 
      " AND eez_code = '", as.character(top_eezs[i]), "')
      
 SELECT
    year,
    eez_code,
    flag,
    lat_cen,
    lon_cen,
    SUM(a.fishing_hours) as fishing_hours,
    SUM(a.fishing_hours * b.engine_power_kw) as fishing_KWh,
    SUM(a.fishing_hours * b.engine_power_kw * c.subs_per_fishing_KWh) as subs
  FROM
    eez_info a
  LEFT JOIN
    selected_vi b
  USING
    (year,
    ssvid)
  LEFT JOIN
    `ucsb-gfw.subsidy_atlas.subsidy_rates_flag` c
  USING
    (flag)
  GROUP BY
    year,
    eez_code,
    flag,
    lat_cen,
    lon_cen
  HAVING
    fishing_hours > 1"
)

eez_table <- bq_table(project = ucsb_project, table = paste0("fishing_effort_", top_eezs[i]), dataset = "subsidy_atlas") 

  if(bq_table_exists(eez_table) == FALSE){
    bq_table(project = ucsb_project, table = paste0("fishing_effort_", top_eezs[i]), dataset = "subsidy_atlas") %>%
      bq_table_create()
  }else{
    bq_table(project = ucsb_project, table = paste0("fishing_effort_", top_eezs[i]), dataset = "subsidy_atlas") %>%
      bq_table_delete()
  }

eez_effort <- bq_project_query(ucsb_project, sql3, destination_table = bq_table(project = ucsb_project, table = paste0("fishing_effort_", top_eezs[i]), dataset = "subsidy_atlas"), use_legacy_sql = FALSE, allowLargeResults = TRUE) %>%
  bq_table_download(max_results = Inf)

write_csv(eez_effort, path = paste0(eez_dir, top_eezs[i], "_", top_eez_names[i], "_EEZ_effort_subs_by_flag.csv"))

# Load local data instead of rerunning global fishing watch pull 
} else{
  
eez_effort <- read_csv(paste0(eez_dir, top_eezs[i], "_", top_eez_names[i], "_EEZ_effort_subs_by_flag.csv"), col_types = "iccnnnnn")
    
}


### Make Plots 
  # Get quantiles of data for scale limits
  eez_effort_aggregated <- eez_effort %>%
    group_by(year, eez_code, lon_cen, lat_cen) %>%
    summarize(fishing_hours = sum(fishing_hours, na.rm = T),
              fishing_KWh = sum(fishing_KWh, na.rm = T),
              subs = sum(subs, na.rm = T)) %>%
    mutate(subsidy_intensity = subs/fishing_KWh)
  
  # Quantiles
  intensity_quantile <- quantile(eez_effort_aggregated$subsidy_intensity, probs = c(0.01, 0.05, 0.95, 0.99), na.rm = T)
  scale_labels <- round(seq(round(intensity_quantile[1], 1), round(intensity_quantile[4], 1), length.out = 5), 1)
  
  # Set map limits for filtering global country map and eez map appropriately
  x_lim <- c(min(eez_effort_aggregated$lon_cen) - 0.5, max(eez_effort_aggregated$lon_cen) + 0.5)
  y_lim <- c(min(eez_effort_aggregated$lat_cen) - 0.5, max(eez_effort_aggregated$lat_cen) + 0.5)
  
  # Map of subsidy intensity
  eez_subsidy_plot <- ggplot()+
    geom_sf(data = EEZ_map %>% dplyr::filter(is.na(zone)), fill = NA, color = "grey60", size = 0.5)+ # world EEZs (transparent, light grey border lines)
    geom_sf(data = country_map, fill = "grey2", color = "grey40", size = 0.5)+ # world countries (dark grey, white border lines)
    geom_raster(data = eez_effort_aggregated, aes(x = lon_cen, y = lat_cen, fill = subsidy_intensity))+
    eezmaptheme +
    scale_fill_viridis_c(na.value = NA, name = "Subsidy intensity \n(2018 $USD/KWh)", 
                         limits=c(round(intensity_quantile[1],1)-round(intensity_quantile[1],1)*0.01, round(intensity_quantile[4], 1) + round(intensity_quantile[4], 1)*0.01), 
                         labels=c(paste0("\u2264 ", scale_labels[1]), scale_labels[2:4], paste0("\u2265 ", scale_labels[5])),
                         breaks=scale_labels,
                         oob=scales::squish)+
    labs(x = "", y = "")+
    coord_sf(xlim = x_lim, ylim = y_lim)+
    guides(fill = guide_colorbar(title.position = "bottom", title.hjust = 0.5, barwidth = 10))
  
  # Labels for the log scale 
  eez_effort_plot <- ggplot()+
    geom_sf(data = EEZ_map %>% dplyr::filter(is.na(zone)), fill = NA, color = "grey60", size = 0.5)+ # world EEZs (transparent, light grey border lines)
    geom_sf(data = country_map, fill = "grey2", color = "grey40", size = 0.5)+ # world countries (dark grey, white border lines)
    geom_raster(data = eez_effort_aggregated, aes(x = lon_cen, y = lat_cen, fill = fishing_KWh))+
    eezmaptheme +
    scale_fill_viridis_c(na.value = NA, option = "A", name = "Fishing effort \n(KWh)", trans = log10_trans(), labels = comma)+
    labs(x = "", y = "")+
    coord_sf(xlim = x_lim, ylim = y_lim) +
    guides(fill = guide_colorbar(title.position = "bottom", title.hjust = 0.5, barwidth = 10))

 
  # Combined plot  
  combined_title <- ggdraw() + draw_label(paste0("Distant Water Fishing in the ", top_eez_names_long[i]), fontface='bold', colour = "white", size = 12)
  eez_combined_plot <- plot_grid(combined_title, plot_grid(eez_effort_plot, eez_subsidy_plot, ncol = 2, align = "hv"), ncol = 1, rel_heights = c(0.1,1)) +
    theme(plot.background = element_rect(fill = "grey27", color = NA))
  
  ggsave(filename = paste0(eez_dir, top_eezs[i], "_", top_eez_names[i], "_EEZ_heat_map.png"), eez_combined_plot, width = 10, units = "in")

}


```

