---
output:
  html_document: default

title: "Atlas of distant water fishing - Analysis"
author: "Matthew Warham, Kat Millage"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

# Introduction

This script pulls information on fishing effort from Global Fishing Watch for distant water fishing vessels. The top countries with distant water fishing fleets and the top EEZs with the most distant water fishing activity are then identified.  

```{r setup, include=FALSE}
# Chunk options
knitr::opts_chunk$set(echo = TRUE)

### Load packages ------
library(sf) # spatial manipulation
library(lwgeom) # needed for curved lines
library(here) # path names
library(knitr) # knit document
library(bigrquery) # access GFW data
library(DBI) # access GFW data
library(countrycode) # country names 
library(tidyverse) # data manipulation
library(ggalt) # transform to robinson projection
library(RColorBrewer) # custom color palettes
library(scales) # scales for plotting
library(ggpubr) # plot arranging
library(gridExtra)
library(grid)
library(png)

### Set run options -----

# Run flag state analysis (T/F)?
run_flag_state <- F
# Set purpose of the flag state analysis (currently the only choice is "top_ranked")
flag_state_purpose <- "top_ranked"
# Number of flag_states to include (only necessary if purpose is "top_ranked", defaults to 10)
number_of_top_countries_flag <- 20

# Run EEZ analysis (T/F)?
run_eez <- T
# Set purpose of the EEZ anlysis (choices: "ACP" or "top_ranked", defaults to "top_ranked")
eez_purpose <- "ACP"
# Number of EEZs to include (only necessary if purpose is "top_ranked", defaults to 10)
number_of_top_countries_eez <- 10

# Connection to BigQuery - need a project for billing
bq_project <-  "ucsb-gfw"
# Do you want to pull fresh data from GFW?
rerun_gfw <- F

# Choose analysis year (2012 - 2018)
analysis_year <- 2018

```


```{r}
### Create results directories -----
# Shouldn't need to manually change anything in this section

# If either the flag state or eez analyses should be run: 
if(run_flag_state | run_eez){
  
  # Set general results directory
  results_dir <- here::here("results/")
  if (dir.exists(results_dir) == F) { dir.create(results_dir, recursive = T) }
  
  ## Create flag state results directories
  if(run_flag_state){
    
    flag_state_results_dir <- paste0(results_dir, "flag_state_results/", flag_state_purpose, "/")
    if (dir.exists(flag_state_results_dir) == F) { dir.create(flag_state_results_dir, recursive = T) }

    flag_state_country_dat_dir <- paste0(flag_state_results_dir, "country_dat/")
    if (dir.exists(flag_state_country_dat_dir) == F) { dir.create(flag_state_country_dat_dir, recursive = T) }

    flag_state_figures_dir <- paste0(flag_state_results_dir, "figures/")
    if (dir.exists(flag_state_figures_dir) == F) { dir.create(flag_state_figures_dir, recursive = T) }

    flag_state_pdf_dir <- paste0(flag_state_results_dir, "pdfs/")
    if (dir.exists(flag_state_pdf_dir) == F) { dir.create(flag_state_pdf_dir, recursive = T) }
    
  } # /flag state results
  
  ## Create eez results directories
  if(run_eez){
    
    eez_results_dir <- paste0(results_dir, "eez_results/", eez_purpose, "/")
    if (dir.exists(eez_results_dir) == F) { dir.create(eez_results_dir, recursive = T) }
    
    eez_dat_dir <- paste0(eez_results_dir, "dat/")
    if (dir.exists(eez_dat_dir) == F) { dir.create(eez_dat_dir, recursive = T) }

    eez_figures_dir <- paste0(eez_results_dir, "figures/")
    if (dir.exists(eez_figures_dir) == F) { dir.create(eez_figures_dir, recursive = T) }

    eez_pdf_dir <- paste0(eez_results_dir, "pdfs/")
    if (dir.exists(eez_pdf_dir) == F) { dir.create(eez_pdf_dir, recursive = T) }
    
    
    # If EEZ purpose is "ACP", also create a results directory for the app
    if(eez_purpose == "ACP"){
      eez_results_app_dir <- paste0(here::here("SubsidyAtlasACP/"), "data/eez_results/", eez_purpose, "/")
      if (dir.exists(eez_results_app_dir) == F) { dir.create(eez_results_app_dir, recursive = T) }
    }
    
  } # /eez results
  
} # /all results
```

# Pull total fishing effort from Global Fishing Watch

This section describes the process of linking to the most recent version of the GFW data, and pulling information on fishing vessels represented in that dataset. This process was last performed on 8/8/2019.  

We first extract total fishing hours (and fishing days) by year and EEZ for each vessel in the dataset. EEZs are defined by a numeric code, each cooresponding to a region in the World EEZ data set from Marineregions.org. The responsible territory for each region has been identified, as well as the sovereign country (or countries for disputed regions). We then match the best vessel characteristics identified by GFW to each vessel, and remove entries for all vessels that GFW does not consider to be fishing vessels. 

```{r}
if(run_flag_state | run_eez & rerun_gfw){

# Query to pull fishing effort by vessel, by EEZ
sql <- "
WITH
  eez_lookup AS (
    SELECT
      CAST(eez_id AS string) eez_code,
      eez_type,
      reporting_name eez_name,
      territory1_iso3 eez_territory_iso3,
      sovereign1_iso3 eez_sovereign_iso3,
      sovereign2_iso3 eez_sovereign2_iso3,
      sovereign3_iso3 eez_sovereign3_iso3
    FROM
      `world-fishing-827.gfw_research.eez_info`),
      
 fishing_info_by_eez AS (
    SELECT
      EXTRACT(year FROM _partitiontime) year,
      ssvid,
      if(ARRAY_LENGTH(regions.eez)=0, '0000', regions.eez[ordinal(1)]) eez_code,
      CASE WHEN COUNT(DISTINCT _partitiontime) IS NULL THEN 0 ELSE COUNT(DISTINCT _partitiontime) END fishing_days_year_eez,
      CASE WHEN SUM(hours) IS NULL THEN 0 ELSE SUM(hours) END fishing_hours_year_eez
    FROM
      `world-fishing-827.gfw_research.pipe_production_b_fishing`
    WHERE
      nnet_score2 > .5
      AND seg_id IN (
        SELECT
          seg_id
            FROM
              `world-fishing-827.gfw_research.pipe_production_b_segs`
            WHERE
              good_seg)
    GROUP BY
      year,
      ssvid,
      eez_code)
 
SELECT
  year,
  ssvid,
  best.best_flag flag,
  best.best_vessel_class vessel_class,
  best.best_length_m length_m,
  best.best_tonnage_gt tonnage_gt,
  best.best_engine_power_kw engine_power_kw,
  ais_identity.shipname_mostcommon.value broadcast_shipname,
  ais_identity.n_callsign_mostcommon.value broadcast_callsign,
  eez_code,
  eez_type,
  eez_name,
  if(eez_territory_iso3 IS NULL, 'High Seas', eez_territory_iso3) eez_territory_iso3,
  eez_sovereign_iso3,
  eez_sovereign2_iso3,
  eez_sovereign3_iso3,
  fishing_hours_year_eez,
  fishing_hours_year_eez*best.best_engine_power_kw fishing_KWh_year_eez,
  fishing_days_year_eez
FROM
  fishing_info_by_eez
RIGHT JOIN
  `world-fishing-827.gfw_research.vi_ssvid_byyear_v20190430`
USING
  (year,
   ssvid)
LEFT JOIN
    eez_lookup
USING
    (eez_code)
WHERE 
  on_fishing_list_best
  AND activity.offsetting IS FALSE
ORDER BY
  year,
  eez_territory_iso3,
  eez_code,
  fishing_hours_year_eez DESC,
  ssvid"

# Store in bigquery - all_fishing_effort_by_eez (~700,000 rows - over 100MB)
bq_table(project = bq_project, table = "all_fishing_effort_by_eez", dataset = "subsidy_atlas") %>% 
  bq_table_delete()
bq_project_query(bq_project, sql, destination_table = bq_table(project = bq_project, table = "all_fishing_effort_by_eez",dataset = "subsidy_atlas"), use_legacy_sql = FALSE, allowLargeResults = TRUE)

}
```

## Flag state fishing totals by year

For the purposes of allocating subsidies to individual vessels, we need the total number of fishing hours for each flag state in a given year, as we assume that subsidies are allocated proportionally based on fishing effort. 

```{r}
if(run_flag_state | run_eez & rerun_gfw){
  
sql2 <- "
SELECT
  year,
  flag,
  COUNT(DISTINCT ssvid) AS vessels_total,
  SUM(fishing_hours_year_eez) fishing_hours_total,
  SUM(fishing_KWh_year_eez) fishing_KWh_total,
  SUM(fishing_days_year_eez) fishing_days_total
FROM
  `ucsb-gfw.subsidy_atlas.all_fishing_effort_by_eez`
GROUP BY
  year,
  flag
ORDER BY
  year DESC,
  flag"

  # Identify BQ table for this query
  flag_totals_table <- bq_table(project = bq_project, table = "fishing_effort_totals_by_flag", dataset = "subsidy_atlas") 

  # Check if that table already exists. If not, create it. Otherwise clear it. 
  if(bq_table_exists(flag_totals_table) == FALSE){
    bq_table(project = bq_project, table = "fishing_effort_totals_by_flag", dataset = "subsidy_atlas") %>%
      bq_table_create()
  }else{
    bq_table(project = bq_project, table = "fishing_effort_totals_by_flag", dataset = "subsidy_atlas") %>%
      bq_table_delete()
  }

  # Run query
  flag_totals <- bq_project_query(bq_project, sql2, destination_table = bq_table(project = bq_project, table = "fishing_effort_totals_by_flag", dataset = "subsidy_atlas"), use_legacy_sql = FALSE, allowLargeResults = TRUE) %>%
    bq_table_download(max_results = Inf)
  
  write_csv(flag_totals, path = paste0(results_dir, "fishing_effort_totals_by_flag.csv"))
  
}else{
  
  flag_totals <- read_csv(paste0(results_dir, "fishing_effort_totals_by_flag.csv"))
  
}

```

## Identify distant water fishing vessels

Since the purpose of this analysis relates to distant water fishing effort, we need to separate out fishing effort considered to be "distant water" from the rest. This is done in a series of steps. 

In the first step, the following is not considered to be "distant water fishing" and is therefore removed:
- All fishing effort occuring on the high seas;
- All fishing effort occuring in an EEZ when the flag state of the vessel is the same as the administering state of the EEZ in which it is fishing.

Additionally, we remove all entries in which a vessel has spent less than 1 hour fishing in a given EEZ in a year. 

```{r}
if(run_flag_state | run_eez & rerun_gfw){
  
sql3 <- "
SELECT
  *
FROM
  `ucsb-gfw.subsidy_atlas.all_fishing_effort_by_eez`
WHERE 
fishing_hours_year_eez > 1
and eez_territory_iso3 != 'High Seas'
and flag != eez_territory_iso3"

  # Identify BQ table for this query
  all_dw_fishing_effort_by_eez_table <- bq_table(project = bq_project, table = "all_dw_fishing_effort_by_eez", dataset = "subsidy_atlas")
  
  # Check if that table already exists. If not, create it. Otherwise clear it. 
  if(bq_table_exists(all_dw_fishing_effort_by_eez_table) == FALSE){
    bq_table(project = bq_project, table = "all_dw_fishing_effort_by_eez", dataset = "subsidy_atlas") %>%
      bq_table_create()
  }else{
    bq_table(project = bq_project, table = "all_dw_fishing_effort_by_eez", dataset = "subsidy_atlas") %>%
      bq_table_delete()
  }
  
  # Run query and download results (~100,000 rows: ~25MB)
  all_dw_fishing_effort_by_eez <- bq_project_query(bq_project, sql3, destination_table = bq_table(project = bq_project, table = "all_dw_fishing_effort_by_eez", dataset = "subsidy_atlas"), use_legacy_sql = FALSE, allowLargeResults = TRUE) %>%
  bq_table_download(max_results = Inf)
  
  # Correct interpretation of NAs
  dw_effort_raw <- all_dw_fishing_effort_by_eez
  dw_effort_raw[dw_effort_raw == "NA"] <- NA
  
  # Fix a couple of iso3 codes that are outdated
  dw_effort_raw$flag[dw_effort_raw$flag == "ROM"] <- "ROU"
  dw_effort_raw$flag[dw_effort_raw$flag == "GCA"] <- "GTM"
  dw_effort_raw$flag[is.na(dw_effort_raw$flag)] <- "UNK"
    
  # Save file locally
  write_csv(dw_effort_raw, path = paste0(results_dir, "RAW_dw_effort_by_eez.csv"))
  
} else{
  
  # Pull local stored copy of the data 
  dw_effort_raw <- read_csv(paste0(results_dir, "RAW_dw_effort_by_eez.csv"), col_types = "icccnnncccccccccnni")
  
  #dw_effort <- read_csv("~/GitHub/subsidy-atlas/results/RAW_dw_effort_by_eez.csv")

}
```

## Determine the sovereign states of each flag state

In order to further parse out distant water fishing effort, we will need to take sovereignty into consideration. GFW has done a lot of this work for us, therefore we use the sovereign states assigned to each eez iso3 for flag states as well. Let's create a table matching all of these up. 

```{r}
if(run_flag_state | run_eez){
  
# Get a list of sovereignty pairings from GFW eez data
sovereign_pairings <- dw_effort_raw %>%
  distinct(eez_sovereign_iso3, eez_territory_iso3) %>%
  rename(sovereign_iso3 = eez_sovereign_iso3, iso3 = eez_territory_iso3) %>%
  na.omit() %>% # there's one entry where flag = CHN, and sovereign = NA
  arrange(iso3)

# Custom sovereignty pairings that are missing
c_sovereign_pairings <- tibble(iso3 = c("BLZ", "ARM", "AUT", "SRB", "CHE", "LIE", "UNK", "SVK", "MNG", "IRQ", "JOR", "HKG", "NER", "BOL", "LSO", "HUN", "KHM", "AFG")) %>%
  mutate(name = case_when(iso3 == "UNK" ~ "Unknown",
                          TRUE ~ countrycode::countrycode(iso3, "iso3c", "country.name")),
         sovereign_iso3 = case_when(iso3 == "HKG" ~ "CHN",
                                    TRUE ~ iso3))

# Put them all back together
sovereign_pairings_all <- sovereign_pairings %>%
  bind_rows(c_sovereign_pairings %>% dplyr::select(sovereign_iso3, iso3)) %>%
  arrange(iso3)

# Save for future reference just in case
write_csv(sovereign_pairings_all, path = paste0(results_dir, "sovereign_pairings_all.csv"))
}
```

We then assign these names to the flag states of vessels, as well as to the EEZ states and sovereigns in the GFW database by matching ISO-3 character codes of each entity. 

```{r}
if(run_flag_state | run_eez){
# Add sovereign state to each vessel in GFW
dw_effort <- dw_effort_raw %>%
  left_join(sovereign_pairings_all, by = c("flag" = "iso3"))

# Add names 
dw_effort <- dw_effort %>%
  mutate(flag_name = case_when(flag == "UNK" ~ "Unknown",
                               TRUE ~ countrycode::countrycode(flag, "iso3c", "country.name")),
         sovereign_name = case_when(sovereign_iso3 == "UNK" ~ "Unknown",
                               TRUE ~ countrycode::countrycode(sovereign_iso3, "iso3c", "country.name")),
         eez_territory_name = case_when(eez_territory_iso3 == "ASC" | eez_territory_iso3 == "TAA" ~ countrycode::countrycode("SHN", "iso3c", "country.name"),
                                        eez_territory_iso3 == "CPT" ~ "Clipperton Island",
                                        TRUE ~ countrycode::countrycode(eez_territory_iso3, "iso3c", "country.name")),
         eez_sovereign_name = countrycode::countrycode(eez_sovereign_iso3, "iso3c", "country.name"),
         eez_sovereign2_name = countrycode::countrycode(eez_sovereign2_iso3, "iso3c", "country.name"),
         eez_sovereign3_name = countrycode::countrycode(eez_sovereign3_iso3, "iso3c", "country.name"))

}
```

## European Union vessels

Vessels flagged to EU member states have the right to fish in the EEZs of other EU member states, therefore we do not include these instances as "distant water fishing". In order to remove these from our dataset, we first need create a list of EU member states, as well as non-member states with with the EU has fishing agreements as part of the northern agreement (i.e. Norway and Iceland). 

We define "intra-EU fishing" as fishing activity that meets one of the following criteria: 
1. The flag state of the vessel is a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland and the EEZ in which it is fishing is administered by a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland (e.g. a French-flagged vessel fishing in the EEZ of Spain);
2. The sovereign of the vessel's flag state is a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland and the EEZ in which it is fishing is administered by a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland (e.g. a XXX-flagged vessel fishing in the EEZ of Spain).

We do not consider the following to be "intra-EU fishing": 
1. The flag state of the vessel is a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland and the EEZ in which it is fishing belongs to a territory or distant region of an EU member state (e.g. a French-flagged vessel fishing in the EEZ of French Polynesia). 

```{r}
if(run_flag_state | run_eez){
# EU member states
# Austria, Belgium, Bulgaria, Croatia, Cyprus, Czechia, Denmark, Estonia, Finland, France, Germany, Greece, Hungary, Ireland, Italy, Latvia, Lithuania, Luxembourg, Malta, Netherlands, Poland, Portugal, Romania, Slovakia, Slovenia, Spain, Sweden, United Kingdom
eu_states <- c("AUT", "BEL", "BGR", "HRV", "CYP", "CZE", "DNK", "EST", "FIN", "FRA", "DEU", "GRC", "HUN", "IRL", "ITA", "LVA", "LTU", "LUX", "MLT", "NLD", "POL", "PRT", "ROU", "SVK", "SVN", "ESP", "SWE", "GBR")

# EU remote regions
# Wallis and Futuna, French Guiana, Sint Maarten (Dutch part), Saint Pierre and Miquelon, Saint Martin (French part), Mayotte, Saint Barthelemy, Reunion, Curaçao, Aruba, British Indian Ocean Territory, Bonaire, Saint Eustatius and Saba, Guadeloupe, Martinique, Saint Helena, Ascension and Tristan da Cunha, Ascension Island, South Georgia and the South Sandwich Islands, French Southern Territories, Tristan da Cunha, Falkland Islands (Malvinas), Bermuda, Turks and Caicos Islands, Cayman Islands, Virgin Islands, British, Anguilla, Montserrat, Pitcairn, French Polynesia
# eu_distant_states <- c('WLF', 'GUF', 'SXM', 'SPM', 'MAF', 'MYT', 'BLM', 'REU', 'CUW', 'ABW', 'IOT', 'BES', 'GLP', 'MTQ', 'SHN', 'ASC', 'SGS', 'ATF', 'TAA', 'FLK', 'BMU', 'TCA','CYM', 'VGB','AIA', 'MSR', 'PCN', 'PYF')

# States with which the EU has free fishing agreements 
# Norway, Svalbard and Jan Mayen, Iceland
eu_northern_agreement <- c("NOR", "SJM", "ISL")

# Identify flag/eez pairings which we're excluding from "distant water" because of the EU relationship between nations
dw_effort <- dw_effort %>%
  mutate(is_EU = ifelse(flag %in% c(eu_states, eu_northern_agreement) & eez_territory_iso3 %in% c(eu_states, eu_northern_agreement) |
                      sovereign_iso3 %in% c(eu_states, eu_northern_agreement) & eez_territory_iso3 %in% c(eu_states, eu_northern_agreement), 
                      TRUE, 
                      FALSE)) %>%
  dplyr::filter(!is_EU)
}
```
 
For the purposes of this analysis, we do not consider "intra-EU fishing" to be distant-water fishing and it is therefore removed. 

## Dealing with sovereignty

If the sovereign flag state of a vessel is the same as the sovereign state of the EEZ in which it's fishing, this connection may still be considered to be distant water fishing (e.g. US vessel fishing in Palmyra Atoll), though this is generally not considered to be foreign distant water fishing. Let's add a field identifying effort in which this is the case. Though we aren't making any distinctions between foreign distant water fishing and distant water fishing right now, it might be helpful later on to have this distinction available. 

We descibe "sovereign fishing" as fishing activity that meets one of the following criteria: 
1. The flag state of the vessel is the same as the sovereign of the administering territory of the EEZ in which it is fishing (e.g. a US flagged vessel fishing in the EEZ of Palmyra Atoll).
2. The sovereign of the flag state of the vessel is the same as the sovereign of the administering territory of the EEZ in which it is fishing (e.g. a Puerto-Rican flagged vessel fishing in the EEZ of Palmyra Atoll);


```{r}
if(run_flag_state | run_eez){
# 4,922 connections are not foreign
dw_effort <- dw_effort %>%
  mutate(is_foreign = case_when(flag == eez_sovereign_iso3 | 
                                    flag == eez_sovereign2_iso3 | 
                                    flag == eez_sovereign3_iso3 |
                                    sovereign_iso3 == eez_sovereign_iso3 | 
                                    sovereign_iso3 == eez_sovereign2_iso3 |
                                    sovereign_iso3 == eez_sovereign3_iso3 ~ FALSE,
                                  TRUE ~ TRUE))
}
```

There are some cases in which there may be connections that are not foreign and that because of their particular situation should not be considered distant water. An example of this are disputed and joint regime EEZ.  These are listed and removed here:

```{r}
if(run_flag_state | run_eez){
sovereign_connections <- dw_effort %>%
  filter(!is_foreign) %>%
  distinct(flag_name, sovereign_name, eez_code, eez_name, eez_type, eez_territory_name , eez_sovereign_name, eez_sovereign2_name, eez_sovereign3_name) %>%
  arrange(desc(sovereign_name))

non_distant_water_connections <- sovereign_connections %>%
  filter(!(flag_name == "United States" & eez_code %in% c("8442", "8443", "8444", "8451", "8452", "33179", "33180", "48980"))) %>%
  filter(!(flag_name == "Falkland Islands" & eez_territory_name == "St. Helena")) %>%
  filter(!(sovereign_name == "United Kingdom" & eez_territory_name == "South Georgia & South Sandwich Islands")) %>%
  filter(!(sovereign_name == "United Kingdom" & eez_territory_name == "Falkland Islands")) %>%
  filter(!(flag_name == "United Kingdom" & eez_territory_name == "Montserrat")) %>%
  filter(!(sovereign_name == "New Zealand")) %>%
  filter(!(sovereign_name == "France")) %>%
  filter(!(sovereign_name == "Australia" & eez_type == "200NM"))

dw_effort <- dw_effort %>%
  anti_join(non_distant_water_connections)
}
```

For the purposes of this analysis, we include both "sovereign distant water fishing" and "foreign distant water fishing" as distant water fishing. 

```{r}
if(run_flag_state | run_eez){
dw_effort <- dw_effort %>%
  dplyr::filter(year == analysis_year)
}
```

## Allocate subsidies

Now that we have our final subset of distant water fishing effort/vessels from our database, we want to allocate subsidies proportionally based on fishing effort to get an estimate of the total amount of subsidies each vessel recieves. 

First we determine subsidy rates for each flag state based on total annual fishing effort contained in our dataset. 

```{r}
if(run_flag_state | run_eez){
# Load subsidy data and do a little bit of wrangling to clean it up. 
subsidy_dat <- read_csv(here::here("data", "subsidies", "Subsidies_update_Pew_final_May_10.csv")) %>%
  setNames(tolower(names(.))) %>%
  rename(value = `constant 2018 usd`,
         estimate_type = `data type`) %>%
  mutate(iso3 = case_when(country == "Dominican Rp" ~ "DOM",
                          country == "Micronesia" ~ "FSM",
                          country == "Untd Arab Em" ~ "ARE", 
                          TRUE ~ countrycode(country, "country.name", 'iso3c'))) %>%
  mutate(type_code = case_when(type == "Fisheries mangt." ~ "A1",
                               type == "Fishery R&D" ~ "A2",
                               type == "MPAs" ~ "A3",
                               type == "Boat constsruct. & renov." ~ "B1",
                               type == "Fisheries dev. projects" ~ "B2",
                               type == "Fishing port develop." ~ "B3",
                               type == "Markt. & storage infrast." ~ "B4",
                               type == "Tax exemption" ~ "B5",
                               type == "Fishing access" ~ "B6",
                               type == "Fuel subsidies" ~ "B7",
                               type == "Fisher assistance" ~ "C1",
                               type == "Vessel buyback" ~ "C2",
                               type == "Rural fisher communities" ~ "C3",
                               TRUE ~ "NA"))

subsidy_factors <- subsidy_dat %>%
  distinct(type_code, type)

subsidy_dat_ordered <- subsidy_dat %>%
  mutate(type_code = factor(type_code, subsidy_factors$type_code),
         type = factor(type, subsidy_factors$type))

# Adjust subsidy estimates to only represent subsides going to large-scale fisheries
subsidy_distribution <- tibble(type_code = c("A1", "A2", "A3", "B7", "B3", "B1", "B4", "B5", "B2", "B6", "C2", "C1", "C3"),
                               lsf_prop = c(0.743, 0.783, 0.779, 0.939, 0.791, 0.848, 0.931, 0.866, 0.742, 1, 0.998, 0.753, 0.159)) %>% mutate(type_code = factor(type_code, subsidy_factors$type_code))

subsidy_dat_edit <- subsidy_dat_ordered %>%
  left_join(subsidy_distribution, by = "type_code") %>%
  mutate(new_value = value * lsf_prop)

# Filter our total fishing effort by flag state for the analysis year and join to the subsidy data
dw_subsidy_rates_flag_all <- flag_totals %>%
  dplyr::filter(year == analysis_year) %>%
  left_join(subsidy_dat_edit, by = c("flag" = "iso3")) %>%
  dplyr::filter(!is.na(category)) %>% # remove entries for which we don't have subsidy information
  dplyr::filter(!is.na(fishing_hours_total)) %>% # remove entries for which we don't have fishing effort
  mutate(subs_per_fishing_hour = new_value/fishing_hours_total,
         subs_per_fishing_KWh = new_value/fishing_KWh_total,
         subs_per_fishing_day = new_value/fishing_days_total)

# Save subsidy rates by flag to Bigquery
  subsidy_rates_table <- bq_table(project = bq_project, table = "subsidy_rates_flag", dataset = "subsidy_atlas")

  if(rerun_gfw){
    
     # Check if that table already exists. If not, create it. Otherwise clear it. 
  if(bq_table_exists(subsidy_rates_table)){
    
    subsidy_rates_table %>%
      bq_table_delete() 
    
    subsidy_rates_table %>%
      bq_table_create() %>%
      bq_table_upload(values = dw_subsidy_rates_flag_all, fields = dw_subsidy_rates_flag_all)
    
  }else{
    subsidy_rates_table %>%
      bq_table_create() %>%
      bq_table_upload(values = dw_subsidy_rates_flag_all, fields = dw_subsidy_rates_flag_all)
      
  }
  }
  
write_csv(dw_subsidy_rates_flag_all, paste0(results_dir, "subsidy_rates_flag.csv"))

# Filter to only include certain subsidy type in the final totals and summarize total subsidy rates by flag state
dw_subsidy_rates_flag <- dw_subsidy_rates_flag_all %>%
  dplyr::filter(category == "Capacity-enhancing") %>%
  group_by(flag) %>%
  summarize(subs_per_fishing_KWh = sum(subs_per_fishing_KWh, na.rm = T))

# Allocate subsidies by flag, and then by sovereign if needed...
dw_effort_final <- dw_effort %>%
  left_join(dw_subsidy_rates_flag, by = c("flag" = "flag")) %>%
  rename(flag_subs_fishing_KWh = subs_per_fishing_KWh) %>%
  left_join(dw_subsidy_rates_flag, by = c("sovereign_iso3" = "flag")) %>%
  rename(sovereign_subs_fishing_KWh = subs_per_fishing_KWh) %>%
  mutate(subs_per_fishing_KWh = case_when(!is.na(flag_subs_fishing_KWh) ~ flag_subs_fishing_KWh,
                                          TRUE ~ sovereign_subs_fishing_KWh)) %>%
  dplyr::select(-flag_subs_fishing_KWh, -sovereign_subs_fishing_KWh)
dw_effort_final$subs_per_fishing_KWh[is.na(dw_effort_final$subs_per_fishing_KWh)] <- 0


# Save
if(rerun_gfw){
  
  dw_effort_final_table <- bq_table(project = bq_project, table = paste0("FINAL_dw_effort_by_eez_", analysis_year), dataset = "subsidy_atlas")
  
     # Check if that table already exists. If not, create it. Otherwise clear it. 
  if(bq_table_exists(dw_effort_final_table)){
    
      dw_effort_final_table %>%
      bq_table_delete()
    
      dw_effort_final_table %>%
      bq_table_create() %>%
      bq_table_upload(values = dw_effort_final, fields = dw_effort_final)
    
  }else{
    
      dw_effort_final_table %>%
      bq_table_create() %>%
      bq_table_upload(values = dw_effort_final, fields = dw_effort_final)

  }

}
write_csv(dw_effort_final, paste0(results_dir, "FINAL_dw_effort_by_eez_", analysis_year, ".csv"))
}
```

## Flag state and EEZ centroids 

In order to make our connection plots, we need to find the centroids of each EEZ and flag state so we can create the connectivity lines. For the flag state analysis and the eez analyis for the top ranked EEZs, we're going to use a standard -180 to 180 degree world view for plotting to keep things simple. 

Things get slightly more complicated for the ACP eez analysis because we want to use three different world views for each of the three regions (so the region of interest is centered). Therefore we have created shapefiles that span from -360 to 360 degrees, which we can clip to the appropriate extents for each of our three regions (Africa, Caribbean, and Pacific). For Africa, we've chosen to use a -180 to 180 degree view (so we'll also use this for the flag state analysis and/or the top ranked eez analysis). For the Caribbean, we've chosen to use a -260 to 100 degree view. For the Pacific, we've chosen to use a 0 to 360 degree view. 

For the purposes of plotting the EEZs in which the fishing activity is taking place, we're using a simplified form of the Version 10 shapefile of the Maritime Boundaries - World EEZs from MarineRegions.org. We simplified the shapefile using mapshaper (online at mapshaper.org) to a tolerance of 0.5%. For the purposes of plotting the flag states to which distant water vessels are flagged, we're using the Version 2 shapefile of the Marine and land zones: the union of world country boundaries and EEZs from Marine Regions.org.

```{r}
# For the flag state analysis and the eez analysis for the top ranked EEZs we're going to use the standard -180 to 180 degree world view
# For the ACP analysis, things get a little complicated as we want to use three different world views for the three different regions
# For Africa, we're going to use the standard -180 to 180 degree world view
# For the Pacific, we're going to use a 0 to 360 degree world view
# For the Caribbean, we're going to use a -260 to 100 degree world view
# Therefore, if we're running the flag state analysis, or the top-ranked EEZ analysis, we'll just use the coordinates for the Africa version
if(run_flag_state | run_eez){
  
  ### EEZs for location of fishing activity -----
  eez_map <- read_sf(dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "World_EEZ_v10_20180221_LR_-360_360"), layer = "World_EEZ_v10_2018021_LR_-360_360") %>%
    st_transform(crs = 4326) %>%
    setNames(tolower(names(.))) %>%
    dplyr::select(id = cat,
                  mrgid,
                  geoname,
                  pol_type,
                  territory1,
                  iso3_ter1 = iso_ter1,
                  sovereign1,
                  territory2,
                  iso3_ter2 = iso_ter2,
                  sovereign2,
                  territory3,
                  iso3_ter3 = iso_ter3,
                  sovereign3)
  
  # Pacific
  pacific_eez_map <- st_crop(eez_map, c(xmin=0, xmax=360, ymin=-90, ymax=90))
  pacific_eez_map_centroids <- pacific_eez_map %>%
    st_centroid() %>%
    dplyr::select(eez_code = mrgid, eez_name = geoname, geometry) %>%
    mutate(region = "Pacific")
  
  # Africa
  africa_eez_map <- st_crop(eez_map, c(xmin=-180, xmax=180, ymin=-90, ymax=90))
  africa_eez_map_centroids <- africa_eez_map %>%
    st_centroid() %>%
    dplyr::select(eez_code = mrgid, eez_name = geoname, geometry) %>%
    mutate(region = "Africa")
  
  # Caribbean
  caribbean_eez_map <- st_crop(eez_map, c(xmin=-260, xmax=100, ymin=-90, ymax=90))
  caribbean_eez_map_centroids <- caribbean_eez_map %>%
    st_centroid() %>%
    dplyr::select(eez_code = mrgid, eez_name = geoname, geometry) %>%
    mutate(region = "Caribbean")
  
  # Bind together 
  eez_map_centroids <- pacific_eez_map_centroids %>%
    rbind(africa_eez_map_centroids) %>%
    rbind(caribbean_eez_map_centroids)
  
  # Put centroids in lon/lat columns
  eez_map_centroid_coordinates <- tibble(eez_code = eez_map_centroids$eez_code,
                                         eez_name = eez_map_centroids$eez_name,
                                         region = eez_map_centroids$region) %>% 
    bind_cols(do.call(rbind, st_geometry(eez_map_centroids)) %>%
                as_tibble() %>%
                setNames(c("eez_lon", "eez_lat"))) %>%
    arrange(eez_code)
  
  # Manually correct certain centroids 
  # NEED TO DO THIS
  #manual_coordinates_eez <- read_csv(paste0(results_dir, "corrected_EEZ_centroids.csv"))
  # eez_map_centroid_coordinates_edited <- eez_map_centroid_coordinates %>% 
  #   left_join(manual_coordinates_eez, by = c("eez_code")) %>% 
  #   mutate(eez_lon = ifelse(!is.na(eez_lon_edit), eez_lon_edit, eez_lon)) %>% 
  #   mutate(eez_lat = ifelse(!is.na(eez_lat_edit), eez_lat_edit, eez_lat)) %>%
  #   dplyr::select(-eez, -eez_lat_edit, -eez_lon_edit)

  
  ### Combined land/EEZs for flag states -----
  land_eez_map <- read_sf(dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "EEZ_land_v2_201410_-360_360"), layer = "EEZ_land_v2_201410_-360_360") %>%
    st_transform(crs = 4326) %>%
    setNames(tolower(names(.))) %>%
    dplyr::select(id = objectid,
                  iso3 = iso_3digit,
                  country)
  
   # Pacific
  pacific_land_eez_map <- st_crop(land_eez_map, c(xmin=0, xmax=360, ymin=-90, ymax=90))
  pacific_land_eez_map_centroids <- pacific_land_eez_map %>%
    st_centroid() %>%
    dplyr::select(flag = iso3, flag_name = country, geometry) %>%
    mutate(region = "Pacific")
  
  # Africa
  africa_land_eez_map <- st_crop(land_eez_map, c(xmin=-180, xmax=180, ymin=-90, ymax=90))
  africa_land_eez_map_centroids <- africa_land_eez_map %>%
    st_centroid() %>%
    dplyr::select(flag = iso3, flag_name = country, geometry) %>%
    mutate(region = "Africa")
  
  # Caribbean
  caribbean_land_eez_map <- st_crop(land_eez_map, c(xmin=-260, xmax=100, ymin=-90, ymax=90))
  caribbean_land_eez_map_centroids <- caribbean_land_eez_map %>%
    st_centroid() %>%
    dplyr::select(flag = iso3, flag_name = country, geometry) %>%
    mutate(region = "Caribbean")
  
  # Bind together
  land_eez_map_centroids <- pacific_land_eez_map_centroids %>%
    rbind(africa_land_eez_map_centroids) %>%
    rbind(caribbean_land_eez_map_centroids)
  
  
  
  # Put centroids in lon/lat columns
  land_eez_map_centroid_coordinates <- tibble(flag = land_eez_map_centroids$flag,
                                              flag_name = land_eez_map_centroids$flag_name,
                                              region = land_eez_map_centroids$region) %>% 
    bind_cols(do.call(rbind, st_geometry(land_eez_map_centroids)) %>%
                as_tibble() %>%
                setNames(c("flag_lon", "flag_lat"))) %>%
    arrange(flag) %>%
    na.omit()
  
   #Manually correct certain centroids
   #NEED TO DO THIS
   manual_coordinates_flags <- read_csv(paste0(results_dir, "corrected_flag_centroids.csv"))
   
   # land_eez_map_centroid_coordinates_edited <- land_eez_map_centroid_coordinates %>%
   #   left_join(manual_coordinates_flags, by = c("flag", "region")) %>%
   #   mutate(flag_lon = ifelse(!is.na(flag_lon_edit), flag_lon_edit, flag_lon),
   #          flag_lat = ifelse(!is.na(flag_lat_edit), flag_lat_edit, flag_lat)) %>%
   #   dplyr::select(-flag_lon_edit, -flag_lat_edit) 

}
```

We also need to do some setup for our figures. 

```{r}
if(run_flag_state | run_eez){
  
  # Custom theme for map
  maptheme <- theme_minimal() +
    theme(panel.background = element_rect(fill = "grey27", colour = NA),
          panel.grid.major = element_line(colour = "grey27"),
          panel.border = element_blank(),
          plot.margin = unit(c(0, 0, 0, 0), "mm"),
          plot.background = element_blank(),
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks.length = unit(0, "pt"))

}
if(run_flag_state){
  
  # Custom color palette for Sumaila subsidy types
  goodColors <- rev(brewer.pal(3, "Blues"))
  names(goodColors) <- levels(subsidy_dat_edit$type)[1:3]
  
  badColors <- rev(brewer.pal(7, "Reds"))
  names(badColors) <- levels(subsidy_dat_edit$type)[4:10]
  
  ambigColors <- c("purple", "mediumorchid", "violet")
  names(ambigColors) <- levels(subsidy_dat_edit$type)[11:13]
  
  myColors <- c(goodColors, badColors, ambigColors)

}
```

## Part 1: Identify top DW fishing fleets by flag state

Currently, the only option for this part of the analysis is to look at distant water fishing fleets by flag state, ranked according to total distant water fishing effort. 

We first rank flag states with DW fishing fleets based on the following metrics:
- Number of fishing vessels partaking in DW fishing
- Total capacity of fishing vessels partaking of DW fishing
- Total number of DW fishing hours
- Total number of DW fishing KWh 

```{r}
if(run_flag_state){

# Mutate totals by flag state for all
flag_state_ranking <- dw_effort_final %>% 
  group_by(flag, ssvid) %>%
  summarize(engine_power_kw = unique(engine_power_kw),
            fishing_hours = sum(fishing_hours_year_eez, na.rm = T),
            fishing_KWh = sum(fishing_KWh_year_eez, na.rm = T)) %>%
  ungroup() %>%
  group_by(flag) %>%
  summarize(total_vessels = n_distinct(ssvid),
            total_capacity = sum(engine_power_kw, na.rm = T),
            total_fishing_hours = sum(fishing_hours, na.rm = T),
            total_fishing_KWh = sum(fishing_KWh, na.rm = T)) %>% 
  arrange(desc(total_vessels)) %>%
  ungroup() %>%
  mutate(vessel_rank = dense_rank(desc(total_vessels)),
         capacity_rank = dense_rank(desc(total_capacity)),
         fishing_hours_rank = dense_rank(desc(total_fishing_hours)),
         fishing_KWh_rank = dense_rank(desc(total_fishing_KWh))) %>%
  mutate(avg_rank = rowMeans(select(., c(vessel_rank, capacity_rank, fishing_hours_rank, fishing_KWh_rank))))

# Save flag states by average ranking
write_csv(flag_state_ranking, paste0(flag_state_results_dir, "flag_state_ranking_", analysis_year, ".csv"))

}
```

We then identify the top `r number_of_top_countries_flag` flag states. For each of our top flag states, we also identify all EEZs in which DW vessels flagged to that state fish.

```{r}
if(run_flag_state){
  
  # Set defaults in case option isn't correctly specified above
  if(is.na(number_of_top_countries_flag) | !is.numeric(number_of_top_countries_flag)){
    number_of_top_countries_flag <- 10
  }

  flag_state_ranking_top <- flag_state_ranking %>%
    top_n(-number_of_top_countries_flag, wt = avg_rank)
  
  # Get iso3 codes for selected flag states 
  top_flag_states <- flag_state_ranking_top$flag

  top_flag_states_names <- (tibble(flag = top_flag_states) %>%
    mutate(name = countrycode::countrycode(flag, "iso3c", "country.name")))$name

  flag_state_combinations <- dw_effort_final %>%
    dplyr::filter(flag %in% top_flag_states) %>%
    group_by(flag, eez_code = as.numeric(eez_code)) %>%
    summarize(vessels = n_distinct(ssvid),
              capacity = sum(engine_power_kw, na.rm = T),
              fishing_h = sum(fishing_hours_year_eez, na.rm = T),
              fishing_KWh = sum(fishing_KWh_year_eez, na.rm = T)) %>%
    arrange(flag) %>%
    ungroup() %>%
    mutate(region == "Africa")

}
```

We then match the previously obtained centroids to each of our top flag states, as well as all EEZs in which DW vessels from these states fish. 

```{r}
if(run_flag_state){
  
flag_state_mapping <- flag_state_combinations %>%
  left_join(land_eez_map_centroid_coordinates, by = c("flag" = "flag", "region" = "region")) %>%
  left_join(eez_map_centroid_coordinates, by = c("eez_code" = "eez_code", "region" = "region"))
  
flag_state_mapping_wlines <- flag_state_mapping %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>% 
  bind_cols(flag_state_mapping) %>%
  select(everything(), geometry) %>% 
  st_segmentize(units::set_units(100,km)) %>% 
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326) %>%
  mutate(fishing_KWh = round(fishing_KWh, digits = 4))

st_write(flag_state_mapping_wlines, dsn = paste0(flag_state_results_dir, "flag_state_mapping_with_lines.shp"),  delete_dsn=TRUE, driver = "ESRI Shapefile")

}
```

We then make our connectivity maps and subsidy plots for each of our top ranked flag states. 

```{r}
if(run_flag_state){
  
## For loop to run top X countries
for(i in 1:length(top_flag_states)){
   
### Step 1: Flag state connectivity data
# Pull connectivity data for only our flag state of interest
flag_dat <- flag_state_mapping_wlines %>%
  dplyr::filter(flag == top_flag_states[i]) 

# Write flag state connectivity data
write_csv(flag_dat, path = paste0(flag_state_country_dat_dir, top_flag_states[i], "_flag_state_dat.csv"))

### Step 2: Make connectivity map
# Map
map_plot <- ggplot()+
  geom_sf(data = EEZ_map %>% dplyr::filter(is.na(zone)), fill = NA, color = "grey60", size = 0.1)+ # world EEZs (transparent, light grey border lines)
  geom_sf(data = country_map, fill = "grey2", color = "grey40", size = 0.1)+ # world countries (dark grey, white border lines)
  geom_sf(data = country_map %>% dplyr::filter(iso3 == top_flag_states[i]), fill = "darkmagenta", color = "grey40", size = 0.1) + # highlighted flag state (magenta, white border lines)
  geom_sf(data = EEZ_map %>% dplyr::filter(iso_tr1 == top_flag_states[i]), fill = NA, alpha = 0.5, color = NA, size = 0.1) +
  geom_sf(data = EEZ_map %>% dplyr::filter(mrgid %in% flag_dat$eez_code), fill = "slateblue", alpha = 0.5, color = NA, size = 0.1) + # highlighted EEZs (slate blue)
  geom_sf(data = flag_dat, col = "darkgoldenrod", size = 0.25) + 
  maptheme+
  coord_sf(xlim = c(-180,180), ylim = c(-90,90))+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))

# Save map
ggsave(map_plot, filename = paste0(flag_state_figures_dir, top_flag_states[i], "_flag_state_map.png"), width = 10, units = "in")

# Combine map into a one page pdf
sfg_logo_white <- readPNG(here::here("common", "sfg-logo-white.png"))
logo_white <- rasterGrob(sfg_logo_white, interpolate=TRUE, vjust = 0.8, hjust = 0.6)

title1 <- textGrob(paste0("Global network of distant-water fishing\nFlag state: ", top_flag_states_names[i]), gp = gpar(fontsize=16, fontface="bold", lineheight=1, col = "white", fontfamily = "Helvetica"), hjust = 0.55, vjust = 1)

caption1 <- textGrob(paste0("This map shows the global range of distant-water fishing effort for vessels flagged to ", top_flag_states_names[i], ". Lines connect the flag state (pink) \nwith all foreign EEZs (blue) in which vessels flagged to that state fished in 2018. Data were taken from Global Fishing Watch (2018)."), gp = gpar(fontsize = 10, col = "white", fontfamily = "Helvetica"), vjust = 0, hjust = 0.5)

lay1 <- rbind(c(1,4),
              c(2,2),
              c(2,2),
              c(3,3))

# Put together connectivity map
map_page <- grid.arrange(title1, map_plot, caption1, logo_white,
                         layout_matrix = lay1,
                         heights=unit(c(1,1.5,5,1), c("in")), 
                         widths=unit(c(8,3), "in"))
out1 <- cowplot::ggdraw(map_page) + 
  theme(plot.background = element_rect(fill="grey27", color = NA))

# Save connectivity map
ggsave(out1, filename = paste0(flag_state_pdf_dir, top_flag_states[i], "_map_page.pdf"), width = 11, height = 8.5, units = "in")

### Step 3: Make fisheries subsidies summary plot(s) 
# Subsidies by subtype plot
flag_subsidy_dat <- subsidy_dat_ordered %>%
  dplyr::filter(iso3 == top_flag_states[i]) %>%
  na.omit()

if(nrow(flag_subsidy_dat) > 0){
  
  # Filter color scale to only use those for subsidy types represented by that country
  filtered_colors <- myColors[names(myColors) %in% unique(flag_subsidy_dat$type)]
  
  # Make plot
  subsidy_plot <- ggplot(flag_subsidy_dat, aes(x = category, y = value/1e6, fill = type))+
    geom_bar(stat = "identity")+
    scale_fill_manual(name = "Subsidy Type", values = filtered_colors, labels = unique(flag_subsidy_dat$type))+
    theme_bw()+
    coord_flip()+
    scale_y_continuous(expand = c(0,0), labels = scales::comma)+
    labs(x = "", y = "Est. fisheries subsidies (2018 $USD, millions)")
  
  # Save plot as png
  ggsave(subsidy_plot, filename = paste0(flag_state_figures_dir, top_flag_states[i], "_subsidy_plot.png"), width = 10, height = 6, units = "in")
  
  # Make one page pdf of subsidy/other statistics
  sfg_logo_black <- readPNG(here::here("common", "sfg-logo-black.png"))
  logo_black <- rasterGrob(sfg_logo_black, interpolate=TRUE, vjust = 0.8, hjust = 0.6)

  title2 <- textGrob(paste0("Global network of distant-water fishing\nFlag state: ", top_flag_states_names[i]), gp = gpar(fontsize=16, fontface="bold", lineheight=1, col = "black", fontfamily = "Helvetica"), hjust = 0.55, vjust = 1)
  
  dw_summary <- textGrob(
    paste0("Number of distant-water vessels: ", format(flag_state_ranking_top$total_vessels[i], big.mark = ","), 
           "  |  Rank: ", flag_state_ranking_top$vessel_rank[i],
           "\nNumber of EEZs fished: ", length(unique(flag_dat$eez_code)), 
           # "  |  Rank: ", flag_state_combinations_ranking$eez_rank[flag_state_combinations_ranking$flag == top_flag_states[i]],
           "\nTotal distant-water capacity (KW): ", format(round(flag_state_ranking_top$total_capacity[i]), big.mark = ","),
           "  |  Rank: ", flag_state_ranking_top$capacity_rank[i],
           "\nTotal distant-water fishing effort (hours): ", format(round(flag_state_ranking_top$total_fishing_hours[i]), big.mark = ","),
           "  |  Rank: ", flag_state_ranking_top$fishing_hours_rank[i],
           "\nTotal distant-water fishing effort (KWh): ", format(round(flag_state_ranking_top$total_fishing_KWh), big.mark = ","),
           "  |  Rank: ", flag_state_ranking_top$fishing_KWh_rank[i]), just = "left", x = unit(0.14, "npc")
  )

  caption2 <- textGrob(paste0("This figure shows fisheries subsides provided by ", top_flag_states_names[i], " in 2018 $USD. Subsidies are grouped into three types: neutral (purples), capacity-enhancing (reds), \nand beneficial (blues) based on their generalized effects. Data are updated estimates from those found in Sumaila et al. (2016)."), gp = gpar(fontsize = 10, col = "black", fontfamily = "Helvetica"), vjust = 0, hjust = 0.5)

  # Layout matrix
  lay <- rbind(c(1,5),
               c(2,2),
               c(3,3),
               c(4,4))
  
  # Create info/summary page
info_page <- grid.arrange(title2, dw_summary, subsidy_plot, caption2, logo_black, 
                          layout_matrix = lay, 
                          heights = unit(c(1,1.5,5,1), "in"), 
                          widths = unit(c(8,3), "in"))

out2 <- cowplot::ggdraw(info_page) +
  theme(plot.background = element_rect(fill="white", color = NA))

# Save summary page
ggsave(out2, filename = paste0(flag_state_pdf_dir, top_flag_states[i], "_info_page.pdf"), width = 11, height = 8.5, units = "in")
  
# Save both plots into one pdf
  out_flag_state <- marrangeGrob(grobs = list(out1, out2), nrow = 1, ncol = 1, top = NULL)
  
  ggsave(out_flag_state, filename = paste0(flag_state_pdf_dir, top_flag_states[i], "_combined.pdf"), width = 11, height = 8.5, units = "in")
}
}
}
```


## Part 2: Identify top locations of DW fishing by EEZ

If the purpose of the eez analysis is to identify the top `r number_of_top_countries_eez` EEZs in which DW fleets fish, we consider the following metrics:
- Number of fishing vessels partaking in DW fishing
- Total number of DW fishing hours
- Total number of DW fishing KWh

```{r}
if(run_eez){
# Mutate totals by EEZ
EEZ_ranking <- dw_effort_final %>% 
  group_by(eez_code, eez_name, eez_territory_iso3, eez_sovereign_iso3, ssvid) %>%
  summarize(engine_power_kw = unique(engine_power_kw),
            fishing_hours = sum(fishing_hours_year_eez, na.rm = T),
            fishing_KWh = sum(fishing_KWh_year_eez, na.rm = T)) %>%
  ungroup() %>%
  group_by(eez_code, eez_name, eez_territory_iso3, eez_sovereign_iso3) %>%
  summarize(total_vessels = n_distinct(ssvid),
            total_capacity = sum(engine_power_kw, na.rm = T),
            total_fishing_hours = sum(fishing_hours, na.rm = T),
            total_fishing_KWh = sum(fishing_KWh, na.rm = T)) %>% 
  arrange(desc(total_vessels)) %>%
  ungroup() %>%
  mutate(vessel_rank = dense_rank(desc(total_vessels)),
         capacity_rank = dense_rank(desc(total_capacity)),
         fishing_hours_rank = dense_rank(desc(total_fishing_hours)),
         fishing_KWh_rank = dense_rank(desc(total_fishing_KWh))) %>%
  mutate(avg_rank = rowMeans(select(., c(vessel_rank, capacity_rank, fishing_hours_rank, fishing_KWh_rank))))

  # Save
  write_csv(EEZ_ranking, paste0(eez_results_dir, "EEZ_ranking_avg_", analysis_year, ".csv"))

}
```

Alternatively, we may want to run the EEZ analysis for all ACP countries.

```{r}
if(run_eez){
  
# Get codes/name to run anlysis for 
if(eez_purpose == "top_ranked"){
  
  EEZ_ranking_top <- EEZ_ranking %>%
    top_n(-number_of_top_countries_eez, wt = avg_rank)

  analysis_eezs <- EEZ_ranking_top$eez_code
  analysis_eez_territory_iso3 <- EEZ_ranking_top$eez_territory_iso3
  analysis_eez_territory_name <- countrycode(analysis_eez_territory_iso3, "iso3c", "country.name")
  
  ##EEZ combinations for the selected subset
  eez_combinations <- dw_effort_final %>%
    dplyr::filter(eez_code %in% analysis_eezs) %>%
    group_by(eez_code = as.numeric(eez_code), eez_territory_iso3, flag) %>%
    summarize(vessels = n_distinct(ssvid),
              capacity = sum(engine_power_kw, na.rm = T),
              fishing_h = sum(fishing_hours_year_eez, na.rm = T),
              fishing_KWh = sum(fishing_KWh_year_eez, na.rm = T)) %>%
    arrange(eez_code) %>%
    ungroup() %>%
    mutate(region == "Africa")
  
  # Combine with coordinates
  eez_mapping <- eez_combinations %>%
    left_join(eez_map_centroid_coordinates, by = c("eez_code" = "eez_code", "region" = "region")) %>%
    left_join(land_eez_map_centroid_coordinates, by = c("flag" = "flag", "region" = "region")) 
  
   # There are some flag states for which we need to manually assign centroids (mostly small island states not included in the world map because they don't show up)
  # Tuvalu (TUV)
  eez_mapping$flag_lon[eez_mapping$flag == "TUV" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 8326 & eez_map_centroid_coordinates$region == "Africa"]
  eez_mapping$flag_lat[eez_mapping$flag == "TUV" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 8326 & eez_map_centroid_coordinates$region == "Africa"]

  # Réunion (REU)
  eez_mapping$flag_lon[eez_mapping$flag == "REU" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 8338 & eez_map_centroid_coordinates$region == "Africa"]
  eez_mapping$flag_lat[eez_mapping$flag == "REU" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 8338 & eez_map_centroid_coordinates$region == "Africa"]

  # Bonaire, Sint Eustatius and Saba (BES)
  eez_mapping$flag_lon[eez_mapping$flag == "BES" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 26520 & eez_map_centroid_coordinates$region == "Africa"]
  eez_mapping$flag_lat[eez_mapping$flag == "BES" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 26520 & eez_map_centroid_coordinates$region == "Africa"]
  

}else if(eez_purpose == "ACP"){
  
  ACP_codes <- read_csv(here::here("SubsidyAtlasACP", "data", "ACP_eez_codes.csv")) %>% 
    dplyr::select(territory, territory_iso3, mrgid, region) %>%
    dplyr::filter(!is.na(mrgid))
  
  ACP_eez_filter <- EEZ_ranking %>%
    dplyr::filter(eez_code %in% ACP_codes$mrgid)
  
  analysis_eezs <- ACP_eez_filter$eez_code
  analysis_eez_territory_iso3 <- ACP_eez_filter$eez_territory_iso3
  analysis_eez_territory_name <- countrycode(analysis_eez_territory_iso3, "iso3c", "country.name")
  
  ##EEZ combinations for the selected subset
  eez_combinations <- dw_effort_final %>%
    dplyr::filter(eez_code %in% analysis_eezs) %>%
    group_by(eez_code = as.numeric(eez_code), eez_territory_iso3, flag) %>%
    summarize(vessels = n_distinct(ssvid),
              capacity = sum(engine_power_kw, na.rm = T),
              fishing_h = sum(fishing_hours_year_eez, na.rm = T),
              fishing_KWh = sum(fishing_KWh_year_eez, na.rm = T)) %>%
    arrange(eez_code) %>%
    ungroup() %>%
    left_join(ACP_codes %>% dplyr::select(mrgid, region), by = c("eez_code" = "mrgid"))
  
  # Combine with coordinates
  eez_mapping <- eez_combinations %>%
    left_join(eez_map_centroid_coordinates, by = c("eez_code" = "eez_code", "region" = "region")) %>%
    left_join(land_eez_map_centroid_coordinates, by = c("flag" = "flag", "region" = "region")) 
  
  # There are some flag states for which we need to manually assign centroids (mostly small island states not included in the world map because they don't show up)
  # Tuvalu (TUV)
  eez_mapping$flag_lon[eez_mapping$flag == "TUV" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 8326 & eez_map_centroid_coordinates$region == "Africa"]
  eez_mapping$flag_lat[eez_mapping$flag == "TUV" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 8326 & eez_map_centroid_coordinates$region == "Africa"]
   eez_mapping$flag_lon[eez_mapping$flag == "TUV" & eez_mapping$region == "Caribbean"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 8326 & eez_map_centroid_coordinates$region == "Caribbean"]
  eez_mapping$flag_lat[eez_mapping$flag == "TUV" & eez_mapping$region == "Caribbean"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 8326 & eez_map_centroid_coordinates$region == "Caribbean"]
  eez_mapping$flag_lon[eez_mapping$flag == "TUV" & eez_mapping$region == "Pacific"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 8326 & eez_map_centroid_coordinates$region == "Pacific"]
  eez_mapping$flag_lat[eez_mapping$flag == "TUV" & eez_mapping$region == "Pacific"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 8326 & eez_map_centroid_coordinates$region == "Pacific"]

  # Réunion (REU)
  eez_mapping$flag_lon[eez_mapping$flag == "REU" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 8338 & eez_map_centroid_coordinates$region == "Africa"]
  eez_mapping$flag_lat[eez_mapping$flag == "REU" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 8338 & eez_map_centroid_coordinates$region == "Africa"]
  eez_mapping$flag_lon[eez_mapping$flag == "REU" & eez_mapping$region == "Caribbean"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 8338 & eez_map_centroid_coordinates$region == "Caribbean"]
  eez_mapping$flag_lat[eez_mapping$flag == "REU" & eez_mapping$region == "Caribbean"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 8338 & eez_map_centroid_coordinates$region == "Caribbean"]
  eez_mapping$flag_lon[eez_mapping$flag == "REU" & eez_mapping$region == "Pacific"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 8338 & eez_map_centroid_coordinates$region == "Pacific"]
  eez_mapping$flag_lat[eez_mapping$flag == "REU" & eez_mapping$region == "Pacific"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 8338 & eez_map_centroid_coordinates$region == "Pacific"]

  # Bonaire, Sint Eustatius and Saba (BES)
  eez_mapping$flag_lon[eez_mapping$flag == "BES" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 26520 & eez_map_centroid_coordinates$region == "Africa"]
  eez_mapping$flag_lat[eez_mapping$flag == "BES" & eez_mapping$region == "Africa"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 26520 & eez_map_centroid_coordinates$region == "Africa"]
  eez_mapping$flag_lon[eez_mapping$flag == "BES" & eez_mapping$region == "Caribbean"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 26520 & eez_map_centroid_coordinates$region == "Caribbean"]
  eez_mapping$flag_lat[eez_mapping$flag == "BES" & eez_mapping$region == "Caribbean"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 26520 & eez_map_centroid_coordinates$region == "Caribbean"]
  eez_mapping$flag_lon[eez_mapping$flag == "BES" & eez_mapping$region == "Pacific"] <- eez_map_centroid_coordinates$eez_lon[eez_map_centroid_coordinates$eez_code == 26520 & eez_map_centroid_coordinates$region == "Pacific"]
  eez_mapping$flag_lat[eez_mapping$flag == "BES" & eez_mapping$region == "Pacific"] <- eez_map_centroid_coordinates$eez_lat[eez_map_centroid_coordinates$eez_code == 26520 & eez_map_centroid_coordinates$region == "Pacific"]

}

}

```

In order to make our connection plots, we again need the centroids of each EEZ and flag state, which we match to each of our top EEZs, as well as to all flag states from which vessels are fishing in each EEZ.


```{r}
if(run_eez){

if(eez_purpose == "top_ranked"){  
# We then make our lines from each EEZ going to all of the countries fishing there. 
eez_mapping_wlines <- eez_mapping %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>%
  bind_cols(eez_mapping) %>%
  select(everything(), geometry) %>%
  st_segmentize(units::set_units(100,km)) %>%
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>%
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>%
  sf::st_sf(crs = 4326)

st_write(eez_mapping_wlines, dsn = paste0(eez_results_dir, "eez_mapping_with_lines.shp"),  delete_dsn=TRUE, driver = "ESRI Shapefile")

}else if(eez_purpose == "ACP"){

eez_mapping_wlines_africa <- eez_mapping %>%
  dplyr::filter(region == "Africa") %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>% 
  bind_cols(eez_mapping %>% dplyr::filter(region == "Africa")) %>%
  select(everything(), geometry) %>% 
  st_segmentize(units::set_units(100,km)) %>% 
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326) 

eez_mapping_wlines_caribbean <- eez_mapping %>%
  dplyr::filter(region == "Caribbean") %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>% 
  bind_cols(eez_mapping %>% dplyr::filter(region == "Caribbean")) %>%
  select(everything(), geometry) %>% 
  st_segmentize(units::set_units(100,km)) %>% 
  mutate(geometry = (geometry + c(-100,90)) %% c(360) - c(260,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=100"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326) 

eez_mapping_wlines_pacific <- eez_mapping %>%
  dplyr::filter(region == "Pacific") %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>% 
  bind_cols(eez_mapping %>% dplyr::filter(region == "Pacific")) %>%
  select(everything(), geometry) %>% 
  st_segmentize(units::set_units(100,km)) %>% 
  mutate(geometry = (geometry + c(360,90)) %% c(360) - c(0,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=360"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326) 


eez_mapping_wlines <- eez_mapping_wlines_africa %>%
  rbind(eez_mapping_wlines_caribbean) %>%
  rbind(eez_mapping_wlines_pacific)


st_write(eez_mapping_wlines, dsn = paste0(eez_results_dir, "eez_mapping_with_lines.shp"),  delete_dsn=TRUE, driver = "ESRI Shapefile")
st_write(eez_mapping_wlines, dsn = paste0(eez_results_app_dir, "eez_mapping_with_lines.shp"),  delete_dsn=TRUE, driver = "ESRI Shapefile")

}
}
```

We first need to make the connectivity maps... 

```{r}
if(run_eez){
  
  eez_loop_iso3 <- unique(analysis_eez_territory_iso3)
  eez_loop_names <- unique(analysis_eez_territory_name)

## For loop to run top EEZs
for(i in 55:length(eez_loop_iso3)){
  
run_eez_codes <- analysis_eezs[which(analysis_eez_territory_iso3 == eez_loop_iso3[i])]

eez_dat <- eez_mapping_wlines %>%
  dplyr::filter(eez_territory_iso3 == eez_loop_iso3[i]) 

# Write EEZ data
write_csv(eez_dat, path = paste0(eez_dat_dir, eez_loop_iso3[i], "_EEZ_dat.csv"))

# Make EEZ connection plot
eez_map <- ggplot()+
  geom_sf(data = EEZ_map %>% dplyr::filter(is.na(zone)), fill = NA, color = "grey60", size = 0.1)+ # world EEZs (transparent, light grey border lines)
  geom_sf(data = country_map, fill = "grey2", color = "grey40", size = 0.1)+ # world countries (dark grey, white border lines)
  geom_sf(data = country_map %>% dplyr::filter(iso3 %in% eez_dat$flag), fill = "darkmagenta", color = "grey40", size = 0.1) + # highlighted flag state (magenta, grey border lines)
  geom_sf(data = EEZ_map %>% dplyr::filter(mrgid %in% run_eez_codes), fill = "slateblue", alpha = 0.5, color = NA, size = 0.1) + # highlighted EEZs (slate blue)
  geom_sf(data = eez_dat, col = "darkgoldenrod", size = 0.25) +
  maptheme+
  coord_sf(xlim = c(-180,180), ylim = c(-90,90))+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))

#plot_map pngs
ggsave(eez_map, filename = paste0(eez_figures_dir, eez_loop_iso3[i], "_EEZ_connectivity_map.png"), width = 10, units = "in")

# Combine map into a one page pdf
title3 <- textGrob(paste0("Global network of distant-water fishing\nEEZ: ", eez_loop_names[i]), gp = gpar(fontsize=16, fontface="bold", lineheight=1, col = "white", fontfamily = "Helvetica"), hjust = 0.55, vjust = 1)

caption3 <- textGrob(paste0("This map shows the global origins of distant-water vessels fishing in the EEZ of", eez_loop_names[i], ". Lines connect the EEZ (blue) \nwith all foreign countries (pink) from which vessels fishing in that EEZ in 2018 are flagged. Data were taken from Global Fishing Watch (2018)."), gp = gpar(fontsize = 10, col = "white", fontfamily = "Helvetica"), vjust = 0, hjust = 0.5)

lay3 <- rbind(c(1,4),
              c(2,2),
              c(2,2),
              c(3,3))

# Put together connectivity map
eez_page <- grid.arrange(title3, eez_map, caption3, logo_white, 
                         layout_matrix = lay3,
                         heights=unit(c(1,1.5,5,1), c("in")), 
                         widths=unit(c(8.25,2.75), "in"))
out3 <- cowplot::ggdraw(eez_page) + 
  theme(plot.background = element_rect(fill="grey27", color = NA))

# Save connectivity map
ggsave(out3, filename = paste0(eez_pdf_dir, eez_loop_iso3[i], "_map_page.pdf"), width = 11, height = 8.5, units = "in")

### Step 2 - make heat maps
eezmaptheme <- theme_minimal()+
  theme(plot.background = element_rect(fill = "grey27", color = NA),
        panel.background = element_rect(fill = "grey27", color = NA),
        panel.grid.major = element_line(colour = "grey27"),
        text = element_text(color = "white"),
        plot.title = element_text(hjust = 0.5),
        panel.border = element_rect(color = "white", fill = NA),
        plot.margin = margin(t = 0, r = 0.1, b = 0, l = 0, unit = "cm"),
        legend.margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm"),
        legend.position = "bottom",
        legend.box = "horizontal",
        axis.text = element_text(color = "white"))

# Pull data from GFW if necessary
 if(rerun_gfw == T){
   
    # What bin size do we want to use (degrees)?  
    bin_size <- 0.1
    
    # Voodoo to deal with some territories having multiple EEZs
    if(length(run_eez_codes) > 1){
      run_eez_codes_string <- toString(sprintf("'%s'", run_eez_codes))
      run_eez_text <- paste0("eez_code IN (", run_eez_codes_string, ")")
    }else {
      run_eez_codes_string <- run_eez_codes
      run_eez_text <- paste0("eez_code = '", run_eez_codes_string, "'")
      
    }
    
sql4 <- paste0(
  "WITH
  eez_lookup AS (
    SELECT
      CAST(eez_id AS string) eez_code,
      territory1_iso3 eez_territory_iso3
    FROM
      `world-fishing-827.gfw_research.eez_info`),

  selected_vi AS (
    SELECT
       year,
       ssvid,
       engine_power_kw,
       flag
    FROM
       `ucsb-gfw.subsidy_atlas.FINAL_dw_effort_by_eez_", analysis_year, "`),
   
  eez_info AS (
     SELECT
       EXTRACT(year FROM _partitiontime) year,
       if(ARRAY_LENGTH(regions.eez)=0, '0000', regions.eez[ordinal(1)]) eez_code,
       ssvid,
       FLOOR(lat/", bin_size,") * ", bin_size, " + ", bin_size/2, " AS lat_cen,
       FLOOR(lon/", bin_size, ") * ", bin_size, " + ", bin_size/2, " AS lon_cen,
       SUM(hours) AS fishing_hours
     FROM
       `world-fishing-827.gfw_research.pipe_production_b_fishing`
     WHERE
       nnet_score2 > .5
       AND seg_id IN (
          SELECT
            seg_id
          FROM
            `world-fishing-827.gfw_research.pipe_production_b_segs`
          WHERE
            good_seg)
    GROUP BY
      year,
      eez_code,
      ssvid,
      lat_cen,
      lon_cen
    HAVING
      year = ", analysis_year, 
      " AND ", run_eez_text, ")
      
 SELECT
    a.year,
    eez_code,
    eez_territory_iso3,
    flag,
    lat_cen,
    lon_cen,
    SUM(a.fishing_hours) as fishing_hours,
    SUM(a.fishing_hours * b.engine_power_kw) as fishing_KWh,
    SUM(a.fishing_hours * b.engine_power_kw * c.subs_per_fishing_KWh) as subs
  FROM
    eez_info a
  RIGHT JOIN
    selected_vi b
  USING
    (year,
    ssvid)
  LEFT JOIN
    `ucsb-gfw.subsidy_atlas.subsidy_rates_flag` c
  USING
    (flag)
  LEFT JOIN
    eez_lookup
  USING
    (eez_code)
  GROUP BY
    year,
    eez_code,
    eez_territory_iso3,
    flag,
    lat_cen,
    lon_cen
  HAVING
    fishing_hours > 1"
  )

  eez_table <- bq_table(project = bq_project, table = paste0("fishing_effort_", eez_loop_iso3[i]), dataset = "subsidy_atlas") 

  if(bq_table_exists(eez_table) == FALSE){
    bq_table(project = bq_project, table = paste0("fishing_effort_", eez_loop_iso3[i]), dataset = "subsidy_atlas") %>%
      bq_table_create()
  }else{
    bq_table(project = bq_project, table = paste0("fishing_effort_", eez_loop_iso3[i]), dataset = "subsidy_atlas") %>%
      bq_table_delete()
  }

  eez_effort <- bq_project_query(bq_project, sql4, destination_table = bq_table(project = bq_project, table = paste0("fishing_effort_", eez_loop_iso3[i]), dataset = "subsidy_atlas"), use_legacy_sql = FALSE, allowLargeResults = TRUE) %>%
    bq_table_download(max_results = Inf)

  write_csv(eez_effort, path = paste0(eez_dat_dir, eez_loop_iso3[i], "_EEZ_effort_subs_by_flag.csv"))
  
  write_csv(eez_effort, path = paste0(eez_results_app_dir, eez_loop_iso3[i], "_EEZ_effort_subs_by_flag.csv"))

  # Load local data instead of rerunning global fishing watch pull 
  } else{
  
  eez_effort <- read_csv(paste0(eez_results_app_dir, eez_loop_iso3[i], "_EEZ_effort_subs_by_flag.csv"), col_types = "iccnnnnn")
    
  }

  ### Make Plots 
  # Get quantiles of data for scale limits
  eez_effort_aggregated <- eez_effort %>%
    group_by(year, eez_territory_iso3, lon_cen, lat_cen) %>%
    summarize(fishing_hours = sum(fishing_hours, na.rm = T),
              fishing_KWh = sum(fishing_KWh, na.rm = T),
              subs = sum(subs, na.rm = T)) %>%
    mutate(subsidy_intensity = subs/fishing_KWh)
  
    # Set map limits for filtering global country map and eez map appropriately
  x_lim <- c(min(eez_effort_aggregated$lon_cen) - 0.5, max(eez_effort_aggregated$lon_cen) + 0.5)
  y_lim <- c(min(eez_effort_aggregated$lat_cen) - 0.5, max(eez_effort_aggregated$lat_cen) + 0.5)
  
  # Quantiles
  if(length(unique(eez_effort_aggregated$subsidy_intensity)) <= 1){
    
  # Map of subsidy intensity
  eez_subsidy_plot <- ggplot()+
    geom_sf(data = EEZ_map %>% dplyr::filter(is.na(zone)), fill = NA, color = "grey60", size = 0.5)+ # world EEZs (transparent, light grey border lines)
    geom_sf(data = country_map, fill = "grey2", color = "grey40", size = 0.5)+ # world countries (dark grey, white border lines)
    geom_raster(data = eez_effort_aggregated, aes(x = lon_cen, y = lat_cen, fill = subsidy_intensity))+
    eezmaptheme +
    scale_fill_viridis_c(na.value = NA, name = "Subsidy intensity \n(2018 $USD/KWh)", 
                         oob=scales::squish)+
    labs(x = "", y = "")+
    coord_sf(xlim = x_lim, ylim = y_lim)+
    guides(fill = guide_colorbar(title.position = "bottom", title.hjust = 0.5, barwidth = 18))+
    scale_x_continuous(expand = c(0,0))+
    scale_y_continuous(expand = c(0,0))
    
  }else{
    
    intensity_quantile <- quantile(eez_effort_aggregated$subsidy_intensity, probs = c(0.01, 0.05, 0.95, 0.99), na.rm = T)
  scale_labels <- round(seq(round(intensity_quantile[1], 1), round(intensity_quantile[4], 1), length.out = 5), 1)
  
   # Map of subsidy intensity
  eez_subsidy_plot <- ggplot()+
    geom_sf(data = EEZ_map %>% dplyr::filter(is.na(zone)), fill = NA, color = "grey60", size = 0.5)+ # world EEZs (transparent, light grey border lines)
    geom_sf(data = country_map, fill = "grey2", color = "grey40", size = 0.5)+ # world countries (dark grey, white border lines)
    geom_raster(data = eez_effort_aggregated, aes(x = lon_cen, y = lat_cen, fill = subsidy_intensity))+
    eezmaptheme +
    scale_fill_viridis_c(na.value = NA, name = "Subsidy intensity \n(2018 $USD/KWh)", 
                         limits=c(round(intensity_quantile[1],1)-round(intensity_quantile[1],1)*0.01, round(intensity_quantile[4], 1) + round(intensity_quantile[4], 1)*0.01), 
                         labels=scale_labels,
                         breaks=scale_labels,
                         oob=scales::squish)+
    labs(x = "", y = "")+
    coord_sf(xlim = x_lim, ylim = y_lim)+
    guides(fill = guide_colorbar(title.position = "bottom", title.hjust = 0.5, barwidth = 18))+
    scale_x_continuous(expand = c(0,0))+
    scale_y_continuous(expand = c(0,0))
    
  }
  
  ggsave(eez_subsidy_plot, filename = paste0(eez_figures_dir, eez_loop_iso3[i], "_EEZ_subsidy_map.png"), width = 10, units = "in")
  
  # Labels for the log scale 
  eez_effort_plot <- ggplot()+
    geom_sf(data = EEZ_map %>% dplyr::filter(is.na(zone)), fill = NA, color = "grey60", size = 0.5)+ # world EEZs (transparent, light grey border lines)
    geom_sf(data = country_map, fill = "grey2", color = "grey40", size = 0.5)+ # world countries (dark grey, white border lines)
    geom_raster(data = eez_effort_aggregated, aes(x = lon_cen, y = lat_cen, fill = fishing_KWh))+
    eezmaptheme +
    scale_fill_viridis_c(na.value = NA, option = "A", name = "Fishing effort \n(KWh)", trans = log10_trans(), labels = comma)+
    labs(x = "", y = "")+
    coord_sf(xlim = x_lim, ylim = y_lim) +
    guides(fill = guide_colorbar(title.position = "bottom", title.hjust = 0.5, barwidth = 18))+
    scale_x_continuous(expand = c(0,0))+
    scale_y_continuous(expand = c(0,0))
  
  ggsave(eez_effort_plot, filename = paste0(eez_figures_dir, eez_loop_iso3[i], "_EEZ_effort_map.png"), width = 10, units = "in")

  # Combined plot  
  logo_white2 <- rasterGrob(sfg_logo_white, interpolate=TRUE, vjust = 0.8, hjust = 0.3)
  
title4 <- textGrob(paste0("Global network of distant-water fishing\nEEZ: ", eez_loop_names[i]), gp = gpar(fontsize=16, fontface="bold", lineheight=1, col = "white", fontfamily = "Helvetica"), hjust = 0.55, vjust = 1)

caption4 <- textGrob(paste0("These maps show distant-water fishing effort (left, KWh) and subsidy intensity (right, 2018 $USD/KWh) in the EEZ of ", eez_loop_names[i], ". \nBoth fishing effort and subsidy intensity are aggregated by 0.1 degree latitude/longitude. Data were taken from Global Fishing Watch (2018)."), gp = gpar(fontsize = 10, col = "white", fontfamily = "Helvetica"), vjust = 0, hjust = 0.5)

  if(eez_loop_iso3[i] == "RUS"){
    
    lay4 <- rbind(c(1,1,1,5),
              c(NA,NA,NA,NA),
              c(2,2,2,2),
              c(3,3,3,3),
              c(4,4,4,4))
    
    
  } else{
    
    lay4 <- rbind(c(1,1,1,5),
              c(NA,NA,NA,NA),
              c(2,2,3,3),
              c(2,2,3,3),
              c(4,4,4,4))
    
  }

# Put together connectivity map
page4 <- grid.arrange(title4, eez_effort_plot, eez_subsidy_plot, caption4, logo_white, 
                         layout_matrix = lay4,
                         heights=unit(c(1,0.5,3,3,1), c("in")),
                         widths=unit(c(2.75,2.75,2.75,2.75), "in"))
out4 <- cowplot::ggdraw(page4) + 
  theme(plot.background = element_rect(fill="grey27", color = NA))

# Save connectivity map
ggsave(out4, filename = paste0(eez_pdf_dir, eez_loop_iso3[i], "_effort_page.pdf"), width = 11, height = 8.5, units = "in")

# Save both plots into one pdf
  out_eez <- marrangeGrob(grobs = list(out3, out4), nrow = 1, ncol = 1, top = NULL)
  
  ggsave(out_eez, filename = paste0(eez_pdf_dir, eez_loop_iso3[i], "_combined.pdf"), width = 11, height = 8.5, units = "in")

}
}
```
