---
output:
  html_document: default

title: "Atlas of distant water fishing - Flag state analysis"
author: "Matthew Warham, Kat Millage"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

# Introduction

This script uses previously compiled information on fishing effort from Global Fishing Watch for distant water fishing vessels. The top flag states with distant water fishing fleets are then identified.  

```{r setup, include=FALSE}
# Chunk options
knitr::opts_chunk$set(echo = TRUE)

### Load packages ------
library(sf) # spatial manipulation
library(lwgeom) # needed for curved lines
library(here) # path names
library(knitr) # knit document
library(bigrquery) # access GFW data
library(DBI) # access GFW data
library(countrycode) # country names 
library(tidyverse) # data manipulation
#library(ggalt) # transform to robinson projection
library(RColorBrewer) # custom color palettes
library(scales) # scales for plotting
library(ggpubr) # plot arranging
library(gridExtra)
library(grid)
library(png)

### Set run options -----
# Set purpose of the flag state analysis (currently the only choice is "top_ranked")
flag_state_purpose <- "top_ranked"
# Number of flag_states to include (if purpose is "top_ranked", defaults to 10)
number_of_top_countries_flag <- 20

# Connection to BigQuery - need a project for billing
bq_project <-  "ucsb-gfw"

# Choose analysis year (2012 - 2018)
analysis_year <- 2018

# Do you want to make figures?
make_figures <- F

### Load data -----

effort_file <- list.files(path = here::here("results"), pattern = "FINAL_dw_effort_by_eez_2018.csv")

if(length(effort_file) == 0){
  
  # If that file doesn't exist, source the script that creates it. 
  source(here::here("scripts", "dw-vessel-list.Rmd"))
  
}else{
  
  dw_effort_final <- read_csv(paste0(here::here("results/"), effort_file))
  
}

```


```{r}
### Create results directories -----

  # Set general results directory
  results_dir <- here::here("results/")
  if (dir.exists(results_dir) == F) { dir.create(results_dir, recursive = T) }
  
  ## Create flag state results directories
    flag_state_results_dir <- paste0(results_dir, "flag_state_results/", flag_state_purpose, "/")
    if (dir.exists(flag_state_results_dir) == F) { dir.create(flag_state_results_dir, recursive = T) }

    flag_state_country_dat_dir <- paste0(flag_state_results_dir, "country_dat/")
    if (dir.exists(flag_state_country_dat_dir) == F) { dir.create(flag_state_country_dat_dir, recursive = T) }

    flag_state_figures_dir <- paste0(flag_state_results_dir, "figures/")
    if (dir.exists(flag_state_figures_dir) == F) { dir.create(flag_state_figures_dir, recursive = T) }

    flag_state_pdf_dir <- paste0(flag_state_results_dir, "pdfs/")
    if (dir.exists(flag_state_pdf_dir) == F) { dir.create(flag_state_pdf_dir, recursive = T)}
  
```

## Flag state and EEZ centroids 

In order to make our connection plots, we need to find the centroids of each EEZ and flag state so we can create the connectivity lines. For the flag state analysis and the eez analyis for the top ranked EEZs, we're going to use a standard -180 to 180 degree world view for plotting to keep things simple. 

Things get slightly more complicated for the ACP eez analysis because we want to use three different world views for each of the three regions (so the region of interest is centered). Therefore we have created shapefiles that span from -360 to 360 degrees, which we can clip to the appropriate extents for each of our three regions (Africa, Caribbean, and Pacific). For Africa, we've chosen to use a -180 to 180 degree view (so we'll also use this for the flag state analysis and/or the top ranked eez analysis). For the Caribbean, we've chosen to use a -260 to 100 degree view. For the Pacific, we've chosen to use a 0 to 360 degree view. 

For the purposes of plotting the EEZs in which the fishing activity is taking place, we're using a simplified form of the Version 10 shapefile of the Maritime Boundaries - World EEZs from MarineRegions.org. We simplified the shapefile using mapshaper (online at mapshaper.org) to a tolerance of 0.5%. For the purposes of plotting the flag states to which distant water vessels are flagged, we're using the Version 2 shapefile of the Marine and land zones: the union of world country boundaries and EEZs from Marine Regions.org.

```{r}
# For the flag state analysis we're going to use the standard -180 to 180 degree world view
  
  ### EEZs for location of fishing activity -----
  eez_map <- read_sf(dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "World_EEZ_v10_20180221_LR_-360_360"), layer = "eez_v10") %>%
    st_transform(crs = 4326) %>%
    setNames(tolower(names(.))) %>%
    dplyr::select(id = cat,
                  mrgid,
                  geoname,
                  pol_type,
                  territory1,
                  iso3_ter1 = iso_ter1,
                  sovereign1,
                  territory2,
                  iso3_ter2 = iso_ter2,
                  sovereign2,
                  territory3,
                  iso3_ter3 = iso_ter3,
                  sovereign3)
  
  # Africa
  africa_eez_map <- st_crop(eez_map, c(xmin=-180, xmax=180, ymin=-90, ymax=90))
  africa_eez_map_centroids <- africa_eez_map %>%
    st_centroid() %>%
    dplyr::select(eez_code = mrgid, eez_name = geoname, geometry) %>%
    mutate(region = "Africa")
  
  
  eez_map_centroids <- africa_eez_map
  
  # Put centroids in lon/lat columns
  eez_map_centroid_coordinates <- tibble(eez_code = eez_map_centroids$eez_code,
                                         eez_name = eez_map_centroids$eez_name,
                                         region = eez_map_centroids$region) %>% 
    bind_cols(do.call(rbind, st_geometry(eez_map_centroids)) %>%
                as_tibble() %>%
                setNames(c("eez_lon", "eez_lat"))) %>%
    arrange(eez_code)
  
  
  ### Combined land/EEZs for flag states -----
  land_eez_map <- read_sf(dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "EEZ_land_v2_201410_-360_360"), layer = "EEZ_land_v2_201410_-360_360") %>%
    st_transform(crs = 4326) %>%
    setNames(tolower(names(.))) %>%
    dplyr::select(id = objectid,
                  iso3 = iso_3digit,
                  country)
  
  # Africa
  africa_land_eez_map <- st_crop(land_eez_map, c(xmin=-180, xmax=180, ymin=-90, ymax=90))
  africa_land_eez_map_centroids <- africa_land_eez_map %>%
    st_centroid() %>%
    dplyr::select(flag = iso3, flag_name = country, geometry) %>%
    mutate(region = "Africa")
  
  land_eez_map_centroids <- africa_land_eez_map_centroids
  
  # Put centroids in lon/lat columns
  land_eez_map_centroid_coordinates <- tibble(flag = land_eez_map_centroids$flag,
                                              flag_name = land_eez_map_centroids$flag_name,
                                              region = land_eez_map_centroids$region) %>% 
    bind_cols(do.call(rbind, st_geometry(land_eez_map_centroids)) %>%
                as_tibble() %>%
                setNames(c("flag_lon", "flag_lat"))) %>%
    arrange(flag) %>%
    na.omit()
  
   #Manually correct certain centroids
   manual_coordinates_flags <- read_csv(paste0(results_dir, "corrected_flag_centroids.csv"))
   
   land_eez_map_centroid_coordinates <- land_eez_map_centroid_coordinates %>%
     left_join(manual_coordinates_flags, by = c("flag", "region")) %>%
     mutate(flag_lon = ifelse(!is.na(flag_lon_edit), flag_lon_edit, flag_lon),
            flag_lat = ifelse(!is.na(flag_lat_edit), flag_lat_edit, flag_lat)) %>%
     dplyr::select(-flag_lon_edit, -flag_lat_edit)

```

If we're making figures, we also need to do some setup for our figures. 

```{r}
if(make_figures){
  
  # Custom theme for map
  maptheme <- theme_minimal() +
    theme(panel.background = element_rect(fill = "grey27", colour = NA),
          panel.grid.major = element_line(colour = "grey27"),
          panel.border = element_blank(),
          plot.margin = unit(c(0, 0, 0, 0), "mm"),
          plot.background = element_blank(),
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks.length = unit(0, "pt"))
  
  # Custom color palette for Sumaila subsidy types
  goodColors <- rev(brewer.pal(3, "Blues"))
  names(goodColors) <- levels(subsidy_dat_edit$type)[1:3]
  
  badColors <- rev(brewer.pal(7, "Reds"))
  names(badColors) <- levels(subsidy_dat_edit$type)[4:10]
  
  ambigColors <- c("purple", "mediumorchid", "violet")
  names(ambigColors) <- levels(subsidy_dat_edit$type)[11:13]
  
  myColors <- c(goodColors, badColors, ambigColors)
  
}
```

## Part 1: Identify top DW fishing fleets by flag state

Currently, the only option for this part of the analysis is to look at distant water fishing fleets by flag state, ranked according to total distant water fishing effort. 

We first rank flag states with DW fishing fleets based on the following metrics:
- Number of fishing vessels partaking in DW fishing
- Total capacity of fishing vessels partaking of DW fishing
- Total number of DW fishing hours
- Total number of DW fishing KWh 

```{r}
# Mutate totals by flag state for all
flag_state_ranking <- dw_effort_final %>% 
  group_by(flag, ssvid) %>%
  summarize(engine_power_kw = unique(engine_power_kw),
            fishing_hours = sum(fishing_hours_year_eez, na.rm = T),
            fishing_KWh = sum(fishing_KWh_year_eez, na.rm = T)) %>%
  ungroup() %>%
  group_by(flag) %>%
  summarize(total_vessels = n_distinct(ssvid),
            total_capacity = sum(engine_power_kw, na.rm = T),
            total_fishing_hours = sum(fishing_hours, na.rm = T),
            total_fishing_KWh = sum(fishing_KWh, na.rm = T)) %>% 
  arrange(desc(total_vessels)) %>%
  ungroup() %>%
  mutate(vessel_rank = dense_rank(desc(total_vessels)),
         capacity_rank = dense_rank(desc(total_capacity)),
         fishing_hours_rank = dense_rank(desc(total_fishing_hours)),
         fishing_KWh_rank = dense_rank(desc(total_fishing_KWh))) %>%
  mutate(avg_rank = rowMeans(select(., c(vessel_rank, capacity_rank, fishing_hours_rank, fishing_KWh_rank))))

# Save flag states by average ranking
write_csv(flag_state_ranking, paste0(flag_state_results_dir, "flag_state_ranking_", analysis_year, ".csv"))

```

We then identify the top `r number_of_top_countries_flag` flag states. For each of our top flag states, we also identify all EEZs in which DW vessels flagged to that state fish.

```{r}
  # Set defaults in case option isn't correctly specified above
  if(is.na(number_of_top_countries_flag) | !is.numeric(number_of_top_countries_flag)){
    number_of_top_countries_flag <- 10
  }

  flag_state_ranking_top <- flag_state_ranking %>%
    top_n(-number_of_top_countries_flag, wt = avg_rank)
  
  # Get iso3 codes for selected flag states 
  top_flag_states <- flag_state_ranking_top$flag

  top_flag_states_names <- (tibble(flag = top_flag_states) %>%
    mutate(name = countrycode::countrycode(flag, "iso3c", "country.name")))$name

  flag_state_combinations <- dw_effort_final %>%
    dplyr::filter(flag %in% top_flag_states) %>%
    group_by(flag, eez_code = as.numeric(eez_code)) %>%
    summarize(vessels = n_distinct(ssvid),
              capacity = sum(engine_power_kw, na.rm = T),
              fishing_h = sum(fishing_hours_year_eez, na.rm = T),
              fishing_KWh = sum(fishing_KWh_year_eez, na.rm = T)) %>%
    arrange(flag) %>%
    ungroup() %>%
    mutate(region == "Africa") # Just so it matches later with the right map

```

We then match the previously obtained centroids to each of our top flag states, as well as all EEZs in which DW vessels from these states fish. 

```{r}
flag_state_mapping <- flag_state_combinations %>%
  left_join(land_eez_map_centroid_coordinates, by = c("flag" = "flag", "region" = "region")) %>%
  left_join(eez_map_centroid_coordinates, by = c("eez_code" = "eez_code", "region" = "region"))
  
flag_state_mapping_wlines <- flag_state_mapping %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>% 
  bind_cols(flag_state_mapping) %>%
  select(everything(), geometry) %>% 
  st_segmentize(units::set_units(100,km)) %>% 
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326) %>%
  mutate(fishing_KWh = round(fishing_KWh, digits = 4))

st_write(flag_state_mapping_wlines, dsn = paste0(flag_state_results_dir, "flag_state_mapping_with_lines.shp"),  delete_dsn=TRUE, driver = "ESRI Shapefile")

```

We then make our connectivity maps and subsidy plots for each of our top ranked flag states. 

```{r}
## For loop to run top X countries
for(i in 1:length(top_flag_states)){
   
### Step 1: Flag state connectivity data
  
# Pull connectivity data for only our flag state of interest
flag_dat <- flag_state_mapping_wlines %>%
  dplyr::filter(flag == top_flag_states[i]) 

# Write flag state connectivity data
write_csv(flag_dat, path = paste0(flag_state_country_dat_dir, top_flag_states[i], "_flag_state_dat.csv"))

if(make_figures){
  
  ### Step 2: Make connectivity map
map_plot <- ggplot()+
  geom_sf(data = EEZ_map %>% dplyr::filter(is.na(zone)), fill = NA, color = "grey60", size = 0.1)+ # world EEZs (transparent, light grey border lines)
  geom_sf(data = country_map, fill = "grey2", color = "grey40", size = 0.1)+ # world countries (dark grey, white border lines)
  geom_sf(data = country_map %>% dplyr::filter(iso3 == top_flag_states[i]), fill = "darkmagenta", color = "grey40", size = 0.1) + # highlighted flag state (magenta, white border lines)
  geom_sf(data = EEZ_map %>% dplyr::filter(iso_tr1 == top_flag_states[i]), fill = NA, alpha = 0.5, color = NA, size = 0.1) +
  geom_sf(data = EEZ_map %>% dplyr::filter(mrgid %in% flag_dat$eez_code), fill = "slateblue", alpha = 0.5, color = NA, size = 0.1) + # highlighted EEZs (slate blue)
  geom_sf(data = flag_dat, col = "darkgoldenrod", size = 0.25) + 
  maptheme+
  coord_sf(xlim = c(-180,180), ylim = c(-90,90))+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))

# Save map
ggsave(map_plot, filename = paste0(flag_state_figures_dir, top_flag_states[i], "_flag_state_map.png"), width = 10, units = "in")

# Combine map into a one page pdf
sfg_logo_white <- readPNG(here::here("common", "sfg-logo-white.png"))
logo_white <- rasterGrob(sfg_logo_white, interpolate=TRUE, vjust = 0.8, hjust = 0.6)

title1 <- textGrob(paste0("Global network of distant-water fishing\nFlag state: ", top_flag_states_names[i]), gp = gpar(fontsize=16, fontface="bold", lineheight=1, col = "white", fontfamily = "Helvetica"), hjust = 0.55, vjust = 1)

caption1 <- textGrob(paste0("This map shows the global range of distant-water fishing effort for vessels flagged to ", top_flag_states_names[i], ". Lines connect the flag state (pink) \nwith all foreign EEZs (blue) in which vessels flagged to that state fished in 2018. Data were taken from Global Fishing Watch (2018)."), gp = gpar(fontsize = 10, col = "white", fontfamily = "Helvetica"), vjust = 0, hjust = 0.5)

lay1 <- rbind(c(1,4),
              c(2,2),
              c(2,2),
              c(3,3))

# Put together connectivity map
map_page <- grid.arrange(title1, map_plot, caption1, logo_white,
                         layout_matrix = lay1,
                         heights=unit(c(1,1.5,5,1), c("in")), 
                         widths=unit(c(8,3), "in"))
out1 <- cowplot::ggdraw(map_page) + 
  theme(plot.background = element_rect(fill="grey27", color = NA))

# Save connectivity map
ggsave(out1, filename = paste0(flag_state_pdf_dir, top_flag_states[i], "_map_page.pdf"), width = 11, height = 8.5, units = "in")

### Step 3: Make fisheries subsidies summary plot(s) 
# Subsidies by subtype plot
flag_subsidy_dat <- subsidy_dat_ordered %>%
  dplyr::filter(iso3 == top_flag_states[i]) %>%
  na.omit()

if(nrow(flag_subsidy_dat) > 0){
  
  # Filter color scale to only use those for subsidy types represented by that country
  filtered_colors <- myColors[names(myColors) %in% unique(flag_subsidy_dat$type)]
  
  # Make plot
  subsidy_plot <- ggplot(flag_subsidy_dat, aes(x = category, y = value/1e6, fill = type))+
    geom_bar(stat = "identity")+
    scale_fill_manual(name = "Subsidy Type", values = filtered_colors, labels = unique(flag_subsidy_dat$type))+
    theme_bw()+
    coord_flip()+
    scale_y_continuous(expand = c(0,0), labels = scales::comma)+
    labs(x = "", y = "Est. fisheries subsidies (2018 $USD, millions)")
  
  # Save plot as png
  ggsave(subsidy_plot, filename = paste0(flag_state_figures_dir, top_flag_states[i], "_subsidy_plot.png"), width = 10, height = 6, units = "in")
  
  # Make one page pdf of subsidy/other statistics
  sfg_logo_black <- readPNG(here::here("common", "sfg-logo-black.png"))
  logo_black <- rasterGrob(sfg_logo_black, interpolate=TRUE, vjust = 0.8, hjust = 0.6)

  title2 <- textGrob(paste0("Global network of distant-water fishing\nFlag state: ", top_flag_states_names[i]), gp = gpar(fontsize=16, fontface="bold", lineheight=1, col = "black", fontfamily = "Helvetica"), hjust = 0.55, vjust = 1)
  
  dw_summary <- textGrob(
    paste0("Number of distant-water vessels: ", format(flag_state_ranking_top$total_vessels[i], big.mark = ","), 
           "  |  Rank: ", flag_state_ranking_top$vessel_rank[i],
           "\nNumber of EEZs fished: ", length(unique(flag_dat$eez_code)), 
           # "  |  Rank: ", flag_state_combinations_ranking$eez_rank[flag_state_combinations_ranking$flag == top_flag_states[i]],
           "\nTotal distant-water capacity (KW): ", format(round(flag_state_ranking_top$total_capacity[i]), big.mark = ","),
           "  |  Rank: ", flag_state_ranking_top$capacity_rank[i],
           "\nTotal distant-water fishing effort (hours): ", format(round(flag_state_ranking_top$total_fishing_hours[i]), big.mark = ","),
           "  |  Rank: ", flag_state_ranking_top$fishing_hours_rank[i],
           "\nTotal distant-water fishing effort (KWh): ", format(round(flag_state_ranking_top$total_fishing_KWh), big.mark = ","),
           "  |  Rank: ", flag_state_ranking_top$fishing_KWh_rank[i]), just = "left", x = unit(0.14, "npc")
  )

  caption2 <- textGrob(paste0("This figure shows fisheries subsides provided by ", top_flag_states_names[i], " in 2018 $USD. Subsidies are grouped into three types: neutral (purples), capacity-enhancing (reds), \nand beneficial (blues) based on their generalized effects. Data are updated estimates from those found in Sumaila et al. (2016)."), gp = gpar(fontsize = 10, col = "black", fontfamily = "Helvetica"), vjust = 0, hjust = 0.5)

  # Layout matrix
  lay <- rbind(c(1,5),
               c(2,2),
               c(3,3),
               c(4,4))
  
  # Create info/summary page
info_page <- grid.arrange(title2, dw_summary, subsidy_plot, caption2, logo_black, 
                          layout_matrix = lay, 
                          heights = unit(c(1,1.5,5,1), "in"), 
                          widths = unit(c(8,3), "in"))

out2 <- cowplot::ggdraw(info_page) +
  theme(plot.background = element_rect(fill="white", color = NA))

# Save summary page
ggsave(out2, filename = paste0(flag_state_pdf_dir, top_flag_states[i], "_info_page.pdf"), width = 11, height = 8.5, units = "in")
  
# Save both plots into one pdf
  out_flag_state <- marrangeGrob(grobs = list(out1, out2), nrow = 1, ncol = 1, top = NULL)
  
  ggsave(out_flag_state, filename = paste0(flag_state_pdf_dir, top_flag_states[i], "_combined.pdf"), width = 11, height = 8.5, units = "in")
  
  
}

}
}
```


