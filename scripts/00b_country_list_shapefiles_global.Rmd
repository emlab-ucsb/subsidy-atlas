---
output:
  html_document: default

title: "Distant Water Fishing Atlas - Country List & Shapefile Creation"
author: "Kat Millage, Matt Warham"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

# Introduction

This script creates the global country list used in the Distant Water Fishing Atlas, as well as all necessary shapefiles used in the tool. This relies upon the following data sources: 
- Flanders Marine Institute (2019). Maritime Boundaries Geodatabase: Maritime Boundaries and Exclusive Economic Zones (200NM), version 11. Available online at https://www.marineregions.org/. https://doi.org/10.14284/386


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### Load packages ------
library(sf) # spatial manipulation
library(here) # path names
library(knitr) # knit document
library(countrycode) # country names 
library(janitor)
library(mapview)
library(rmapshaper)
library(tidyverse) # data manipulation

### Create results directories
data_dir <- here::here("data/edited/")
  if (dir.exists(data_dir) == F) { dir.create(data_dir, recursive = T) }

### Also save to app data directory
app_dir <- here::here("app-global/data/")
  if (dir.exists(app_dir) == F) { dir.create(app_dir, recursive = T) }
```

# Marine Regions EEZs (v11) GeoPackage

## Simplify polygons

```{r}
# Load dataset
# eez_path <- here::here("data/raw/World_EEZ_v11_20191118_gpkg/eez_v11.gpkg")
# eez_sf <- st_read(eez_path) %>%
#   clean_names()
# 
# # Simplify polygons to make working with them easier and faster - we don't need high resolution
# eez_sf_simple <- st_make_valid(rmapshaper::ms_simplify(eez_sf, keep_shapes = TRUE, keep = 0.01))
# 
# # Save simplified object so this chunk doesn't have to be run every time
# st_write(eez_sf_simple, paste0(data_dir, "world_eez_v11_simple.gpkg"), delete_layer = T)

```

## Create sovereign country list and designate all EEZs

```{r}
eez_sf_simple <- st_read(paste0(data_dir, "world_eez_v11_simple.gpkg")) %>%
  st_set_crs(4326)
```

```{r}
# Extract attributes we want to keep
eez_attrib_all <- eez_sf_simple %>%
  st_drop_geometry() %>%
  rowwise() %>%
  mutate(iso_ter_all = list(c(iso_ter1, iso_ter2, iso_ter3)),
         iso_sov_all = list(c(iso_sov1, iso_sov2, iso_sov3))) %>%
  dplyr::select(mrgid, pol_type, geoname, iso_ter_all, iso_sov_all)

# Create some new country names
eez_attrib_expanded <- eez_attrib_all %>%
  unnest(cols = c("iso_ter_all", "iso_sov_all")) %>%
  mutate(iso_ter = ifelse(!is.na(iso_ter_all), iso_ter_all, iso_sov_all)) %>%
  dplyr::filter(!is.na(iso_ter)) %>%
  mutate(name_ter = countrycode(iso_ter, "iso3c", 'country.name.en'),
         name_sov = countrycode(iso_sov_all, "iso3c", 'country.name.en'),
         region = countrycode(iso_ter, "iso3c", "region"))

# region, continent, un.region.name
eez_attrib_expanded <- eez_attrib_expanded %>%
  mutate(region_custom = case_when(iso_ter == "ATA" ~ "NA",
                                   iso_ter == "ATF" ~ "Sub-Saharan Africa",
                                   iso_ter == "ESH" ~ "Middle East & North Africa",
                                   iso_ter == "MYT" ~ "Sub-Saharan Africa",
                                   iso_ter == "REU" ~ "Sub-Saharan Africa",
                                   iso_ter == "SHN" ~ "Sub-Saharan Africa",
                                   iso_ter == "SJM" ~ "Europe & Central Asia",
                                   iso_ter == "UMI" ~ "East Asia & Pacific",
                                   iso_ter == "WLF" ~ "East Asia & Pacific",
                                   TRUE ~ region)) %>%
  dplyr::select(-region, -iso_ter_all) %>%
  rename(iso_sov = iso_sov_all,
         region = region_custom) %>%
  arrange(region, name_ter)

write_csv(eez_attrib_expanded, paste0(data_dir, "eez_attributes_expanded.csv"))
write_csv(eez_attrib_expanded, paste0(app_dir, "eez_attributes_expanded.csv"))
```


## Create expanded version of polygons (-360 to 360 degrees)

Because we are going to center different pages of our app on different regions, we want to make an duplicated polygon object that ranges from -360 to 360 degrees. 

```{r}
# Make left duplicate (-540, -180)
eez_sf_left <- (st_geometry(eez_sf_simple) - c(360, 0)) %>%
  st_set_crs(4326)

# Make right duplicate (180 - 540)
eez_sf_right <- (st_geometry(eez_sf_simple) + c(360, 0)) %>%
  st_set_crs(4326)

# Assign geometry
eez_sf_left <- st_set_geometry(eez_sf_simple, eez_sf_left)
eez_sf_right <- st_set_geometry(eez_sf_simple, eez_sf_right)

# Combine
eez_sf_all <- eez_sf_simple %>%
  rbind(eez_sf_left) %>% 
  rbind(eez_sf_right) %>%
  st_make_valid() %>%
  group_by(mrgid) %>%
  summarize(a = 1) %>%
  ungroup() %>%
  dplyr::select(-a)

# Crop
eez_sf_crop <- eez_sf_all %>%
  st_crop(xmin = -360, ymin = -90, xmax = 360, ymax = 90)

# Keep only multipolygons
eez_sf_polygon <- st_collection_extract(
  eez_sf_crop,
  type = c("POLYGON"),
  warn = FALSE
)

ggplot() + geom_sf(data = eez_sf_polygon, aes(fill = mrgid))

# Save
st_write(eez_sf_polygon, paste0(data_dir, "world_eez_v11_simple_neg360_360.gpkg"), delete_layer = T)

# Save duplicated version
# Add attributes back in there
eez_sf_out <- eez_sf_polygon %>%
  right_join(eez_attrib_expanded, by = c("mrgid"))

st_write(eez_sf_out, paste0(data_dir, "world_eez_v11_simple_neg360_360_ter_duplicates.gpkg"), delete_layer = T)
st_write(eez_sf_out, paste0(app_dir, "world_eez_v11_simple_neg360_360_ter_duplicates.gpkg"), delete_layer = T)

```

## Create region aggregated polygons for landing page

```{r}
# Regional aggregation
region_sf <- eez_sf_out %>%
  group_by(region) %>%
  summarize(geom = st_union(geom)) %>%
  dplyr::filter(region != "NA")
  
ggplot()+geom_sf(data = region_sf, aes(fill = region))

st_write(region_sf, paste0(data_dir, "world_eez_regions_neg360_360.gpkg"), delete_layer = T)
st_write(region_sf, paste0(app_dir, "world_eez_regions_neg360_360.gpkg"), delete_layer = T)
```

## Create territory aggregated polygons

```{r}
# Territory aggregation (200nm areas only)
territory_sf <- eez_sf_out %>%
  dplyr::filter(pol_type == "200NM") %>%
  #mutate(geoname_simple = str_replace(geoname, "\\([^()]{0,}\\)", ""))
  mutate(geoname_new = paste0("Exclusive Economic Zone: ", name_ter)) %>%
  group_by(region, name_ter, iso_ter, name_sov, iso_sov, pol_type, geoname_new) %>%
  summarize(geom = st_union(geom)) %>%
  ungroup()

others_sf <- eez_sf_out %>%
  dplyr::filter(pol_type != "200NM") %>%
  mutate(geoname_new = geoname) %>%
  dplyr::select(region, name_ter, iso_ter, name_sov, iso_sov, pol_type, geoname_new, geom)

territory_sf_out <- territory_sf %>%
  rbind(others_sf)
  
st_write(territory_sf_out, paste0(data_dir, "world_eez_ter_neg360_360.gpkg"), delete_layer = T)
st_write(territory_sf_out, paste0(app_dir, "world_eez_ter_neg360_360.gpkg"), delete_layer = T)
```

