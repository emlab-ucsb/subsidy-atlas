---
output:
  html_document: default

title: "Atlas of distant water fishing - EEZ analysis"
author: "Matthew Warham, Kat Millage"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

# Introduction

This script uses previously compiled information on fishing effort from Global Fishing Watch for distant water fishing vessels. The top EEZs with distant water fishing activity are then identified (alternatively this analysis can be run for all ACP coastal states).

```{r setup, include=FALSE}
# Chunk options
knitr::opts_chunk$set(echo = TRUE)

### Load packages ------
library(sf) # spatial manipulation
library(lwgeom) # needed for curved lines
library(here) # path names
library(knitr) # knit document
library(bigrquery) # access GFW data
library(DBI) # access GFW data
library(countrycode) # country names 
library(tidyverse) # data manipulation
#library(ggalt) # transform to robinson projection
library(RColorBrewer) # custom color palettes
library(scales) # scales for plotting
library(ggpubr) # plot arranging
library(gridExtra)
library(grid)
library(png)

### Set run options -----
# Set purpose of the EEZ anlysis (choices: "ACP" or "top_ranked", defaults to "top_ranked")
eez_purpose <- "ACP"
# Number of EEZs to include (only necessary if purpose is "top_ranked", defaults to 10)
number_of_top_countries_eez <- 10

# Connection to BigQuery - need a project for billing
bq_project <-  "ucsb-gfw"

# Choose analysis year (2012 - 2018)
analysis_year <- 2018

# Do you want to make figures?
make_figures <- F

### Load data -----

effort_file <- list.files(path = here::here("results"), pattern = "FINAL_dw_effort_by_eez_2018.csv")

if(length(effort_file) == 0){
  
  # If that file doesn't exist, source the script that creates it. 
  source(here::here("scripts", "dw-vessel-list.Rmd"))
  
}else{
  
  dw_effort_final <- read_csv(paste0(here::here("results/"), effort_file))
  
}

```

```{r }
### Create results directories -----

# Set general results directory
  results_dir <- here::here("results/")
  if (dir.exists(results_dir) == F) { dir.create(results_dir, recursive = T) }

# EEZ analysis results directories
  eez_results_dir <- paste0(results_dir, "eez_results/", eez_purpose, "/")
    if (dir.exists(eez_results_dir) == F) { dir.create(eez_results_dir, recursive = T) }
    
    eez_dat_dir <- paste0(eez_results_dir, "dat/")
    if (dir.exists(eez_dat_dir) == F) { dir.create(eez_dat_dir, recursive = T) }

    eez_figures_dir <- paste0(eez_results_dir, "figures/")
    if (dir.exists(eez_figures_dir) == F) { dir.create(eez_figures_dir, recursive = T) }

    eez_pdf_dir <- paste0(eez_results_dir, "pdfs/")
    if (dir.exists(eez_pdf_dir) == F) { dir.create(eez_pdf_dir, recursive = T) }
    
    
    # If EEZ purpose is "ACP", also create a results directory for the app
    if(eez_purpose == "ACP"){
      
      eez_results_app_dir <- paste0(here::here("SubsidyAtlasACP/"), "data/eez_results/", eez_purpose, "/")
      if (dir.exists(eez_results_app_dir) == F) { dir.create(eez_results_app_dir, recursive = T) }
      
    }
```

## Flag state and EEZ centroids 

In order to make our connection plots, we need to find the centroids of each EEZ and flag state so we can create the connectivity lines. For the flag state analysis and the eez analyis for the top ranked EEZs, we're going to use a standard -180 to 180 degree world view for plotting to keep things simple. 

Things get slightly more complicated for the ACP eez analysis because we want to use three different world views for each of the three regions (so the region of interest is centered). Therefore we have created shapefiles that span from -360 to 360 degrees, which we can clip to the appropriate extents for each of our three regions (Africa, Caribbean, and Pacific). For Africa, we've chosen to use a -180 to 180 degree view (so we'll also use this for the flag state analysis and/or the top ranked eez analysis). For the Caribbean, we've chosen to use a -260 to 100 degree view. For the Pacific, we've chosen to use a 0 to 360 degree view. 

For the purposes of plotting the EEZs in which the fishing activity is taking place, we're using a simplified form of the Version 10 shapefile of the Maritime Boundaries - World EEZs from MarineRegions.org. We simplified the shapefile using mapshaper (online at mapshaper.org) to a tolerance of 0.5%. For the purposes of plotting the flag states to which distant water vessels are flagged, we're using the Version 2 shapefile of the Marine and land zones: the union of world country boundaries and EEZs from Marine Regions.org.

```{r}
# For the eez analysis for the top ranked EEZs we're going to use the standard -180 to 180 degree world view
# For the ACP analysis, things get a little complicated as we want to use three different world views for the three different regions
# For Africa, we're going to use the standard -180 to 180 degree world view
# For the Pacific, we're going to use a 0 to 360 degree world view
# For the Caribbean, we're going to use a -260 to 100 degree world view
  
  ### EEZs for location of fishing activity -----
  eez_map <- read_sf(dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "World_EEZ_v10_20180221_LR_-360_360"), layer = "eez_v10") %>%
    st_transform(crs = 4326) %>%
    setNames(tolower(names(.))) %>%
    dplyr::select(id = cat,
                  mrgid,
                  geoname,
                  pol_type,
                  territory1,
                  iso3_ter1 = iso_ter1,
                  sovereign1,
                  territory2,
                  iso3_ter2 = iso_ter2,
                  sovereign2,
                  territory3,
                  iso3_ter3 = iso_ter3,
                  sovereign3)
  
  # Africa
  africa_eez_map <- st_crop(eez_map, c(xmin=-180, xmax=180, ymin=-90, ymax=90))
  africa_eez_map_centroids <- africa_eez_map %>%
    st_centroid() %>%
    dplyr::select(eez_code = mrgid, eez_name = geoname, geometry) %>%
    mutate(region = "Africa")
  
  if(eez_purpose == "ACP"){
    
  # Caribbean
  caribbean_eez_map <- st_crop(eez_map, c(xmin=-180, xmax=180, ymin=-90, ymax=90))
  caribbean_eez_map_centroids <- caribbean_eez_map %>%
    st_centroid() %>%
    dplyr::select(eez_code = mrgid, eez_name = geoname, geometry) %>%
    mutate(region = "Caribbean")  
    
  # Pacific
  pacific_eez_map <- st_crop(eez_map, c(xmin=0, xmax=360, ymin=-90, ymax=90))
  pacific_eez_map_centroids <- pacific_eez_map %>%
    st_centroid() %>%
    dplyr::select(eez_code = mrgid, eez_name = geoname, geometry) %>%
    mutate(region = "Pacific")
  
  # Bind together 
  eez_map_centroids <- pacific_eez_map_centroids %>%
    rbind(africa_eez_map_centroids) %>%
    rbind(caribbean_eez_map_centroids)
  
  }else{
    
    eez_map_centroids <- africa_eez_map
    
  }
  
  # Put centroids in lon/lat columns
  eez_map_centroid_coordinates <- tibble(eez_code = eez_map_centroids$eez_code,
                                         eez_name = eez_map_centroids$eez_name,
                                         region = eez_map_centroids$region) %>% 
    bind_cols(do.call(rbind, st_geometry(eez_map_centroids)) %>%
                as_tibble() %>%
                setNames(c("eez_lon", "eez_lat"))) %>%
    arrange(eez_code)
  
  
  ### Combined land/EEZs for flag states -----
  land_eez_map <- read_sf(dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "EEZ_land_v2_201410_-360_360"), layer = "EEZ_land_v2_201410_-360_360") %>%
    st_transform(crs = 4326) %>%
    setNames(tolower(names(.))) %>%
    dplyr::select(id = objectid,
                  iso3 = iso_3digit,
                  country)
  
  # Africa
  africa_land_eez_map <- st_crop(land_eez_map, c(xmin=-180, xmax=180, ymin=-90, ymax=90))
  africa_land_eez_map_centroids <- africa_land_eez_map %>%
    st_centroid() %>%
    dplyr::select(flag = iso3, flag_name = country, geometry) %>%
    mutate(region = "Africa")
  
  if(eez_purpose == "ACP"){
    
  # Caribbean
  caribbean_land_eez_map <- st_crop(land_eez_map, c(xmin=-180, xmax=180, ymin=-90, ymax=90))
  caribbean_land_eez_map_centroids <- caribbean_land_eez_map %>%
    st_centroid() %>%
    dplyr::select(flag = iso3, flag_name = country, geometry) %>%
    mutate(region = "Caribbean")
  
  # Pacific
  pacific_land_eez_map <- st_crop(land_eez_map, c(xmin=0, xmax=360, ymin=-90, ymax=90))
  pacific_land_eez_map_centroids <- pacific_land_eez_map %>%
    st_centroid() %>%
    dplyr::select(flag = iso3, flag_name = country, geometry) %>%
    mutate(region = "Pacific")
  
  # Bind together
  land_eez_map_centroids <- pacific_land_eez_map_centroids %>%
    rbind(africa_land_eez_map_centroids) %>%
    rbind(caribbean_land_eez_map_centroids)
  
    
  }else{
    
    land_eez_map_centroids <- africa_land_eez_map_centroids
  
  }
  
  # Put centroids in lon/lat columns
  land_eez_map_centroid_coordinates <- tibble(flag = land_eez_map_centroids$flag,
                                              flag_name = land_eez_map_centroids$flag_name,
                                              region = land_eez_map_centroids$region) %>% 
    bind_cols(do.call(rbind, st_geometry(land_eez_map_centroids)) %>%
                as_tibble() %>%
                setNames(c("flag_lon", "flag_lat"))) %>%
    arrange(flag) %>%
    na.omit()
  
   #Manually correct certain centroids
   manual_coordinates_flags <- read_csv(paste0(results_dir, "corrected_flag_centroids.csv"))
   
   land_eez_map_centroid_coordinates <- land_eez_map_centroid_coordinates %>%
     left_join(manual_coordinates_flags, by = c("flag", "region")) %>%
     mutate(flag_lon = ifelse(!is.na(flag_lon_edit), flag_lon_edit, flag_lon),
            flag_lat = ifelse(!is.na(flag_lat_edit), flag_lat_edit, flag_lat)) %>%
     dplyr::select(-flag_lon_edit, -flag_lat_edit)

```

If we're making figures, we also need to do some setup for our figures. 

```{r}
if(make_figures){
  
  # Custom theme for map
  maptheme <- theme_minimal() +
    theme(panel.background = element_rect(fill = "grey27", colour = NA),
          panel.grid.major = element_line(colour = "grey27"),
          panel.border = element_blank(),
          plot.margin = unit(c(0, 0, 0, 0), "mm"),
          plot.background = element_blank(),
          axis.title = element_blank(),
          axis.text = element_blank(),
          axis.ticks.length = unit(0, "pt"))
  
  # Custom color palette for Sumaila subsidy types
  goodColors <- rev(brewer.pal(3, "Blues"))
  names(goodColors) <- levels(subsidy_dat_edit$type)[1:3]
  
  badColors <- rev(brewer.pal(7, "Reds"))
  names(badColors) <- levels(subsidy_dat_edit$type)[4:10]
  
  ambigColors <- c("purple", "mediumorchid", "violet")
  names(ambigColors) <- levels(subsidy_dat_edit$type)[11:13]
  
  myColors <- c(goodColors, badColors, ambigColors)
  
}
```

## Part 2: Identify top locations of DW fishing by EEZ

If the purpose of the eez analysis is to identify the top `r number_of_top_countries_eez` EEZs in which DW fleets fish, we consider the following metrics:
- Number of fishing vessels partaking in DW fishing
- Total number of DW fishing hours
- Total number of DW fishing KWh

```{r}
# Mutate totals by EEZ
EEZ_ranking <- dw_effort_final %>% 
  group_by(eez_code, eez_name, eez_territory_iso3, eez_sovereign_iso3, ssvid) %>%
  summarize(engine_power_kw = unique(engine_power_kw),
            fishing_hours = sum(fishing_hours_year_eez, na.rm = T),
            fishing_KWh = sum(fishing_KWh_year_eez, na.rm = T)) %>%
  ungroup() %>%
  group_by(eez_code, eez_name, eez_territory_iso3, eez_sovereign_iso3) %>%
  summarize(total_vessels = n_distinct(ssvid),
            total_capacity = sum(engine_power_kw, na.rm = T),
            total_fishing_hours = sum(fishing_hours, na.rm = T),
            total_fishing_KWh = sum(fishing_KWh, na.rm = T)) %>% 
  arrange(desc(total_vessels)) %>%
  ungroup() %>%
  mutate(vessel_rank = dense_rank(desc(total_vessels)),
         capacity_rank = dense_rank(desc(total_capacity)),
         fishing_hours_rank = dense_rank(desc(total_fishing_hours)),
         fishing_KWh_rank = dense_rank(desc(total_fishing_KWh))) %>%
  mutate(avg_rank = rowMeans(select(., c(vessel_rank, capacity_rank, fishing_hours_rank, fishing_KWh_rank))))

# Save
write_csv(EEZ_ranking, paste0(eez_results_dir, "EEZ_ranking_avg_", analysis_year, ".csv"))

```

Alternatively, we may want to run the EEZ analysis for all ACP countries.

```{r}
# Get codes/name to run anlysis for 
if(eez_purpose == "top_ranked"){
  
  EEZ_ranking_top <- EEZ_ranking %>%
    top_n(-number_of_top_countries_eez, wt = avg_rank)

  analysis_eezs <- EEZ_ranking_top$eez_code
  analysis_eez_territory_iso3 <- EEZ_ranking_top$eez_territory_iso3
  analysis_eez_territory_name <- countrycode(analysis_eez_territory_iso3, "iso3c", "country.name")
  
  ##EEZ combinations for the selected subset
  eez_combinations <- dw_effort_final %>%
    dplyr::filter(eez_code %in% analysis_eezs) %>%
    group_by(eez_code = as.numeric(eez_code), eez_territory_iso3, flag) %>%
    summarize(vessels = n_distinct(ssvid),
              capacity = sum(engine_power_kw, na.rm = T),
              fishing_h = sum(fishing_hours_year_eez, na.rm = T),
              fishing_KWh = sum(fishing_KWh_year_eez, na.rm = T)) %>%
    arrange(eez_code) %>%
    ungroup() %>%
    mutate(region = "Africa")
  
  # Combine with coordinates
  eez_mapping <- eez_combinations %>%
    left_join(eez_map_centroid_coordinates, by = c("eez_code" = "eez_code", "region" = "region")) %>%
    left_join(land_eez_map_centroid_coordinates, by = c("flag" = "flag", "region" = "region")) 
  
   # There are some flag states for which we need to manually assign centroids: Hong Kong
   # Vessels with an unknown flag do not have lat/lon coordinates
  # Hong Kong (HKG)
  eez_mapping$flag_lon[eez_mapping$flag == "HKG" & eez_mapping$region == "Africa"] <- 22.409
  eez_mapping$flag_lat[eez_mapping$flag == "HKG" & eez_mapping$region == "Africa"] <- 114.139
  

}else if(eez_purpose == "ACP"){
  
  ACP_codes <- read_csv(here::here("SubsidyAtlasACP", "data", "ACP_eez_codes.csv")) %>% 
    dplyr::select(territory, territory_iso3, mrgid, region) %>%
    dplyr::filter(!is.na(mrgid))
  
  ACP_eez_filter <- EEZ_ranking %>%
    dplyr::filter(eez_code %in% ACP_codes$mrgid)
  
  analysis_eezs <- ACP_eez_filter$eez_code
  analysis_eez_territory_iso3 <- ACP_eez_filter$eez_territory_iso3
  analysis_eez_territory_name <- countrycode(analysis_eez_territory_iso3, "iso3c", "country.name")
  
  ##EEZ combinations for the selected subset
  eez_combinations <- dw_effort_final %>%
    dplyr::filter(eez_code %in% analysis_eezs) %>%
    group_by(eez_code = as.numeric(eez_code), eez_territory_iso3, flag) %>%
    summarize(vessels = n_distinct(ssvid),
              capacity = sum(engine_power_kw, na.rm = T),
              fishing_h = sum(fishing_hours_year_eez, na.rm = T),
              fishing_KWh = sum(fishing_KWh_year_eez, na.rm = T)) %>%
    arrange(eez_code) %>%
    ungroup() %>%
    left_join(ACP_codes %>% dplyr::select(mrgid, region), by = c("eez_code" = "mrgid"))
  
  # Combine with coordinates
  eez_mapping <- eez_combinations %>%
    left_join(eez_map_centroid_coordinates, by = c("eez_code" = "eez_code", "region" = "region")) %>%
    left_join(land_eez_map_centroid_coordinates, by = c("flag" = "flag", "region" = "region")) 
  
  # The only flag states with NA flag_long/flag_lat coordiantes coorespond to vessels with an unknown flag so we're good there
}
```

In order to make our connection plots, we again need the centroids of each EEZ and flag state, which we match to each of our top EEZs, as well as to all flag states from which vessels are fishing in each EEZ.


```{r}
if(eez_purpose == "top_ranked"){  
# We then make our lines from each EEZ going to all of the countries fishing there. 
eez_mapping_wlines <- eez_mapping %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>%
  bind_cols(eez_mapping) %>%
  select(everything(), geometry) %>%
  st_segmentize(units::set_units(100,km)) %>%
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>%
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>%
  sf::st_sf(crs = 4326)

st_write(eez_mapping_wlines, dsn = paste0(eez_results_dir, "eez_mapping_with_lines.shp"),  delete_dsn=TRUE, driver = "ESRI Shapefile")

}else if(eez_purpose == "ACP"){

# Africa
eez_mapping_wlines_africa <- eez_mapping %>%
  dplyr::filter(!is.na(flag_lon)) %>%
  dplyr::filter(region == "Africa") %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>% 
  bind_cols(eez_mapping %>% dplyr::filter(!is.na(flag_lon)) %>% dplyr::filter(region == "Africa")) %>%
  select(everything(), geometry) %>% 
  st_segmentize(units::set_units(100,km)) %>% 
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=180"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326) 

 # test_plot_africa <- ggplot()+
 #  geom_sf(data = eez_map, fill = NA, color = "grey60", size = 0.1)+ # world EEZs (transparent, light grey border lines)
 #  geom_sf(data = land_eez_map, fill = "grey2", color = "grey40", size = 0.1)+ # world countries (dark grey, white border lines)
 #  geom_sf(data = land_eez_map %>% dplyr::filter(iso3 %in% eez_mapping_wlines_africa$flag), fill = "darkmagenta", color = "grey40", size = 0.1) + # highlighted flag state (magenta, grey border lines)
 #  geom_sf(data = eez_map %>% dplyr::filter(mrgid %in% eez_mapping_wlines_africa$eez_code), fill = "slateblue", alpha = 0.5, color = NA, size = 0.1) + # highlighted EEZs (slate blue)
 #  geom_sf(data = eez_mapping_wlines_africa, col = "darkgoldenrod", size = 0.25) +
 #  maptheme+
 #  coord_sf(xlim = c(-180,180), ylim = c(-90,90))+
 #  scale_x_continuous(expand = c(0,0))+
 #  scale_y_continuous(expand = c(0,0))

# Caribbean
eez_mapping_wlines_caribbean <- eez_mapping %>%
  dplyr::filter(flag != "UNK") %>%
  dplyr::filter(region == "Caribbean") %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>% 
  bind_cols(eez_mapping %>% dplyr::filter(flag != "UNK") %>% dplyr::filter(region == "Caribbean")) %>%
  select(everything(), geometry) %>% 
  st_segmentize(units::set_units(100,km)) %>% 
  mutate(geometry = (geometry + c(180,90)) %% c(360) - c(180,90)) %>% 
  #mutate(geometry = (geometry + c(-100,90)) %% c(360) - c(260,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=100"), quiet = TRUE) %>% 
  sf::st_sf(crs = 4326) 

 # test_plot_caribbean <- ggplot()+
 #  geom_sf(data = eez_map, fill = NA, color = "grey60", size = 0.1)+ # world EEZs (transparent, light grey border lines)
 #  geom_sf(data = land_eez_map, fill = "grey2", color = "grey40", size = 0.1)+ # world countries (dark grey, white border lines)
 #  geom_sf(data = land_eez_map %>% dplyr::filter(iso3 %in% eez_mapping_wlines_caribbean$flag), fill = "darkmagenta", color = "grey40", size = 0.1) + # highlighted flag state (magenta, grey border lines)
 #  geom_sf(data = eez_map %>% dplyr::filter(mrgid %in% eez_mapping_wlines_caribbean$eez_code), fill = "slateblue", alpha = 0.5, color = NA, size = 0.1) + # highlighted EEZs (slate blue)
 #  geom_sf(data = eez_mapping_wlines_caribbean, col = "darkgoldenrod", size = 0.25) +
 #  maptheme+
 #  coord_sf(xlim = c(-180,180), ylim = c(-90,90))+
 #  scale_x_continuous(expand = c(0,0))+
 #  scale_y_continuous(expand = c(0,0))

eez_mapping_wlines_pacific <- eez_mapping %>%
  dplyr::filter(flag != "UNK") %>%
  dplyr::filter(region == "Pacific") %>%
  select(flag_lon, flag_lat, eez_lon, eez_lat) %>% 
  purrr::transpose() %>% 
  purrr::map(~ matrix(flatten_dbl(.), nrow = 2, byrow = TRUE)) %>% 
  purrr::map(st_linestring) %>%
  st_sfc(crs = 4326) %>%
  st_sf(geometry = .) %>% 
  bind_cols(eez_mapping %>% dplyr::filter(flag != "UNK") %>% dplyr::filter(region == "Pacific")) %>%
  select(everything(), geometry) %>% 
  st_segmentize(units::set_units(100,km)) %>% 
  mutate(geometry = (geometry + c(360,90)) %% c(360) - c(0,90)) %>% 
  st_wrap_dateline(options = c("WRAPDATELINE=YES",  "DATELINEOFFSET=0"), quiet = TRUE) %>%
  sf::st_sf(crs = 4326) 

 # test_plot_pacific <- ggplot()+
 #  geom_sf(data = eez_map, fill = NA, color = "grey60", size = 0.1)+ # world EEZs (transparent, light grey border lines)
 #  geom_sf(data = land_eez_map, fill = "grey2", color = "grey40", size = 0.1)+ # world countries (dark grey, white border lines)
 #  geom_sf(data = land_eez_map %>% dplyr::filter(iso3 %in% eez_mapping_wlines_pacific$flag), fill = "darkmagenta", color = "grey40", size = 0.1) + # highlighted flag state (magenta, grey border lines)
 #  geom_sf(data = eez_map %>% dplyr::filter(mrgid %in% eez_mapping_wlines_pacific$eez_code), fill = "slateblue", alpha = 0.5, color = NA, size = 0.1) + # highlighted EEZs (slate blue)
 #  geom_sf(data = eez_mapping_wlines_pacific, col = "darkgoldenrod", size = 0.25) +
 #  maptheme+
 #  #coord_sf(xlim = c(0,360), ylim = c(-90,90))+
 #  scale_x_continuous(expand = c(0,0))+
 #  scale_y_continuous(expand = c(0,0))


eez_mapping_wlines <- eez_mapping_wlines_africa %>%
  rbind(eez_mapping_wlines_caribbean) %>%
  rbind(eez_mapping_wlines_pacific) %>%
  mutate(fishing_h = round(fishing_h, 1),
         fishing_KWh = round(fishing_KWh, 1))


st_write(eez_mapping_wlines, dsn = paste0(eez_results_dir, "eez_mapping_with_lines.shp"),  delete_dsn=TRUE, driver = "ESRI Shapefile")
st_write(eez_mapping_wlines, dsn = paste0(eez_results_app_dir, "eez_mapping_with_lines.shp"),  delete_dsn=TRUE, driver = "ESRI Shapefile")

}
```

We first need to make the connectivity maps... 

```{r}

  eez_loop_iso3 <- unique(analysis_eez_territory_iso3)
  eez_loop_names <- unique(analysis_eez_territory_name)

## For loop to run top EEZs
for(i in 1:length(eez_loop_iso3)){
  
run_eez_codes <- analysis_eezs[which(analysis_eez_territory_iso3 == eez_loop_iso3[i])]

eez_dat <- eez_mapping_wlines %>%
  dplyr::filter(eez_territory_iso3 == eez_loop_iso3[i]) 

if(make_figures){
  
  # Make EEZ connection plot
eez_connectivity_map <- ggplot()+
  geom_sf(data = eez_map, fill = NA, color = "grey60", size = 0.1)+ # world EEZs (transparent, light grey border lines)
  geom_sf(data = land_eez_map, fill = "grey2", color = "grey40", size = 0.1)+ # world countries (dark grey, white border lines)
  geom_sf(data = land_eez_map %>% dplyr::filter(iso3 %in% eez_dat$flag), fill = "darkmagenta", color = "grey40", size = 0.1) + # highlighted flag state (magenta, grey border lines)
  geom_sf(data = eez_map %>% dplyr::filter(mrgid %in% run_eez_codes), fill = "slateblue", alpha = 0.5, color = NA, size = 0.1) + # highlighted EEZs (slate blue)
  geom_sf(data = eez_dat, col = "darkgoldenrod", size = 0.25) +
  maptheme+
  coord_sf(xlim = c(-180,180), ylim = c(-90,90))+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))

#plot_map pngs
ggsave(eez_connectivity_map, filename = paste0(eez_figures_dir, eez_loop_iso3[i], "_EEZ_connectivity_map.png"), width = 10, units = "in")

# Combine map into a one page pdf
title3 <- textGrob(paste0("Global network of distant-water fishing\nEEZ: ", eez_loop_names[i]), gp = gpar(fontsize=16, fontface="bold", lineheight=1, col = "white", fontfamily = "Helvetica"), hjust = 0.55, vjust = 1)

caption3 <- textGrob(paste0("This map shows the global origins of distant-water vessels fishing in the EEZ of", eez_loop_names[i], ". Lines connect the EEZ (blue) \nwith all foreign countries (pink) from which vessels fishing in that EEZ in 2018 are flagged. Data were taken from Global Fishing Watch (2018)."), gp = gpar(fontsize = 10, col = "white", fontfamily = "Helvetica"), vjust = 0, hjust = 0.5)

lay3 <- rbind(c(1,4),
              c(2,2),
              c(2,2),
              c(3,3))

# White SFG Logo
sfg_logo_white <- readPNG(here::here("common", "sfg-logo-white.png"))
logo_white <- rasterGrob(sfg_logo_white, interpolate=TRUE, vjust = 0.8, hjust = 0.6)

# Put together connectivity map
eez_page <- grid.arrange(title3, eez_connectivity_map, caption3, logo_white, 
                         layout_matrix = lay3,
                         heights=unit(c(1,1.5,5,1), c("in")), 
                         widths=unit(c(8.25,2.75), "in"))
out3 <- cowplot::ggdraw(eez_page) + 
  theme(plot.background = element_rect(fill="grey27", color = NA))

# Save connectivity map
ggsave(out3, filename = paste0(eez_pdf_dir, eez_loop_iso3[i], "_map_page.pdf"), width = 11, height = 8.5, units = "in")

### Step 2 - make heat maps
eezmaptheme <- theme_minimal()+
  theme(plot.background = element_rect(fill = "grey27", color = NA),
        panel.background = element_rect(fill = "grey27", color = NA),
        panel.grid.major = element_line(colour = "grey27"),
        text = element_text(color = "white"),
        plot.title = element_text(hjust = 0.5),
        panel.border = element_rect(color = "white", fill = NA),
        plot.margin = margin(t = 0, r = 0.1, b = 0, l = 0, unit = "cm"),
        legend.margin = margin(t = 0.1, r = 0, b = 0.1, l = 0, unit = "cm"),
        legend.position = "bottom",
        legend.box = "horizontal",
        axis.text = element_text(color = "white"))
}

# Pull gridded data
# What bin size do we want to use (degrees)?  
bin_size <- 0.1
    
# Voodoo to deal with some territories having multiple EEZs
if(length(run_eez_codes) > 1){
    run_eez_codes_string <- toString(sprintf("'%s'", run_eez_codes))
    run_eez_text <- paste0("eez_code IN (", run_eez_codes_string, ")")
}else {
    run_eez_codes_string <- run_eez_codes
    run_eez_text <- paste0("eez_code = '", run_eez_codes_string, "'")
}
    
sql4 <- paste0(
  "WITH
  eez_lookup AS (
    SELECT
      CAST(eez_id AS string) eez_code,
      territory1_iso3 eez_territory_iso3
    FROM
      `world-fishing-827.gfw_research.eez_info`),

  selected_vi AS (
    SELECT
       year,
       ssvid,
       engine_power_kw,
       flag,
       eez_code
    FROM
       `ucsb-gfw.subsidy_atlas.FINAL_dw_effort_by_eez_", analysis_year, "`),
   
  eez_info AS (
     SELECT
       EXTRACT(year FROM _partitiontime) year,
       if(ARRAY_LENGTH(regions.eez)=0, '0000', regions.eez[ordinal(1)]) eez_code,
       ssvid,
       FLOOR(lat/", bin_size,") * ", bin_size, " + ", bin_size/2, " AS lat_cen,
       FLOOR(lon/", bin_size, ") * ", bin_size, " + ", bin_size/2, " AS lon_cen,
      CASE WHEN COUNT(DISTINCT _partitiontime) IS NULL THEN 0 ELSE COUNT(DISTINCT _partitiontime) END fishing_days,
      CASE WHEN SUM(hours) IS NULL THEN 0 ELSE SUM(hours) END fishing_hours
     FROM
       `world-fishing-827.gfw_research.pipe_production_b_fishing`
     WHERE
       nnet_score2 > .5
       AND seg_id IN (
          SELECT
            seg_id
          FROM
            `world-fishing-827.gfw_research.pipe_production_b_segs`
          WHERE
            good_seg)
    GROUP BY
      year,
      eez_code,
      ssvid,
      lat_cen,
      lon_cen
    HAVING
      year = ", analysis_year, 
      " AND ", run_eez_text, 
      " AND fishing_hours >= 1)
      
 SELECT
    a.year,
    a.eez_code,
    eez_territory_iso3,
    flag,
    lat_cen,
    lon_cen,
    SUM(a.fishing_hours) as fishing_hours,
    SUM(a.fishing_days) as fishing_days,
    SUM(a.fishing_hours * b.engine_power_kw) as fishing_KWh,
    SUM(a.fishing_hours * b.engine_power_kw * c.subs_per_fishing_KWh) as subs
  FROM
    eez_info a
  INNER JOIN 
    selected_vi b 
  ON 
    a.ssvid = b.ssvid AND 
    a.eez_code = b.eez_code
  LEFT JOIN
    `ucsb-gfw.subsidy_atlas.subsidy_rates_flag` c
  USING
    (flag)
  LEFT JOIN
    eez_lookup d
  ON
    a.eez_code = d.eez_code
  GROUP BY
    year,
    eez_code,
    eez_territory_iso3,
    flag,
    lat_cen,
    lon_cen
  ORDER BY
    flag"
  )

  eez_table <- bq_table(project = bq_project, table = paste0("fishing_effort_", eez_loop_iso3[i]), dataset = "subsidy_atlas") 

  if(bq_table_exists(eez_table) == FALSE){
    
    bq_table(project = bq_project, table = paste0("fishing_effort_", eez_loop_iso3[i]), dataset = "subsidy_atlas") %>%
      bq_table_create()
    
  }else{
    
    bq_table(project = bq_project, table = paste0("fishing_effort_", eez_loop_iso3[i]), dataset = "subsidy_atlas") %>%
      bq_table_delete()
    
  }

  eez_effort <- bq_project_query(bq_project, sql4, destination_table = bq_table(project = bq_project, table = paste0("fishing_effort_", eez_loop_iso3[i]), dataset = "subsidy_atlas"), use_legacy_sql = FALSE, allowLargeResults = TRUE) %>%
    bq_table_download(max_results = Inf)

  write_csv(eez_effort, path = paste0(eez_dat_dir, eez_loop_iso3[i], "_EEZ_effort_subs_by_flag.csv"))
  
  write_csv(eez_effort, path = paste0(eez_results_app_dir, eez_loop_iso3[i], "_EEZ_effort_subs_by_flag.csv"))


if(make_figures){
  
  ### Make Plots 
  # Get quantiles of data for scale limits
  eez_effort_aggregated <- eez_effort %>%
    group_by(year, eez_territory_iso3, lon_cen, lat_cen) %>%
    summarize(fishing_hours = sum(fishing_hours, na.rm = T),
              fishing_KWh = sum(fishing_KWh, na.rm = T),
              subs = sum(subs, na.rm = T)) %>%
    mutate(subsidy_intensity = subs/fishing_KWh)
  
    # Set map limits for filtering global country map and eez map appropriately
  x_lim <- c(min(eez_effort_aggregated$lon_cen) - 0.5, max(eez_effort_aggregated$lon_cen) + 0.5)
  y_lim <- c(min(eez_effort_aggregated$lat_cen) - 0.5, max(eez_effort_aggregated$lat_cen) + 0.5)
  
  # Quantiles
  if(length(unique(eez_effort_aggregated$subsidy_intensity)) <= 1){
    
  # Map of subsidy intensity
  eez_subsidy_plot <- ggplot()+
    geom_sf(data = land_eez_map, fill = "grey2", color = "grey40", size = 0.5)+ # world countries (dark grey, white border lines)
    geom_sf(data = eez_map, fill = NA, color = "grey60", size = 0.5)+ # world EEZs (transparent, light grey border lines)
    geom_raster(data = eez_effort_aggregated, aes(x = lon_cen, y = lat_cen, fill = subsidy_intensity))+
    eezmaptheme +
    scale_fill_viridis_c(na.value = NA, name = "Subsidy intensity \n(2018 $USD/KWh)", 
                         oob=scales::squish)+
    labs(x = "", y = "")+
    coord_sf(xlim = x_lim, ylim = y_lim)+
    guides(fill = guide_colorbar(title.position = "bottom", title.hjust = 0.5, barwidth = 18))+
    scale_x_continuous(expand = c(0,0))+
    scale_y_continuous(expand = c(0,0))
    
  }else{
    
    intensity_quantile <- quantile(eez_effort_aggregated$subsidy_intensity, probs = c(0.01, 0.05, 0.95, 0.99), na.rm = T)
  scale_labels <- round(seq(round(intensity_quantile[1], 1), round(intensity_quantile[4], 1), length.out = 5), 1)
  
   # Map of subsidy intensity
  eez_subsidy_plot <- ggplot()+
    geom_sf(data = land_eez_map, fill = "grey2", color = "grey40", size = 0.5)+ # world countries (dark grey, white border lines)
    geom_sf(data = eez_map, fill = NA, color = "grey60", size = 0.5)+ # world EEZs (transparent, light grey border lines)
    geom_raster(data = eez_effort_aggregated, aes(x = lon_cen, y = lat_cen, fill = subsidy_intensity))+
    eezmaptheme +
    scale_fill_viridis_c(na.value = NA, name = "Subsidy intensity \n(2018 $USD/KWh)", 
                         limits=c(round(intensity_quantile[1],1)-round(intensity_quantile[1],1)*0.01, round(intensity_quantile[4], 1) + round(intensity_quantile[4], 1)*0.01), 
                         labels=scale_labels,
                         breaks=scale_labels,
                         oob=scales::squish)+
    labs(x = "", y = "")+
    coord_sf(xlim = x_lim, ylim = y_lim)+
    guides(fill = guide_colorbar(title.position = "bottom", title.hjust = 0.5, barwidth = 18))+
    scale_x_continuous(expand = c(0,0))+
    scale_y_continuous(expand = c(0,0))
    
  }
  
  ggsave(eez_subsidy_plot, filename = paste0(eez_figures_dir, eez_loop_iso3[i], "_EEZ_subsidy_map.png"), width = 10, units = "in")
  
  # Labels for the log scale 
  eez_effort_plot <- ggplot()+
    geom_sf(data = land_eez_map, fill = "grey2", color = "grey40", size = 0.5)+ # world countries (dark grey, white border lines)
    geom_sf(data = eez_map, fill = NA, color = "grey60", size = 0.5)+ # world EEZs (transparent, light grey border lines)
    geom_raster(data = eez_effort_aggregated, aes(x = lon_cen, y = lat_cen, fill = fishing_KWh))+
    eezmaptheme +
    scale_fill_viridis_c(na.value = NA, option = "A", name = "Fishing effort \n(KWh)", trans = log10_trans(), labels = comma)+
    labs(x = "", y = "")+
    coord_sf(xlim = x_lim, ylim = y_lim) +
    guides(fill = guide_colorbar(title.position = "bottom", title.hjust = 0.5, barwidth = 18))+
    scale_x_continuous(expand = c(0,0))+
    scale_y_continuous(expand = c(0,0))
  
  ggsave(eez_effort_plot, filename = paste0(eez_figures_dir, eez_loop_iso3[i], "_EEZ_effort_map.png"), width = 10, units = "in")

  # Combined plot  
logo_white2 <- rasterGrob(sfg_logo_white, interpolate=TRUE, vjust = 0.8, hjust = 0.3)
  
title4 <- textGrob(paste0("Global network of distant-water fishing\nEEZ: ", eez_loop_names[i]), gp = gpar(fontsize=16, fontface="bold", lineheight=1, col = "white", fontfamily = "Helvetica"), hjust = 0.55, vjust = 1)

caption4 <- textGrob(paste0("These maps show distant-water fishing effort (left, KWh) and subsidy intensity (right, 2018 $USD/KWh) in the EEZ of ", eez_loop_names[i], ". \nBoth fishing effort and subsidy intensity are aggregated by 0.1 degree latitude/longitude. Data were taken from Global Fishing Watch (2018)."), gp = gpar(fontsize = 10, col = "white", fontfamily = "Helvetica"), vjust = 0, hjust = 0.5)

  if(eez_loop_iso3[i] == "RUS"){
    
    lay4 <- rbind(c(1,1,1,5),
              c(NA,NA,NA,NA),
              c(2,2,2,2),
              c(3,3,3,3),
              c(4,4,4,4))
    
    
  } else{
    
    lay4 <- rbind(c(1,1,1,5),
              c(NA,NA,NA,NA),
              c(2,2,3,3),
              c(2,2,3,3),
              c(4,4,4,4))
    
  }

# Put together connectivity map
page4 <- grid.arrange(title4, eez_effort_plot, eez_subsidy_plot, caption4, logo_white, 
                         layout_matrix = lay4,
                         heights=unit(c(1,0.5,3,3,1), c("in")),
                         widths=unit(c(2.75,2.75,2.75,2.75), "in"))
out4 <- cowplot::ggdraw(page4) + 
  theme(plot.background = element_rect(fill="grey27", color = NA))

# Save connectivity map
ggsave(out4, filename = paste0(eez_pdf_dir, eez_loop_iso3[i], "_effort_page.pdf"), width = 11, height = 8.5, units = "in")

# Save both plots into one pdf
  out_eez <- marrangeGrob(grobs = list(out3, out4), nrow = 1, ncol = 1, top = NULL)
  
  ggsave(out_eez, filename = paste0(eez_pdf_dir, eez_loop_iso3[i], "_combined.pdf"), width = 11, height = 8.5, units = "in")
  
}

}

```
