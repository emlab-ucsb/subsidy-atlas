---
output:
  html_document: default

title: "Distant Water Fishing Atlas - Identifying Distant Water Fishing"
author: "Kat Millage, Matt Warham"
date: "`r format(Sys.time(), '%B %d, %Y')`"
fontsize: 11pt
---

```{r setup, include=FALSE}
# Chunk options
knitr::opts_chunk$set(echo = TRUE)

# General
library(knitr) 
library(countrycode) # country name matching
library(janitor)
library(tidyverse)

# Path to vessel list
vessel_list_path <- here::here("results", "02b-vessel-list-global", "vessel_list_2018_raw.csv")

### Set run options
# Bigquery project
bq_project <-  "emlab-gcp"
vessel_year <- 2018

### Create results directories
results_dir <- here::here("results/03b-distant-water-fishing/")
  if (dir.exists(results_dir) == F) { dir.create(results_dir, recursive = T) }
```

# Introduction 

This script extracts defines and extracts distant water fishing activity to pull from the global vessel list previously created. 

## Identify distant water fishing vessels

Since the purpose of this tool is to show distant water fishing effort and subsidies, we need to separate out fishing effort considered to be "distant water" from the rest. This is done in a series of steps. 

In the first step, the following is not considered to be "distant water fishing" and is therefore removed:
- All fishing effort occuring on the high seas;
- All fishing effort occuring in an EEZ when the flag state of the vessel is the same as the administering state of the EEZ in which it is fishing.

```{r}
# Load vessel list
vessel_list_raw <- read.csv(vessel_list_path, stringsAsFactors = F) 
```

```{r}
# Country lookup table
country_lookup <- read_csv(here::here("data", "lookup-tables", "country_dependencies.csv"))

# Countries participating in the Northern Agreement for fishing
eu_countries <- country_lookup$iso3[country_lookup$is_EU]
eu_northern_agreement <- c("NOR", "ISL", "SJM")
```

```{r}
# Remove high seas fishing
vessel_list_dw <- vessel_list_raw %>%
  dplyr::filter(eez_id != 0000)

# Remove cases where flag state of vessel matches the administering territory (or territories in the cases of joint regime/disputed areas)
distant_water_fishing <- vessel_list_dw %>%
   mutate(territory1_match = case_when(!is.na(eez_territory1_iso3) & !is.na(flag_iso3) & flag_iso3 == eez_territory1_iso3 ~ T,
                                      TRUE ~ F),
         territory2_match = case_when(!is.na(eez_territory2_iso3) & !is.na(flag_iso3) & flag_iso3 == eez_territory2_iso3 ~ T,
                                      TRUE ~ F),
         territory3_match = case_when(!is.na(eez_territory3_iso3) & !is.na(flag_iso3) & flag_iso3 == eez_territory3_iso3 ~ T,
                                      TRUE ~ F)) %>%
  dplyr::filter(!territory1_match & !territory2_match & !territory3_match)

```

### "Intra-EU fishing".

Vessels flagged to EU member states have the right to fish in the EEZs of other EU member states, therefore we do not include these instances as "distant water fishing". In order to remove these from our dataset, we first need create a list of EU member states, as well as non-member states with with the EU has fishing agreements as part of the northern agreement (i.e. Norway and Iceland). 

We define "intra-EU fishing" as fishing activity that meets one of the following criteria: 
1. The flag state of the vessel is a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland and the EEZ in which it is fishing is administered by a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland (e.g. a French-flagged vessel fishing in the EEZ of Spain);
2. The sovereign of the vessel's flag state is a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland and the EEZ in which it is fishing is administered by a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland (e.g. a XXX-flagged vessel fishing in the EEZ of Spain).

We do not consider the following to be "intra-EU fishing" (and is therefore distante water fishing): 
1. The flag state of the vessel is a member state of the EU, Norway, Svalbard and Jan Mayen, or Iceland and the EEZ in which it is fishing belongs to a territory or distant region of an EU member state (e.g. a French-flagged vessel fishing in the EEZ of French Polynesia). 

```{r}
# Exclude intra EU fishing
distant_water_fishing <- distant_water_fishing %>%
  mutate(is_intra_EU = case_when(flag_iso3 %in% c(eu_countries, eu_northern_agreement) & eez_territory1_iso3 %in% c(eu_countries, eu_northern_agreement) ~ T,
                                 flag_sovereign_iso3 %in% c(eu_countries, eu_northern_agreement) & eez_territory1_iso3 %in% c(eu_countries, eu_northern_agreement) ~ T,
                                 TRUE ~ F)) %>%
  dplyr::filter(!is_intra_EU) %>%
  mutate(distant_water = T) %>%
  dplyr::select(eez_id, ssvid, fao_region, is_territorial, distant_water)
```

#### A Note on Sovereignity

If the sovereign country of the flag state of a vessel is the same as the sovereign country of the EEZ in which it's fishing, this connection may still be considered to be distant water fishing, though this is generally not considered to be foreign distant water fishing.

We describe "sovereign fishing" as fishing activity that meets one of the following criteria: 
1. The flag state of the vessel is the same as the sovereign of the administering territory of the EEZ in which it is fishing (e.g. a US flagged vessel fishing in the EEZ of Palmyra Atoll).
2. The sovereign of the flag state of the vessel is the same as the sovereign of the administering territory of the EEZ in which it is fishing (e.g. a Puerto-Rican flagged vessel fishing in the EEZ of Palmyra Atoll);

```{r}
vessel_list_dw <- vessel_list_dw %>%
  left_join(distant_water_fishing, by = c("eez_id", "ssvid", "fao_region", "is_territorial")) %>%
  dplyr::filter(distant_water)
```

Deciding whether to include these cases as "distant water fishing" is often tricky because many sovereign countries have fleets permanently based in their overseas territories. If that is indeed the case, then those fleets are not really partaking in distant water fishing. 

Sala et al. (2018) manually compiled some examples of this, and excluded them from their definition of distant water fishing. We follow the same logic. 

```{r}
# Specific cases that shouldn't be considered to be DW fishing
vessel_list_dw <- vessel_list_dw %>%
  filter(!(flag_iso3 == "USA" & eez_id %in% c(8442, 8443, 8444, 8451, 8452, 33179, 33180, 48980))) %>% # US flagged vessels fishing in the EEZs of Jarvis Island, Palmyra Atoll, American Samoa, Howland and Baker, Johnston Atoll, Puerto Rico, US Virgin Islands & Northern Mariana Islands 
  filter(!(flag_iso3 == "FLK" & eez_territory1_iso3 == "SHN")) %>% # Vessels flagged to the Falkland Islands fishing in the EEZ of Saint Helana, Ascension, and Tristan da Cunha
  filter(!(flag_sovereign_iso3 == "GBR" & eez_id == 8383)) %>% # Vessels flagged to the UK fishing in the disputed area of South Georgia & Sandwich Islands
  filter(!(flag_sovereign_iso3 == "GBR" & eez_id == 8389)) %>% # Vessels flagged to the UK fishing in the disputed area of the Falkland Islands
  filter(!(flag_sovereign_iso3 == "GBR" & eez_id == 8415)) # Vessels flagged to the UK fishing in the EEZ of Montserrat
```

```{r}
# Save
dw_effort_final_table <- bq_table(project = bq_project, 
                                    table = "effort_eez_fao_ter_2018_distant_water_only", 
                                    dataset = "distant_water_fishing_atlas")

dw_effort_final <- vessel_list_dw

# Check if that table already exists. If not, create it. Otherwise clear it.
  if(bq_table_exists(dw_effort_final_table)){

      dw_effort_final_table %>%
      bq_table_delete()

      dw_effort_final_table %>%
      bq_table_create() %>%
      bq_table_upload(values = dw_effort_final, fields = dw_effort_final)

  }else{

      dw_effort_final_table %>%
      bq_table_create() %>%
      bq_table_upload(values = dw_effort_final, fields = dw_effort_final)

  }

write_csv(dw_effort_final, paste0(results_dir, "vessel_list_2018_distant_water.csv"))
```


```{r}
# ### Do some manual corrections for fishing that shouldn't be there
# dw_effort_final <- dw_effort %>%
#   mutate(is_weird = case_when((flag == "CAN" & eez_territory_iso3 == "GUY") ~ T,
#                            (flag == "ZAF" & eez_territory_iso3 == "COD") ~ T,
#                            (flag == "SYC" & eez_territory_iso3 == "COD") ~ T,
#                            TRUE ~ FALSE)) %>%
#   dplyr::filter(!is_weird)
# 
# # Save
#   dw_effort_final_table <- bq_table(project = bq_project, table = paste0("FINAL_dw_effort_by_eez_", analysis_year), dataset = "subsidy_atlas")
#   
# # Check if that table already exists. If not, create it. Otherwise clear it. 
#   if(bq_table_exists(dw_effort_final_table)){
#     
#       dw_effort_final_table %>%
#       bq_table_delete()
#     
#       dw_effort_final_table %>%
#       bq_table_create() %>%
#       bq_table_upload(values = dw_effort_final, fields = dw_effort_final)
#     
#   }else{
#     
#       dw_effort_final_table %>%
#       bq_table_create() %>%
#       bq_table_upload(values = dw_effort_final, fields = dw_effort_final)
# 
#   }
# 
# write_csv(dw_effort_final, paste0(results_dir, "FINAL_dw_effort_by_eez_", analysis_year, ".csv"))

```


