---
title: "Mapping"
author: "Matthew Warham"
date: "5/10/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r mapping}

##EEZ boundaries


library(tidyverse)
library(sf)
library(tmap)
library(leaflet)
library(ggrepel)
library(ggspatial)
library(RColorBrewer)
library(raster)
library(tidyverse)
library(sf)
library(leaflet)




```

```{r maps}

##Map for EEZ's
EEZ_map <- read_sf(dsn = here::here("data", "shapefiles", "eez_v10_fao_combined_simple"), layer = "eez_v10_fao_combined_simple") %>% 
  st_transform(crs = 4326)


##Map for country boundaries
world_map <- read_sf(dsn = here::here("data", "shapefiles", "world_happy_180"), layer = "world_happy_180") %>% 
  st_transform(crs = 4326)



data(EEZ_map)
r <- rasterize(EEZ_map, raster())


# China as a test plot
china <- EEZ_tidy %>%
  dplyr::filter(eez_iso3 == "CHN")

eez_filtered_CHN <- EEZ_map %>%
  dplyr::filter(ez_hs_c %in% china$eez_fished)

plot_map_CHN <- ggplot()+
  geom_sf(data = EEZ_map, fill = "white", alpha = 0.5)+
  geom_sf(data = world_map, fill = "white")+
  geom_sf(data = world_map %>% dplyr::filter(iso3 == "CHN"), fill = "red") +
  geom_sf(data = eez_filtered_CHN, fill = "blue", alpha = 0.5) 
  #geom_path(data = EEZ_map, 
            #aes(lon, lat, group = group), alpha = 0.5, color = "#fa6900") 

plot_map_CHN


### USA test


USA <- EEZ_tidy %>%
  dplyr::filter(eez_iso3 == "USA")

eez_filtered_USA <- EEZ_map %>%
  dplyr::filter(ez_hs_c %in% USA$eez_fished)

plot_map_USA <- ggplot()+
  geom_sf(data = EEZ_map, fill = "white", alpha = 0.5)+
  geom_sf(data = world_map, fill = "white")+
  geom_sf(data = world_map %>% dplyr::filter(iso3 == "USA"), fill = "red") +
  geom_sf(data = eez_filtered_USA, fill = "blue", alpha = 0.5)

plot_map_USA











```

```{r Centroid Data Frame}

### Data frame of country centroids

data(country_map)

countrymap_sf <- st_as_sf(country_map, coords = c("lon","lat")) %>% 
  st_centroid(country_map$geometry) %>% 
  st_set_crs(4326)

countrymap_coords <- unlist(st_geometry(countrymap_sf)) %>% 
  matrix(ncol=2,byrow=TRUE) %>% 
  as_tibble() %>% 
  setNames(c("lon","lat")) 

country_names <- country_map %>% 
  as.data.frame() %>% 
  select(iso3)  
  

centroid_coordinates_country <- cbind(country_names, countrymap_coords) %>% 
  rename(flag = iso3) %>% 
  arrange((flag))


### Data frame of EEZ Centroids

data(EEZ_map)

EEZmap_sf <- st_as_sf(EEZ_map, coords = c("lon","lat")) %>% 
  st_centroid(EEZ_map$geometry) %>% 
  st_set_crs(4326)

EEZmap_coords <- unlist(st_geometry(EEZmap_sf)) %>% 
  matrix(ncol=2,byrow=TRUE) %>% 
  as_tibble() %>% 
  setNames(c("lon","lat")) 

EEZ_names <- EEZ_map %>% 
  as.data.frame() %>% 
  select(ez_hs_c)  
  

centroid_coordinates_EEZ <- cbind(EEZ_names, EEZmap_coords) %>% 
  rename(eez_iso3 = ez_hs_c)

##test

CHNUSA <- centroid_coordinates_country %>% 
  filter(iso3 == "CHN" | iso3 == "USA")

plot_map_USA <- ggplot()+
  geom_sf(data = EEZ_map, fill = "white", alpha = 0.5)+
  geom_sf(data = country_map, fill = "white")+
  geom_sf(data = country_map %>% dplyr::filter(iso3 == "USA"), fill = "red") +
  geom_sf(data = country_map, fill = "blue", alpha = 0.5) +
  geom_point(data = EEZ_final_results %>% dplyr::filter(flag == "USA"), aes(x = lon, y = lat, fill = "green"))+
  geom_path(data = EEZ_final_results, dplyr::filter(flag == "USA"), aes(x = lon, y = lat))
  #geom_curve(data = CHNUSA, aes(x= lon, y = lat))

plot(plot_map_USA)

### EEZ and Country Centroids
EEZ_centroids <- sf::st_centroid(EEZ_map$geometry)

ggplot(EEZ_centroids) +
  geom_sf(data = EEZ_map, fill = "skyblue")+
  geom_sf(colour = "red") 
  ## #+
  #geom_sf(aes(geometry = mid, size = AREA), show.legend = "point")


country_centroids <- st_centroid((country_map$geometry)) 

ggplot(country_centroids) +
  geom_sf(data = EEZ_map, fill = "skyblue")+
  geom_sf(colour = "red")
  
  
######

```


```{r Juan Mayorga Code}

##Juan Mayorga Code

## http://jsmayorga.com/post/mapping-the-global-network-of-transnational-fisheries/


paths <- network_data_sf %>% 
  sf::st_set_geometry(NULL) %>% 
  unnest() %>% 
  mutate_at(vars(X,Y), round,2)

separated_coord <- country_centroids %>%
    mutate(lat = unlist(map(country_map$geometry,1)),
           long = unlist(map(country_map$geometry,2)))

separated_coord

ggplot(country_centroids) +
  geom_sf(data = EEZ_map, fill = "skyblue")+
  geom_sf(colour = "red") 

country_coords <- do.call(rbind, st_geometry(country_map)) %>% 
    as_tibble() %>% setNames(c("lon","lat"))

ggplot(country_centroids) +
  geom_sf(data = country_map, fill = "skyblue")+
  geom_sf(colour = "red")+
  geom_path(aes(long, lat, alpha = 0.5, color = "black"))

geom_path(data = EEZ_map, 
            aes(long, lat, group = group), alpha = 0.5, color = "#fa6900")
## For next week
#File with all country and their EEZ
#Also number of hours, vessels, and hwhrs in Each EEZ
#try and automate script so that it can be re-run with different levels of effort
#mapping- try and do similar thing- # of countries cut off

```

