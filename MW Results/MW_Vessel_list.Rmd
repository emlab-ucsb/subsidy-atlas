---
title: "MW Initial Data Exploration - Vessel Data"
author: "Matthew Warham"
date: "4/20/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

#load data


### Read in csv for PC
library(readr)
vessel_list <- read_csv("H:/GitHub/subsidy-atlas/results/distant-water-vessels/distant_water_vessel_list_2018.csv")

### Read in csv for MAC
library(readr)

#vessel_list <- read_csv("~/Documents/GitHub/subsidy-atlas/subsidy-atlas/MW Results/distant_water_vessel_list_2018.csv")

#View(vessel_list)


library(tidyverse)
library(tmap)
library(sf)
#install.packages("spatstat")
library(spatstat)
library(maptools)
library(sp)
library(raster)
# library(rgdal)
#install.packages("gstat")
library(gstat)
library(tidyverse)
library(dplyr)
library(ggplot2)

#unique(vessel_list$flag)

vessel_tidy_raw<- vessel_list %>% ##Removed vessels fishing in their own EEZ's
  dplyr::select(year, ssvid, flag, eez_iso3, vessel_class, length_m, length_class, tonnage_gt, engine_power_kw, fishing_hours_year_tot, fishing_hours_year_eez_fao) %>% 
  mutate(kwhr = engine_power_kw * fishing_hours_year_tot) %>% 
  mutate(kwhr_in_eez = engine_power_kw * fishing_hours_year_eez_fao)
  

vessel_tidy <- vessel_tidy_raw %>% 
  group_by(flag, eez_iso3) %>% 
  filter(flag != eez_iso3)
  


write_csv(vessel_tidy, "vessel_tidy_onlydistantfleet.csv")
  

vessel_tidy_topflags <- vessel_list %>% 
  dplyr::select(ssvid, flag, vessel_class, fishing_hours_year_tot) %>% 
  filter(flag == "CHN" | flag == "TWN" | flag == "JPN" | flag == "KOR" | flag == "IDN") 



#unique(Vessel_tidy_topflags$flag)
#unique(Vessel_tidy_topflags$ssvid)
  

#view(Vessel_tidy_topflags)


```

```{r China}

CHN <- vessel_tidy %>% 
  filter(flag == "CHN") 

length(unique(CHN$ssvid)) #6255 unique vessels

unique(CHN$vessel_class)

#View(CHN)

## Number of EEZ's that China fished in in 2018 (top 20)
CHN_eez <- vessel_tidy %>% 
  filter(flag == "CHN") %>% 
  group_by(flag, eez_iso3) %>% 
  summarize(effort_per_eez = sum(fishing_hours_year_eez_fao, na.rm = TRUE)) #%>% 
  #top_n(20)

#View(CHN_eez)

```
```{r Taiwan}

TWN <- vessel_tidy %>% 
  filter(flag == "TWN") 

length(unique(TWN$ssvid)) #6255 unique vessels

unique(TWN$vessel_class)





```




```{r Number of unique vessels per country tally}

## Number of unique vessels per country tally, each tally value is another EEZ that vessel fished in
vessel_EEZtally <- vessel_tidy %>% 
  dplyr::select(ssvid, flag) %>% 
  group_by(flag,ssvid) %>% 
  tally(sort = TRUE) 
  


#View(vessel_EEZtally)

write_csv(vessel_EEZtally, "MW_EEZtally.csv")

```

```{r Number of uniqie vessels per country}

## Number of unique vessels per country

vessel_numbersummary <- vessel_tidy %>% 
  dplyr::select(ssvid, flag) %>% 
  group_by(flag) %>%
  summarize(total_vessels = n_distinct(ssvid)) %>% 
  arrange(desc(total_vessels))  

vessel_numbersummary_raw <- vessel_tidy_raw %>% 
  dplyr::select(ssvid, flag) %>% 
  group_by(flag) %>%
  summarize(total_vessels = n_distinct(ssvid)) %>% 
  arrange(desc(total_vessels)) 
  
  
#View(vessel_numbersummary)

write_csv(vessel_numbersummary, "MW_vesselnumber_total.csv")

```

```{r Total effort per country}

## Total effort by each country

vessel_effortsummary <- vessel_tidy %>% 
  group_by(flag) %>% 
  summarize(total_effort = sum(fishing_hours_year_tot, na.rm = TRUE)) %>% 
  arrange(desc(total_effort))
  #sort(total_effort, decreasing= TRUE)
    

#View(vessel_effortsummary)

write_csv(vessel_effortsummary, "MW_effort_total.csv")

```

```{r Effort by each country in each EEZ they fished in}

## Effort by each country in each EEZ they have fished in

vessel_eez <- vessel_tidy %>% 
  group_by(flag, eez_iso3) %>% 
  summarize(effort_per_eez = sum(fishing_hours_year_eez_fao, na.rm = TRUE)) 
  

#View(vessel_eez)
write_csv(vessel_eez, "MW_effort_eez.csv")


length(unique(vessel_eez$eez_iso3))

```


```{r Killowatt hours per country}


kwhr_percountry <- vessel_tidy %>% 
  group_by(flag) %>% 
  #mutate(total_effort = sum(fishing_hours_year_tot)) 
  summarize(total_kwhr = sum(kwhr, na.rm = TRUE)) %>% 
  mutate(pct_effort = (total_kwhr/ sum(total_kwhr)), pct_effort = round(pct_effort,4)) %>% 
  arrange(desc(total_kwhr))
  #sort(total_effort, decreasing= TRUE)

kwhr_percountry_raw <- vessel_tidy_raw %>% 
  group_by(flag) %>% 
  #mutate(total_effort = sum(fishing_hours_year_tot)) 
  summarize(total_kwhr = sum(kwhr, na.rm = TRUE)) %>% 
  mutate(pct_effort = (total_kwhr/ sum(total_kwhr)), pct_effort = round(pct_effort,4)) %>% 
  arrange(desc(total_kwhr))
  #sort(total_effort, decreasing= TRUE)

#View(kwhr_percountry)

write_csv(kwhr_percountry, "kwhr_percountry.csv")

```




```{r Sort by gear type}

gear_type <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, vessel_class, length_m, length_class) %>% 
  group_by(flag,vessel_class) %>% 
  summarize(number_vesselclass = n_distinct(ssvid))  #, d = toString((unique(ssvid)))) Each vessel in in the class


#View(gear_type)

write_csv(gear_type, "gear_type_percountry.csv")

unique(gear_type$vessel_class)

gear_table <- table(gear_type$vessel_class, gear_type$number_vesselclass)

```

```{r Average Vessel Length per country}

vessel_length <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, length_m) %>% 
  group_by(flag) %>% 
  summarize(average_length = mean(length_m, na.rm = TRUE))

vessel_length_raw <- vessel_tidy_raw %>% 
  dplyr::select(ssvid, flag, length_m) %>% 
  group_by(flag) %>% 
  summarize(average_length = mean(length_m, na.rm = TRUE))

#View(vessel_length)

write_csv(vessel_length, "average_vessel_length.csv")

```


```{r Average vessel tonnage per country}

vessel_tonnage <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, tonnage_gt) %>% 
  group_by(flag) %>% 
  summarize(average_tonnage = mean(tonnage_gt, na.rm = TRUE))

vessel_tonnage_raw <- vessel_tidy_raw %>% 
  dplyr::select(ssvid, flag, tonnage_gt) %>% 
  group_by(flag) %>% 
  summarize(average_tonnage = mean(tonnage_gt, na.rm = TRUE))

#View(vessel_tonnage)

write_csv(vessel_tonnage, "average_vessel_tonnage.csv")

```


```{r Final results: #vessels, kwrh, average length, and average tonnage per country}

## Combining number of vessels and total effort

final_results_1 <- merge(vessel_numbersummary, kwhr_percountry, by = "flag") %>% 
  arrange(desc(total_kwhr))

final_results_2 <- merge(final_results_1, vessel_length, by = "flag") %>% 
  arrange(desc(total_kwhr))

final_results <- merge(final_results_2, vessel_tonnage, by = "flag") %>% 
  arrange(desc(total_kwhr))

## RAW data

final_results_1_raw <- merge(vessel_numbersummary_raw, kwhr_percountry_raw, by = "flag") %>% 
  arrange(desc(total_kwhr))

final_results_2_raw <- merge(final_results_1_raw, vessel_length_raw, by = "flag") %>% 
  arrange(desc(total_kwhr))

final_results_raw <- merge(final_results_2_raw, vessel_tonnage_raw, by = "flag") %>% 
  arrange(desc(total_kwhr))


#View(final_results_effort)

final_results_top25 <- final_results %>% 
  filter(flag != "CHN") %>% 
  top_n(25)

#view(final_results_top25)

#ggplot(final_results_top25, aes(x = total_vessels, y = total_kwhr)) +
       #geom_point() +
        #geom_text(aes(label = flag, hjust=0, vjust=0))
      

       


write_csv(final_results, "final_results.csv")
write_csv(final_results_raw, "final_results_raw.csv")

```

```{r Who is fishing in EEZ's}

EEZ <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, fishing_hours_year_eez_fao, eez_iso3) %>% 
  group_by(eez_iso3)  %>% 
  summarize(number_countries_in_EEZ = n_distinct(flag), d = toString((unique(flag))))

#View(EEZ)

KIR <- vessel_tidy %>% 
  filter(eez_iso3 == "KIR")

length(unique(KIR$ssvid))
sum(KIR$fishing_hours_year_eez_fao)
mean(KIR$fishing_hours_year_eez_fao)
sum(KIR$kwhr_in_eez)
mean(KIR$kwhr_in_eez)

#View(KIR)

NAM <- vessel_tidy %>% 
  filter(eez_iso3 == "NAM")

length(unique(NAM$ssvid))
sum(NAM$fishing_hours_year_eez_fao)
mean(NAM$fishing_hours_year_eez_fao)
sum(NAM$kwhr_in_eez)
mean(NAM$kwhr_in_eez)

#View(NAM)

NZL <- vessel_tidy %>% 
  filter(eez_iso3 == "NZL")

length(unique(NZL$ssvid))
sum(NZL$fishing_hours_year_eez_fao)
mean(NZL$fishing_hours_year_eez_fao)
sum(NZL$kwhr_in_eez)
mean(NZL$kwhr_in_eez)


#View(NZL)

KOR <- vessel_tidy %>% 
  filter(eez_iso3 == "KOR")

length(unique(KOR$ssvid))
sum(KOR$fishing_hours_year_eez_fao)
mean(KOR$fishing_hours_year_eez_fao)
sum(KOR$kwhr_in_eez)
mean(KOR$kwhr_in_eez)

CHN <- vessel_tidy %>% 
  filter(eez_iso3 == "CHN")

length(unique(CHN$ssvid))
sum(CHN$fishing_hours_year_eez_fao)
mean(CHN$fishing_hours_year_eez_fao)
sum(CHN$kwhr_in_eez)
mean(CHN$kwhr_in_eez)

write_csv(KIR,"KIR.csv")
write_csv(NAM,"NAM.csv")
write_csv(NZL, "NZL.csv")
write_csv(KOR, "KOR.csv")
write_csv(CHN, "CHN.csv")
write_csv(EEZ,"EEZ.csv")


test_eezs <- read_csv("~/GitHub/subsidy-atlas/MW Results/test_eezs.csv")
View(test_eezs)



```

```{r Taiwan}

TWN <- vessel_tidy %>% 
  filter(flag == "TWN") 

length(unique(TWN$ssvid)) #6255 unique vessels

unique(TWN$vessel_class)

View(TWN)

write_csv(TWN, "TWN.csv")

```


```{r mapping}

##EEZ boundaries

#install.packages("mregions")
#library(mregions)
#install.packages("rmapshaper")
#library(rmapshaper)



library(leaflet)
#leaflet() %>%
 # addTiles() %>%
  #addPolygons(data = shp)

#EEZ <- st_read("~/Documents/GitHub/subsidy-atlas/subsidy-atlas/EEZ/eez_v10.shp") %>% 
  #st_transform(crs = 4326) %>% 
  #st_simplify(dTolerance = )

#plot(EEZ)

##Maps

```

