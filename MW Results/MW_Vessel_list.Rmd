---
title: "MW Initial Data Exploration - Vessel Data"
author: "Matthew Warham"
date: "4/20/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

min_hours_fished_cutoff <- 50
number_of_top_countries <- 10
```

```{r}
### Packages
library(readr)
library(tidyverse)
library(tmap)
library(sf)
library(spatstat)
library(maptools)
library(sp)
library(raster)
library(gstat)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(here)
library(dplyr)
library(knitr)
library(DT)
library(xtable)
library(tidyr)
library(formattable)
library(data.table)
library(gridExtra)
library(kableExtra)


# Read in vessel list
#vessel_list <- read_csv("H:/GitHub/subsidy-atlas/results/distant-water-vessels/distant_water_vessel_list_2018.csv")

### Read in csv for MAC
vessel_list <- read_csv(here::here("MW Results", "distant_water_vessel_list_2018.csv"))

#vessel_list <- read_csv("~/Documents/GitHub/subsidy-atlas/subsidy-atlas/MW Results/distant_water_vessel_list_2018.csv")

# Tidy data, filter out vessels fishing in their own EEZs and High Seas

vessel_tidy<- vessel_list %>% ##Removed vessels fishing in their own EEZ's and highseas
  dplyr::select(year, ssvid, flag, eez_iso3, vessel_class, length_m, length_class, tonnage_gt, engine_power_kw, fishing_hours_year_tot, fishing_hours_year_eez_fao) %>%
  group_by(flag, eez_iso3) %>% 
  filter(flag != eez_iso3) %>% 
  filter(eez_iso3 != "High Seas") %>% 
  #filter(fishing_hours_year_eez_fao >= min_hours_fished_cutoff) %>% 
  mutate(kwhr = engine_power_kw * fishing_hours_year_tot) %>% 
  mutate(kwhr_in_eez = engine_power_kw * fishing_hours_year_eez_fao)


length(unique(vessel_tidy$flag))
  
write_csv(vessel_tidy, here::here("MW Results", "vessel_tidy.csv"))
  

# 
vessel_tidy_topflags <- vessel_list %>% 
  dplyr::select(ssvid, flag, vessel_class, fishing_hours_year_tot) %>% 
  filter(flag == "CHN" | flag == "TWN" | flag == "JPN" | flag == "KOR" | flag == "IDN") 



#unique(Vessel_tidy_topflags$flag)
#unique(Vessel_tidy_topflags$ssvid)
  

#view(Vessel_tidy_topflags)


```




```{r Top Tables}

#1: Top flags: # vessels

flag_vessel_number <- vessel_tidy %>% 
  dplyr::select(ssvid, flag) %>% 
  group_by(flag) %>%
  summarize(total_vessels = n_distinct(ssvid)) %>% 
  arrange(desc(total_vessels))  


write_csv(flag_vessel_number, here::here("MW Results", "Final", "flag_vessel_number.csv"))

flag_vessel_number_table <- flag_vessel_number %>%
  top_n(number_of_top_countries)
  
  
kable(flag_vessel_number_table)


png(filename = "flag_vessel_number_table.png", width=600,height=600,bg = "white")
grid.table(flag_vessel_number_table)
dev.off()

#2: Top flags: total hours

flag_totaleffort <- vessel_tidy %>% 
  group_by(flag) %>% 
  summarize(total_effort = sum(fishing_hours_year_tot, na.rm = TRUE)) %>% 
  arrange(desc(total_effort))
  

write_csv(flag_totaleffort, here::here("MW Results", "Final", "flag_totaleffort.csv"))

flag_totaleffort_table <- flag_totaleffort %>%
  top_n(number_of_top_countries)
  
  
kable(flag_totaleffort_table)


png(filename = "flag_totaleffort_table.png", width=600,height=600,bg = "white")
grid.table(flag_totaleffort_table)
dev.off()

#3: Top flags: kwhr

flag_totalkwhr <- vessel_tidy %>% 
  group_by(flag) %>% 
  #mutate(total_effort = sum(fishing_hours_year_tot)) %>% 
  summarize(total_kwhr = sum(kwhr, na.rm = TRUE)) %>% 
  mutate(pct_effort = (total_kwhr/ sum(total_kwhr)), pct_effort = round(pct_effort,4)) %>% 
  arrange(desc(total_kwhr))
  #sort(total_effort, decreasing= TRUE)

write_csv(flag_totalkwhr, here::here("MW Results", "Final", "flag_totalkwhr.csv"))

flag_totalkwhr_table <- flag_totalkwhr %>%
  top_n(number_of_top_countries)
  
  
kable(flag_totalkwhr_table)

png(filename = "flag_totalkwhr_table.png", width=600,height=600,bg = "white")
grid.table(flag_totalkwhr_table)
dev.off()

#4 Top EEZ: # vessels

EEZ_vessel_number <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, fishing_hours_year_eez_fao, eez_iso3) %>% 
  group_by(eez_iso3)  %>% 
  summarize(number_vessels_in_EEZ = n_distinct(ssvid)) %>% 
  arrange(desc(number_vessels_in_EEZ))

write_csv(EEZ_vessel_number, here::here("MW Results", "Final", "EEZ_vessel_number.csv"))

EEZ_vessel_number_table <- EEZ_vessel_number %>%
  top_n(number_of_top_countries)
  
  
kable(EEZ_vessel_number_table)

png(filename = "EEZ_vessel_number_table.png", width=600,height=600,bg = "white")
grid.table(EEZ_vessel_number_table)
dev.off()

#5 Top EEZ: total hours

EEZ_totaleffort <- vessel_tidy %>% 
  group_by(eez_iso3) %>% 
  summarize(total_effort = sum(fishing_hours_year_tot, na.rm = TRUE)) %>% 
  arrange(desc(total_effort))
    

write_csv(EEZ_totaleffort, here::here("MW Results", "Final", "EEZ_totaleffort.csv"))

EEZ_totaleffort_table <- EEZ_totaleffort %>%
  top_n(number_of_top_countries)
  
  
kable(EEZ_totaleffort_table)

png(filename = "EEZ_totaleffort_table.png", width=600,height=600,bg = "white")
grid.table(EEZ_totaleffort_table)
dev.off()

#6 Top EEZ: kwhr

EEZ_totalkwhr <- vessel_tidy %>% 
  group_by(eez_iso3) %>% 
  summarize(total_kwhr = sum(kwhr, na.rm = TRUE)) %>% 
  mutate(pct_effort = (total_kwhr/ sum(total_kwhr)), pct_effort = round(pct_effort,4)) %>% 
  arrange(desc(total_kwhr))
  
write_csv(EEZ_totalkwhr, here::here("MW Results", "Final", "EEZ_totalkwhr.csv"))

EEZ_totalkwhr_table <- EEZ_totalkwhr %>%
  top_n(number_of_top_countries)
  
  
kable(EEZ_totalkwhr_table)

png(filename = "EEZ_totalkwhr_table.png", width=600,height=600,bg = "white")
grid.table(EEZ_totalkwhr_table)
dev.off()



```


```{r kat Tables}

#table <- flag_vessel_number_table %>%
 #mutate(rank = top_n) %>%
  #filter(rank >= number_of_top_countries)
 #
list_of_countries <- flag_vessel_number_table$flag
# 
for(i in 1:length(list_of_countries)){
  
   country_dat <- flag_vessel_number_table %>%
    filter(flag == list_of_countries[1])
  
 }

for (i in 1:list_of_countries) {
    if (surveys_adjusted$year[i] == 1984) {
      print(surveys_adjusted$weight[i]*1.1)
    } 
}

```

```{r Who is fishing in EEZ's}

EEZ <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, fishing_hours_year_eez_fao, eez_iso3) %>% 
  group_by(eez_iso3)  %>% 
  summarize(number_countries_in_EEZ = n_distinct(flag), d = toString((unique(flag))))

EEZ_vessels <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, fishing_hours_year_eez_fao, eez_iso3) %>% 
  group_by(eez_iso3)  %>% 
  summarize(number_vessels_in_EEZ = n_distinct(ssvid), d = toString((unique(ssvid))))

#View(EEZ)

# Tidy eez connection map
EEZ_tidy <- EEZ %>%
  mutate(eez_fished = strsplit(d, ", ")) %>%
        unnest(eez_fished) %>%
        dplyr::select(eez_iso3, number_countries_in_EEZ, eez_fished) %>% 
  arrange(desc(number_countries_in_EEZ))
  

write_csv(EEZ_tidy, here::here("MW Results", "Final", "EEZ_tidy.csv"))

EEZ_vesselnumber_tidy <- EEZ_vessels %>%
  mutate(number_vessels = strsplit(d, ", ")) %>%
        unnest(number_vessels) %>%
        dplyr::select(eez_iso3, number_vessels_in_EEZ) #%>% 
  #arrange(desc)

write_csv(EEZ_vesselnumber_tidy, here::here("MW Results","Final", "EEZ_vesselnumber_tidy.csv"))

# Ranked Tables

EEZ_ranked <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, fishing_hours_year_eez_fao, eez_iso3) %>% 
  group_by(eez_iso3)  %>% 
  summarize(number_countries_in_EEZ = n_distinct(flag)) %>% 
  arrange(desc(number_countries_in_EEZ))


  

```

```{r Number of EEZ each vessel has fished in}

## Number of unique vessels per country tally, each tally value is another EEZ that vessel fished in
vessel_EEZtally <- vessel_tidy %>% 
  dplyr::select(ssvid, flag) %>% 
  group_by(flag,ssvid) %>% 
  tally(sort = TRUE) 
  


#View(vessel_EEZtally)

#write_csv(vessel_EEZtally, "MW_EEZtally.csv")

```




```{r Effort by each country in each EEZ they fished in}

## Effort by each country in each EEZ they have fished in

vessel_eez <- vessel_tidy %>% 
  group_by(flag, eez_iso3) %>% 
  summarize(effort_per_eez = sum(fishing_hours_year_eez_fao, na.rm = TRUE)) 
  

#View(vessel_eez)
#write_csv(vessel_eez, "MW_effort_eez.csv")


length(unique(vessel_eez$eez_iso3))

```




```{r Sort by gear type}

gear_type <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, vessel_class, length_m, length_class) %>% 
  group_by(flag,vessel_class) %>% 
  summarize(number_vesselclass = n_distinct(ssvid))  #, d = toString((unique(ssvid)))) Each vessel in in the class


#View(gear_type)

#write_csv(gear_type, "gear_type_percountry.csv")

unique(gear_type$vessel_class)

gear_table <- table(gear_type$vessel_class, gear_type$number_vesselclass)

```

```{r Average Vessel Length per country}

vessel_length <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, length_m) %>% 
  group_by(flag) %>% 
  summarize(average_length = mean(length_m, na.rm = TRUE))


#View(vessel_length)

#write_csv(vessel_length, "average_vessel_length.csv")

```


```{r Average vessel tonnage per country}

vessel_tonnage <- vessel_tidy %>% 
  dplyr::select(ssvid, flag, tonnage_gt) %>% 
  group_by(flag) %>% 
  summarize(average_tonnage = mean(tonnage_gt, na.rm = TRUE))

#View(vessel_tonnage)

#write_csv(vessel_tonnage, "average_vessel_tonnage.csv")

```


```{r Final results: #vessels, kwrh, average length, and average tonnage per country}

## Combining number of vessels and total effort

final_results_1 <- merge(vessel_numbersummary, kwhr_percountry, by = "flag") %>% 
  arrange(desc(total_kwhr))

final_results_2 <- merge(final_results_1, vessel_length, by = "flag") %>% 
  arrange(desc(total_kwhr))

final_results <- merge(final_results_2, vessel_tonnage, by = "flag") %>% 
  arrange(desc(total_kwhr))

## Top 25 without china

final_results_top25 <- final_results %>% 
  filter(flag != "CHN") %>% 
  top_n(25)


#write_csv(final_results, "final_results.csv")


```


```{r mapping}

##EEZ boundaries



#install.packages("mregions")
#library(mregions)
#install.packages("rmapshaper")
#library(rmapshaper)

library(tidyverse)
library(sf)
library(tmap)
library(leaflet)
library(ggrepel)
#install.packages("ggspatial")
library(ggspatial)
library(RColorBrewer)
library(raster)

library(leaflet)
#leaflet() %>%
 # addTiles() %>%
  #addPolygons(data = shp)


##Map for mac
EEZ_map <- read_sf(dsn = here::here("data", "shapefiles", "eez_v10_fao_combined_simple"), layer = "eez_v10_fao_combined_simple") %>% 
  st_transform(crs = 4326)

world_map <- read_sf(dsn = here::here("data", "shapefiles", "world_happy_180"), layer = "world_happy_180") %>% 
  st_transform(crs = 4326)




## Map for PC
#EEZ_map <- read_sf("H:/GitHub/subsidy-atlas/eez_v10_fao_combined_simple.shp") %>% 
  #st_transform(crs = 4326) #%>% 
  #st_simplify(dTolerance = )

EEZ_map


library(maps)


## Change Global center of map to pacific
library(raster)
library(maptools)
data(EEZ_map)
r <- rasterize(EEZ_map, raster())

#x1 <- crop(r, extent(-180, 0, -90, 90))
#x2 <- crop(r, extent(0, 180, -90, 90))   
#extent(x1) <- c(180, 360, -90, 90)
#EEZ_pacific <- merge(x1, x2)

#EEZ_shp <- as.data.frame(EEZ_pacific)


#st_write(EEZ_shp, "EEZ_pacific.shp")

#plot(EEZ_pacific)

#View(EEZ_pacific)

#eez_geom <- st_geometry(EEZ_pacific)

#View (eez_geom)

#eez_geom

#eez_geom[[19]]


#options(sf_max.plot=25)
#plot(EEZ)

#par(mar = c(0,0,1,0))
#plot(EEZ[25], reset = FALSE)
#plot(EEZ[25,25], col = 'grey', add = TRUE)

#plot(EEZ)

# China as a test plot
china <- EEZ_tidy %>%
  dplyr::filter(eez_iso3 == "CHN")

eez_filtered_CHN <- EEZ_map %>%
  dplyr::filter(ez_hs_c %in% china$eez_fished)

plot_map_CHN <- ggplot()+
  geom_sf(data = EEZ_map, fill = "white", alpha = 0.5)+
  geom_sf(data = world_map, fill = "white")+
  geom_sf(data = world_map %>% dplyr::filter(iso3 == "CHN"), fill = "red") +
  geom_sf(data = eez_filtered_CHN, fill = "blue", alpha = 0.5) +
  geom_path(data = EEZ_map, 
            aes(long, lat, group = group), alpha = 0.5, color = "#fa6900") 

plot_map_CHN


### USA test


USA <- EEZ_tidy %>%
  dplyr::filter(eez_iso3 == "USA")

eez_filtered_USA <- EEZ_map %>%
  dplyr::filter(ez_hs_c %in% USA$eez_fished)

plot_map_USA <- ggplot()+
  geom_sf(data = EEZ_map, fill = "white", alpha = 0.5)+
  geom_sf(data = world_map, fill = "white")+
  geom_sf(data = world_map %>% dplyr::filter(iso3 == "USA"), fill = "red") +
  geom_sf(data = eez_filtered_USA, fill = "blue", alpha = 0.5)

plot_map_USA



```

```{r}

countries_1 <- c('CHN','USA','TWN')

dat_list = lapply(countries_1, function(i) {
  st_as_sf(getData("EEZ_map", flag = i, level = 0))
})

m = leaflet() %>% addTiles()

for (i in dat_list) {
  m = mapview::addFeatures(map = m, 
                           data = i, 
                           weight = 3, 
                           fillColor = 'purple', 
                           color = 'purple')
}

m

```



```{r map script from kat}

(network_with_color_gradient <- ggplot() +
   geom_polygon(data = world_df, aes(long, lat, group = group), 
               fill = "grey8", color = "grey8", size = 0.1) +
   geom_path(data = all_routes_df, 
            aes(long, lat, group = group, col = normalized_distance , alpha = fishing_hours),  show.legend = NA) +
   geom_point(data = network_data %>% 
                group_by(end_lon,end_lat) %>% 
                summarize(fishing_days = sum(fishing_days)), 
              aes(end_lon, end_lat, size = fishing_days), col = "orange", shape = 21, stroke = 1.5)+
   scale_size_continuous(range = c(0.5,10)) +
   scale_alpha_continuous(range = c(0.3,1))+
   theme_minimal()+
   theme(panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_rect(fill = "white",
                                 colour = "white"),
         axis.title = element_blank(),
         axis.text = element_blank(),
         axis.ticks = element_blank()) +
   guides(colour =  FALSE, alpha = F, size = F) +
   scale_color_gradient2(low = "#0571b0", mid = "#0571b0", midpoint = .5, high = "#b2182b"))

```

