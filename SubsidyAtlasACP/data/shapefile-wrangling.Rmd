---
title: "Shapefile wrangling for the ACP Atlas of Distant Water Fishing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sf)
library(here)
library(rmapshaper)
library(mapview)
library(tidyverse)
library(countrycode)

```

## Introduction

This script details the analysis/wrangling done to create the shapefiles used in the ACP tool. 

## Data

The following shapefiles were downloaded from the sources listed below and used in this analysis. 

From Marineregions.org: 
- Maritime Boundaries: World EEZs (v10, 2018-02-21)
- Marine and land zones: the union of world country boundaries and EEZ's (v2, 2014)

> Flanders Marine Institute (2018). Maritime Boundaries Geodatabase: Maritime Boundaries and Exclusive Economic Zones (200NM), version 10. Available online at http://www.marineregions.org/ https://doi.org/10.14284/312

From naturalearthdata.com: 
- 10m Cultural Vectors: Admin 0 - Details: Map Subunits (version 4.1.0)

*/ ------------------- /*
*/ World EEZ Shapefile /*
*/ ------------------- /*

## Maritime Boundaries: World EEZs (v10, 2018-02-21)

### Preliminary edits

Prior to making the edits detailed below, some edits were done to this shapefile before importing it into R for performance reasons. 

First, we uploaded `eez_v10.shp` to mapshaper.org, and simplified it using the Visvalingam / weighted area method (shape removal prevented). 0.5% of original points were kept, and 2,235 line intersections were repaired. We then exported the resulting file out of mapshaper.org as a shapefile. A copy of this intermediate file can be found in `./data/shapefiles_edit/World_EEZ_v10_20180221_LR/eez_v10.shp`. 

We then imported the modified `eez_v10.shp` into QGIS (version 3.4.7-Madeira) and duplicated the layer. After reprojecting one of the two layers so the total extent of the map was from -360 to 360 degrees, we dissolved all polygons by all attributes. Some manual eliminations had to be made so that polygons with the same attributes did not have small slivers and/or dividing lines between them. We then exported this file out of QGIS as a shapefile. This file can be found in 
`./data/shapefiles_edit/World_EEZ_v10_20180221_LR_-360_360/eez_v10.shp`. 

The final shapefile was outputted with the following CRS: WGS 84 (EPSG:4326).

### Edits

The edits done to this shapefile primarily relate to disputed areas and joint management areas. For the purposes of data analysis and visualization, we wanted to easily be able to attribute these areas to each/all of the states involved in the dispute or responsible for management of the area. 

In order to do this, we duplicate the polygons cooresponding to disputed areas and joint management areas and assign them to all states (2-3 distinct states) involved. 

```{r}
eez_shp <- read_sf(dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "World_EEZ_v10_20180221_LR_-360_360"), layer = "eez_v10") %>%
  setNames(tolower(names(.))) %>%
  st_transform(crs = 4326)

#mapview::mapview(eez_shp)
```

```{r}
eez_disputed <- eez_shp %>%
  dplyr::filter(!is.na(iso_ter2)) %>%
  dplyr::filter(pol_type == "Overlapping claim") %>%
  mutate(iso_ter_all = case_when(!is.na(iso_ter3) ~ paste(iso_ter1, iso_ter2, iso_ter3, sep = ","),
                                 !is.na(iso_ter2) ~ paste(iso_ter1, iso_ter2, sep = ","),
                                 TRUE ~ iso_ter1))
                                 
eez_disputed_expand <- eez_disputed %>%
  separate_rows(iso_ter_all, sep = ",") %>%
  mutate(matching_entry = case_when(iso_ter1 == iso_ter_all ~ "1",
                                    iso_ter2 == iso_ter_all ~ "2",
                                    iso_ter3 == iso_ter_all ~ "3")) %>%
  mutate(mrgid_ter = case_when(matching_entry == "1" ~ mrgid_ter1,
                             matching_entry == "2" ~ mrgid_ter2,
                             matching_entry == "3" ~ mrgid_ter3),
         iso_ter = case_when(matching_entry == "1" ~ iso_ter1,
                             matching_entry == "2" ~ iso_ter2,
                             matching_entry == "3" ~ iso_ter3),
         territory = case_when(matching_entry == "1" ~ territory1,
                             matching_entry == "2" ~ territory2,
                             matching_entry == "3" ~ territory3),
         mrgid_sov = case_when(matching_entry == "1" ~ mrgid_sov1,
                             matching_entry == "2" ~ mrgid_sov2,
                             matching_entry == "3" ~ mrgid_sov3),
         iso_sov = case_when(matching_entry == "1" ~ iso_sov1,
                             matching_entry == "2" ~ iso_sov2,
                             matching_entry == "3" ~ iso_sov3),
         sovereign = case_when(matching_entry == "1" ~ sovereign1,
                             matching_entry == "2" ~ sovereign2,
                             matching_entry == "3" ~ sovereign3))

```

Starting with disputed areas (termed "overlapping claims" in this data set), we have `r nrow(eez_disputed)` regions. Of those, `r nrow(eez_disputed %>% dplyr::filter(!is.na(iso_ter3)))` involve three parties. 







## Introduction

This script details the analysis/wrangling done to create shapefiles for use in the ACP tool.

## EEZs 

We use Version 10 of the World Maritime Boundaries (World EEZs - 2018) from Marineregions.org, last downloaded on July 31, 2019. 

> Flanders Marine Institute (2018). Maritime Boundaries Geodatabase: Maritime Boundaries and Exclusive Economic Zones (200NM), version 10. Available online at http://www.marineregions.org/ https://doi.org/10.14284/312

Unfortunately, since both the Pacific and Western Africa are regions of interest, there isn't a standard shapefile in which all of the EEZs we need are in one piece. We therefore made our own ACP shapefile, by pulling from both the -180 to 180 degree and 0 to 360 degree representations of the World EEZ shapefiles. 


```{r}
# Load list of ACP states
acp_states <- read_csv(here::here("SubsidyAtlasACP", "data", "ACP_eez_codes.csv")) %>%
  mutate(territory_fixed = countrycode::countrycode(territory_iso3, "iso3c", "country.name"))

# Deal with join regime areas and overlapping claims
joint_180 <- c(21797) # Sao Tome and Principe/Nigeria
joint_360 <- c(21792) # Jamaica/Colombia

overlap_180 <- c(33176, # Kenya/Somalia
                 26582, # Sudan/Egypt
                 48945, # Madagascar/France
                 48946, # Mauritius/France
                 48944) # Comores/France
overlap_360 <- c(48948, # New Caledonia/Vanuatu
                 48982, # Puerto Rico/Dominican Republic
                 48971, # Columbia/Dominican Republic
                 33185, # Guyana/Trinidad and Tobago
                 48951) # Haiti/USA/Jamaica

keep_eezs_180 <- c(unique(acp_states$mrgid[acp_states$shp_to_use == 180]), joint_180, overlap_180)
keep_eezs_360 <- c(unique(acp_states$mrgid[acp_states$shp_to_use == 360]), joint_360, overlap_360)

# Load eez shapefile (-180 to 180 degrees) and filter
eez_180 <- st_read(dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_raw", "World_EEZ_v10_20180221"), layer = "eez_v10")

eez_180_simple <- eez_180 %>%
  setNames(tolower(names(.))) %>%
  dplyr::filter(mrgid %in% keep_eezs_180) %>%
  rmapshaper::ms_simplify()

# Load eez shapefile (0 to 360 degrees)
eez_360 <- st_read(dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "World_EEZ_v10_20180221_HR_0_360"), layer = "World_EEZ_v10_2018_0_360")
  
eez_360_simple <- eez_360 %>%
  setNames(tolower(names(.))) %>%
  dplyr::filter(mrgid %in% keep_eezs_360) %>%
  rmapshaper::ms_simplify() %>%
  dplyr::select(-cat)

# Combine and export
eez_combine <- eez_180_simple %>%
  rbind(eez_360_simple)

st_write(eez_combine, dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "World_EEZ_v10_custom_ACP"), layer = "World_EEZ_v10_custom_ACP", driver = "ESRI Shapefile", delete_layer = T)

```


## Regional blocks

We also wanted to use the merged land/EEZ boundary shapefile to show the extent of our ACP states by region. The raw shapefiles used to create these was sourced from Marineregions.org (Marine and land zones: the union of world country boundaries and EEZs, Version 2 - 2014). This shapefile was last downloaded on July 31, 2019. We manually changed the extent of this shapefile in QGIS to be from -30 to 330 degrees so all of our ACP EEZs are intact. 

There are a couple of problems with using this this shapefile that need to be corrected for: 
- The Gilbert Islands are assigned to the United States Minor Outlying Islands (instead of Kiribati)
- The Phoenix Islands are assigned to the United States Minor OUtlying Islands (instead of Kiribati) and are still connected to Howland and Baker. 

These corrections were made using Version 10 of the World Maritime Boundaries (World EEZs - 2018) from Marineregions.org.

```{r}
land_eez_shp <- st_read(dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "EEZ_land_union_v2_201410_-30_360_manualedits"), layer = "EEZ_land_union_v2_201410_-30_330_manualedits") %>%
  setNames(tolower(names(.)))

acp_land_eez_union <- land_eez_shp %>%
  right_join(acp_states, by = c("iso_3digit" = "territory_iso3")) %>%
      group_by(iso_3digit, region, region_specific) %>%
      summarize(geometry = st_union(geometry))

st_write(acp_land_eez_union, dsn = here::here("SubsidyAtlasACP", "data", "shapefiles_edit", "EEZ_land_union_v2_custom_ACP"), layer = "EEZ_land_union_v2_custom_ACP", driver = "ESRI Shapefile", delete_layer = T)

```